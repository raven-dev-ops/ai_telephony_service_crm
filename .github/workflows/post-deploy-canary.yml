name: Post-Deploy Voice Canary

on:
  workflow_dispatch:
  deployment_status:
    types: [success]

jobs:
  voice-canary:
    if: github.event_name == 'workflow_dispatch' || github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Run voice streaming canary (prod host)
        working-directory: backend
        env:
          PYTEST_ADDOPTS: "-q"
          TWILIO_STREAMING_ENABLED: "true"
          TWILIO_STREAM_BASE_URL: ${{ secrets.TWILIO_STREAM_BASE_URL }}
          NLU_INTENT_THRESHOLD: ${{ secrets.NLU_INTENT_THRESHOLD }}
        run: |
          pytest tests/test_twilio_streaming_canary.py
      - name: Notify Slack on failure
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\":rotating_light: Voice canary failed on ${GITHUB_REF} (${GITHUB_SHA}). Check logs.\"}" \
            "$SLACK_WEBHOOK_URL"
