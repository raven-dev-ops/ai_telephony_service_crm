<!doctype html>

<html lang="en">

  <head>

    <meta charset="utf-8" />

    <title>AI Telephony Dashboard</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link

      rel="stylesheet"

      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"

      integrity="sha256-sA+e2atSaNVD45Hxbp2FKs1rGgRkGzm4nFv9Z8M0A+E="

      crossorigin=""

    />

    <script

      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"

      integrity="sha256-o9N1j7kGStGk6Z6pU4bYdVQKjFVjJ7gE0l2l9h8b+3E="

      crossorigin=""

    ></script>

    <style>

      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap");

      :root {

        --nav-height: 72px;

        --bg: #f6f8fb;

        --card: #ffffff;

        --text: #0f172a;

        --muted: #64748b;

        --border: #e2e8f0;

        --accent: #2563eb;

      }

      * {

        margin: 0;

        padding: 0;

        box-sizing: border-box;

      }

      body {

        font-family: "Space Grotesk", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

        background: radial-gradient(circle at 10% 10%, rgba(37, 99, 235, 0.08), transparent 25%),

          radial-gradient(circle at 85% 15%, rgba(16, 185, 129, 0.08), transparent 22%),

          var(--bg);

        min-height: 100vh;

        color: var(--text);

        padding-bottom: 2rem;

        line-height: 1.5;

      }

      .header-bar {

        background: rgba(255, 255, 255, 0.9);

        backdrop-filter: blur(8px);

        border-bottom: 1px solid var(--border);

        padding: 1rem 2rem;

        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);

      }

      .header-content {

        max-width: 1400px;

        margin: 0 auto;

        display: flex;

        align-items: center;

        gap: 1.25rem;

        flex-wrap: wrap;

      }

      .logo-section {

        display: flex;

        align-items: center;

        gap: 1rem;

      }

      .logo {

        width: 44px;

        height: 44px;

        background: linear-gradient(135deg, #2563eb 0%, #22c55e 100%);

        border-radius: 12px;

        display: flex;

        align-items: center;

        justify-content: center;

        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18);

      }

      .logo svg {

        width: 26px;

        height: 26px;

        fill: white;

      }

      h1 {

        font-size: 1.4rem;

        font-weight: 700;

        color: var(--text);

      }

      .status-bar {

        display: flex;

        gap: 0.6rem;

        align-items: center;

        margin-left: auto;

        flex-wrap: wrap;

      }

      .status-badge {

        padding: 0.35rem 0.75rem;

        border-radius: 18px;

        font-size: 0.75rem;

        font-weight: 600;

        display: inline-flex;

        align-items: center;

        gap: 0.4rem;

        background: #eef2ff;

        color: #312e81;

        border: 1px solid #e0e7ff;

      }

      .status-badge.success {

        background: #ecfdf3;

        color: #166534;

        border-color: #bbf7d0;

      }

      .status-badge.error {

        background: #fef2f2;

        color: #b91c1c;

        border-color: #fecdd3;

      }

      .status-badge.muted {

        background: #f8fafc;

        color: #475569;

        border-color: #e2e8f0;

      }



      .data-strip {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));

        gap: 0.75rem;

        padding: 0.75rem;

        margin: 0.5rem 0 1.25rem;

        background: #ffffff;

        border: 1px solid #e2e8f0;

        border-radius: 14px;

        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);

      }



      .data-pill {

        display: flex;

        align-items: center;

        gap: 0.6rem;

        padding: 0.65rem 0.8rem;

        border-radius: 12px;

        background: #f8fafc;

        border: 1px solid #e2e8f0;

        transition: border-color 0.2s, box-shadow 0.2s;

      }



      .data-pill strong {

        display: block;

        font-size: 0.95rem;

        color: #0f172a;

      }



      .pill-note {

        font-size: 0.82rem;

        color: #64748b;

      }



      .pill-action {

        margin-left: auto;

        padding: 0.4rem 0.75rem;

        border-radius: 10px;

        border: 1px solid #e2e8f0;

        background: #fff;

        color: #2563eb;

        font-weight: 700;

        cursor: pointer;

      }



      .data-pill.success {

        border-color: #bbf7d0;

        background: #ecfdf3;

      }



      .data-pill.warn {

        border-color: #fcd34d;

        background: #fffbeb;

      }



      .data-pill.error {

        border-color: #fecdd3;

        background: #fef2f2;

      }



      .quick-actions {

        display: flex;

        gap: 0.6rem;

        flex-wrap: wrap;

        margin: 0.5rem 0 1rem;

      }



      .quick-actions button {

        display: inline-flex;

        align-items: center;

        gap: 0.45rem;

        border-radius: 12px;

        border: 1px solid #e2e8f0;

        background: #f8fafc;

        color: #0f172a;

        font-weight: 700;

        padding: 0.55rem 0.9rem;

      }



      .quick-actions button:hover {

        background: #eef2ff;

        border-color: #cbd5e1;

      }



      .filter-row {

        display: flex;

        gap: 0.6rem;

        flex-wrap: wrap;

        align-items: center;

        margin: 0.35rem 0 0.5rem;

      }



      .filter-row input {

        flex: 1 1 200px;

      }



      .filter-row select {

        min-width: 140px;

      }



      .filter-row .muted {
        margin-left: auto;
      }

      .summary-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #475569;
        margin: 0.2rem 0 0.6rem;
      }

      .pill-badge {

        display: inline-flex;

        align-items: center;

        gap: 0.35rem;

        padding: 0.2rem 0.6rem;

        border-radius: 999px;

        font-size: 0.8rem;

        font-weight: 700;

        background: #f1f5f9;

        color: #0f172a;

      }



      .pill-badge.voice { background: #eef2ff; color: #312e81; }

      .pill-badge.sms { background: #ecfeff; color: #0e7490; }

      .pill-badge.chat { background: #f5f3ff; color: #6b21a8; }

      .pill-badge.success { background: #ecfdf3; color: #166534; }

      .pill-badge.warn { background: #fffbeb; color: #92400e; }

      .pill-badge.error { background: #fef2f2; color: #b91c1c; }



      .status-dot {

        width: 8px;

        height: 8px;

        border-radius: 50%;

        background: currentColor;

        animation: pulse 2s infinite;

      }



      .user-chip {

        display: inline-flex;

        align-items: center;

        gap: 0.5rem;

        padding: 0.4rem 0.75rem;

        border-radius: 999px;

        background: #e2e8f0;

        color: #0f172a;

        font-weight: 600;

        font-size: 0.85rem;

        border: 1px solid rgba(0, 0, 0, 0.05);

      }



      .user-chip .user-dot {

        width: 10px;

        height: 10px;

        border-radius: 999px;

        background: #22c55e;

      }



      .user-chip.muted {

        background: #f1f5f9;

        color: #64748b;

      }



      .ghost-button {

        background: transparent;

        color: #1f2937;

        border: 1px solid #e2e8f0;

        padding: 0.45rem 0.9rem;

        border-radius: 10px;

      }



      .ghost-button:hover {

        background: #edf2f7;

        color: #111827;

      }

      

      @keyframes pulse {

        0%, 100% { opacity: 1; }

        50% { opacity: 0.5; }

      }

      

      .controls {

        display: flex;

        gap: 0.5rem;

      }



      .locale-select {

        padding: 0.45rem 0.75rem;

        border-radius: 10px;

        border: 1px solid #e2e8f0;

        background: #ffffff;

        color: #0f172a;

        font-weight: 600;

        min-width: 120px;

      }

      

      button {

        padding: 0.5rem 1rem;

        border-radius: 8px;

        border: none;

        background: #667eea;

        color: white;

        font-weight: 500;

        cursor: pointer;

        transition: all 0.2s;

        font-size: 0.875rem;

      }

      

      button:hover {

        background: #5568d3;

        transform: translateY(-1px);

        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);

      }

      

      button:disabled {

        opacity: 0.5;

        cursor: not-allowed;

        transform: none;

      }

      

      .container {

        max-width: 1400px;

        margin: 0 auto;

        padding: 1.5rem;

      }

      

      .dashboard-grid {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));

        gap: 1.25rem;

        margin-top: 1rem;

      }

      

      .card {

        background: white;

        border-radius: 16px;

        padding: 1.5rem;

        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);

        transition: all 0.3s;

        border: 1px solid rgba(0, 0, 0, 0.05);

        scroll-margin-top: 90px;

      }

      

      .card:hover {

        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);

        transform: translateY(-2px);

      }



      .card :is(button, input, textarea, select):focus-visible,

      .assistant-panel :is(button, input, textarea):focus-visible {

        outline: 2px solid #0ea5e9;

        outline-offset: 2px;

      }

      

      .card-header {

        display: flex;

        align-items: center;

        gap: 0.75rem;

        margin-bottom: 1rem;

        padding-bottom: 0.75rem;

        border-bottom: 2px solid #f7fafc;

      }

      

      .card-icon {

        width: 40px;

        height: 40px;

        border-radius: 10px;

        display: flex;

        align-items: center;

        justify-content: center;

        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

      }

      

      .card-icon svg {

        width: 20px;

        height: 20px;

        fill: white;

      }

      

      .card h2 {

        font-size: 1.125rem;

        font-weight: 600;

        color: #1a202c;

        flex: 1;

      }

      

      .metric-row {

        display: flex;

        justify-content: space-between;

        align-items: center;

        padding: 0.75rem 0;

        border-bottom: 1px solid #f7fafc;

      }

      

      .metric-row:last-child {

        border-bottom: none;

      }

      

      .metric-label {

        font-size: 0.875rem;

        color: #64748b;

        font-weight: 500;

      }

      

      .metric-value {

        font-size: 1.25rem;

        font-weight: 700;

        color: #1a202c;

      }

      

      .metric-value.large {

        font-size: 2rem;

      }

      

      .pill {

        display: inline-block;

        padding: 0.25rem 0.75rem;

        border-radius: 12px;

        font-size: 0.75rem;

        font-weight: 600;

        background: #e2e8f0;

        color: #475569;

        margin: 0.25rem;

      }

      

      .tag {

        display: inline-block;

        padding: 0.25rem 0.5rem;

        border-radius: 6px;

        font-size: 0.7rem;

        font-weight: 600;

        text-transform: uppercase;

      }

      

      .tag-emergency {

        background: #fee;

        color: #c00;

      }

      

      .tag-normal {

        background: #e3f2fd;

        color: #1565c0;

      }

      

      .empty-state {

        text-align: center;

        padding: 2rem;

        color: #94a3b8;

      }

      

      .empty-state svg {

        width: 64px;

        height: 64px;

        fill: #cbd5e1;

        margin-bottom: 1rem;

      }

      

      input[type="text"],

      input[type="password"],

      input[type="date"],

      select,

      textarea {

        padding: 0.5rem;

        border-radius: 8px;

        border: 1px solid #e2e8f0;

        font-family: inherit;

        font-size: 0.875rem;

        transition: all 0.2s;

      }

      

      input:focus,

      select:focus,

      textarea:focus {

        outline: none;

        border-color: #667eea;

        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);

      }



      .form-group {

        margin-bottom: 1rem;

      }



      .table-scroll {

        overflow-x: auto;

      }



      .card table {

        width: 100%;

        border-collapse: collapse;

      }



      .card table th,

      .card table td {

        text-align: left;

        padding: 0.5rem 0.25rem;

      }



      label {

        display: block;

        margin-bottom: 0.5rem;

      }



      label small {

        font-weight: 600;

        color: #475569;

      }

      

      .kpi-grid {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));

        gap: 1rem;

      }

      

      .kpi-card {

        text-align: center;

        padding: 1rem;

        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);

        border-radius: 12px;

      }

      

      .kpi-value {

        font-size: 1.75rem;

        font-weight: 700;

        color: #667eea;

        margin-bottom: 0.25rem;

      }

      

      .kpi-label {

        font-size: 0.75rem;

        color: #64748b;

        font-weight: 600;

      }



      .map-container {

        height: 320px;

        border-radius: 12px;

        overflow: hidden;

        border: 1px solid #e2e8f0;

      }

      

      .section-header {

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 0.75rem;

        margin: 1.25rem 0 0.5rem;

        color: #e2e8f0;

      }



      .section-title {

        font-size: 1.1rem;

        font-weight: 700;

        color: #f8fafc;

      }



      .section-eyebrow {

        font-size: 0.7rem;

        letter-spacing: 0.12em;

        text-transform: uppercase;

        color: #94a3b8;

      }



      .section-subtitle {

        font-size: 0.85rem;

        color: #cbd5e1;

      }



      .section-anchor {

        height: 1px;

        width: 100%;

        position: relative;

        top: -72px;

      }



      .integration-row {

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 0.75rem;

        padding: 0.6rem 0;

        border-bottom: 1px solid #f1f5f9;

      }



      .integration-row:last-child {

        border-bottom: none;

      }



      .integration-row .label {

        font-weight: 600;

        color: #0f172a;

      }



      .integration-row .status {

        display: inline-flex;

        align-items: center;

        gap: 0.35rem;

        padding: 0.2rem 0.6rem;

        border-radius: 999px;

        font-size: 0.8rem;

        font-weight: 600;

      }



      .integration-row.connected .status {

        background: #ecfdf3;

        color: #15803d;

      }



      .integration-row.disconnected .status {

        background: #fff7ed;

        color: #c2410c;

      }

      .integration-row.error .status {
        background: #fef2f2;
        color: #b91c1c;
      }



      .tips-list {

        list-style: none;

        display: grid;

        gap: 0.6rem;

        margin: 0.75rem 0 0;

        padding: 0;

      }



      .tips-list li {

        padding: 0.7rem 0.8rem;

        border-radius: 10px;

        background: #f8fafc;

        color: #1f2937;

        font-size: 0.9rem;

      }



      .mobile-nav {

        position: fixed;

        bottom: 0;

        left: 0;

        right: 0;

        height: var(--nav-height);

        background: rgba(15, 23, 42, 0.95);

        border-top: 1px solid rgba(255, 255, 255, 0.08);

        display: none;

        grid-template-columns: repeat(4, 1fr);

        z-index: 80;

        backdrop-filter: blur(12px);

      }



      .mobile-nav button {

        background: none;

        border: none;

        color: #cbd5e1;

        display: grid;

        place-items: center;

        gap: 0.25rem;

        font-size: 0.8rem;

        font-weight: 700;

        cursor: pointer;

      }



      .mobile-nav button .icon {

        width: 22px;

        height: 22px;

      }



      .mobile-nav button.active {

        color: #22c55e;

      }

      

      body.dark {

        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);

        color: #e2e8f0;

      }

      

      body.dark .header-bar {

        background: rgba(26, 32, 44, 0.95);

        border-bottom-color: rgba(255, 255, 255, 0.1);

      }

      

      body.dark .card {

        background: #2d3748;

        border-color: rgba(255, 255, 255, 0.1);

      }

      

      body.dark .card h2 {

        color: #e2e8f0;

      }

      

      body.dark .metric-label {

        color: #a0aec0;

      }

      

      body.dark .metric-value {

        color: #e2e8f0;

      }

      

      body.dark input,

      body.dark select,

      body.dark textarea {

        background: #1a202c;

        border-color: #4a5568;

        color: #e2e8f0;

      }

      

      .loading {

        display: flex;

        align-items: center;

        justify-content: center;

        padding: 2rem;

        color: #94a3b8;

      }

      

      .loading::after {

        content: "";

        width: 20px;

        height: 20px;

        border: 3px solid #e2e8f0;

        border-top-color: #667eea;

        border-radius: 50%;

        animation: spin 0.8s linear infinite;

        margin-left: 0.5rem;

      }

      

      @keyframes spin {

        to { transform: rotate(360deg); }

      }

      

      .feature-grid {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

        gap: 1rem;

        margin: 1rem 0;

      }

      

      .feature-item {

        display: flex;

        align-items: start;

        gap: 0.75rem;

        padding: 0.75rem;

        background: #f8fafc;

        border-radius: 8px;

      }

      

      body.dark .feature-item {

        background: #1a202c;

      }

      

      .feature-icon {

        width: 32px;

        height: 32px;

        border-radius: 8px;

        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        display: flex;

        align-items: center;

        justify-content: center;

        flex-shrink: 0;

      }

      

      .feature-icon svg {

        width: 16px;

        height: 16px;

        fill: white;

      }



      .calendar-grid {

        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));

        gap: 0.35rem;

      }



      .calendar-day {

        display: flex;

        flex-direction: column;

        align-items: center;

        justify-content: center;

        padding: 0.35rem 0.25rem;

        border-radius: 8px;

        border: none;

        background: #edf2f7;

        color: #1f2933;

        font-size: 0.7rem;

        cursor: pointer;

        transition: all 0.15s ease;

      }



      .calendar-day:hover {

        transform: translateY(-1px);

        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);

      }



      .calendar-day-date {

        font-weight: 600;

        margin-bottom: 0.05rem;

      }



      .calendar-day-total {

        font-size: 0.7rem;

        opacity: 0.8;

      }



      .calendar-day-emergency {

        background: #fee2e2;

        color: #991b1b;

      }



      .calendar-day-maintenance {

        background: #ecfdf5;

        color: #047857;

      }



      .calendar-day-routine {

        background: #e0f2fe;

        color: #0369a1;

      }



      .calendar-day-new-client {

        background: #eef2ff;

        color: #4338ca;

      }



      body.dark .calendar-day {

        background: #1f2937;

        color: #e5e7eb;

      }



      body.dark .calendar-day-emergency {

        background: rgba(248, 113, 113, 0.25);

        color: #fecaca;

      }



      body.dark .calendar-day-maintenance {

        background: rgba(16, 185, 129, 0.25);

        color: #a7f3d0;

      }



      body.dark .calendar-day-routine {

        background: rgba(59, 130, 246, 0.25);

        color: #bfdbfe;

      }



      body.dark .calendar-day-new-client {

        background: rgba(129, 140, 248, 0.25);

        color: #c7d2fe;

      }



      .calendar-legend {

        display: flex;

        flex-wrap: wrap;

        gap: 0.5rem;

        margin-top: 0.75rem;

        font-size: 0.75rem;

        color: #64748b;

      }



      .calendar-legend-item {

        display: flex;

        align-items: center;

        gap: 0.25rem;

      }



      .calendar-legend-swatch {

        width: 12px;

        height: 12px;

        border-radius: 4px;

      }



      .modal-backdrop {

        position: fixed;

        inset: 0;

        background: rgba(15, 23, 42, 0.6);

        display: none;

        align-items: center;

        justify-content: center;

        z-index: 50;

      }



      .modal {

        background: #ffffff;

        border-radius: 12px;

        padding: 1.5rem;

        max-width: 620px;

        width: 100%;

        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);

      }



      .modal-header {

        display: flex;

        align-items: center;

        justify-content: space-between;

        margin-bottom: 1rem;

      }



      .modal-title {

        font-size: 1rem;

        font-weight: 600;

        color: #111827;

      }



      .modal-body {

        max-height: 60vh;

        overflow-y: auto;

        font-size: 0.875rem;

        color: #374151;

      }



      .modal-footer {

        display: flex;

        justify-content: flex-end;

        gap: 0.5rem;

        margin-top: 1rem;

      }



      body.dark .modal {

        background: #1f2937;

        color: #e5e7eb;

      }



      body.dark .modal-title {

        color: #f9fafb;

      }



      body.dark .modal-body {

        color: #d1d5db;

      }



      .assistant-root {

        position: fixed;

        bottom: 1.5rem;

        right: 1.5rem;

        z-index: 60;

      }



      .assistant-toggle {

        display: inline-flex;

        align-items: center;

        gap: 0.4rem;

        padding: 0.6rem 0.9rem;

        border-radius: 999px;

        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);

        border: none;

        color: #f9fafb;

        font-size: 0.8rem;

        font-weight: 600;

        cursor: pointer;

        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);

      }



      .assistant-toggle-icon {

        width: 18px;

        height: 18px;

        border-radius: 999px;

        background: rgba(15, 23, 42, 0.2);

        display: flex;

        align-items: center;

        justify-content: center;

      }



      .assistant-toggle-icon svg {

        width: 13px;

        height: 13px;

        fill: currentColor;

      }



      .assistant-panel {

        position: absolute;

        bottom: 3.25rem;

        right: 0;

        width: 360px;

        max-height: 520px;

        border-radius: 16px;

        background: #ffffff;

        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);

        display: none;

        flex-direction: column;

        overflow: hidden;

      }



      .assistant-header {

        padding: 0.9rem 1rem;

        border-bottom: 1px solid #e5e7eb;

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 0.5rem;

      }



      .assistant-title {

        font-size: 0.9rem;

        font-weight: 600;

        color: #111827;

      }



      .assistant-subtitle {

        font-size: 0.7rem;

        color: #6b7280;

      }



      .assistant-close {

        background: transparent;

        border: none;

        color: #9ca3af;

        padding: 0.25rem;

        cursor: pointer;

      }



      .assistant-messages {

        padding: 0.75rem 1rem;

        display: flex;

        flex-direction: column;

        gap: 0.5rem;

        overflow-y: auto;

        flex: 1 1 auto;

      }



      .assistant-message {

        font-size: 0.8rem;

        line-height: 1.4;

        border-radius: 10px;

        padding: 0.5rem 0.7rem;

        max-width: 100%;

      }



      .assistant-message-user {

        align-self: flex-end;

        background: #e0e7ff;

        color: #111827;

      }



      .assistant-message-assistant {

        align-self: flex-start;

        background: #f3f4f6;

        color: #111827;

      }



      .assistant-message-system {

        align-self: center;

        background: #eff6ff;

        color: #1d4ed8;

        font-size: 0.75rem;

      }



      .assistant-form {

        border-top: 1px solid #e5e7eb;

        padding: 0.6rem 0.8rem;

        display: flex;

        flex-direction: column;

        gap: 0.35rem;

      }



      .assistant-form textarea {

        resize: none;

        min-height: 56px;

        max-height: 120px;

      }



      .assistant-form-actions {

        display: flex;

        align-items: center;

        justify-content: space-between;

        gap: 0.5rem;

        font-size: 0.7rem;

      }



      .assistant-status {

        color: #6b7280;

      }



      body.dark .assistant-panel {

        background: #111827;

        border: 1px solid #374151;

      }



      body.dark .assistant-header {

        border-bottom-color: #374151;

      }



      body.dark .assistant-title {

        color: #e5e7eb;

      }



      body.dark .assistant-subtitle {

        color: #9ca3af;

      }



      body.dark .assistant-message-assistant {

        background: #1f2937;

        color: #e5e7eb;

      }



      body.dark .assistant-message-user {

        background: rgba(79, 70, 229, 0.4);

        color: #e5e7eb;

      }



      body.dark .assistant-message-system {

        background: rgba(59, 130, 246, 0.3);

        color: #bfdbfe;

      }



      body.dark .assistant-form {

        border-top-color: #374151;

      }



      @media (max-width: 960px) {

        .header-bar {

          padding: 0.9rem 1.1rem;

        }

        .header-content {

          gap: 1rem;

        }

        .container {

          padding: 1rem;

        }

        .card {

          padding: 1.25rem;

        }

        .dashboard-grid {

          grid-template-columns: 1fr;

        }

        body {

          padding-bottom: calc(var(--nav-height) + 10px);

        }

        .mobile-nav {

          display: grid;

        }

        .assistant-root {

          bottom: calc(var(--nav-height) + 0.5rem);

        }

      }



      @media (max-width: 640px) {

        .header-bar {

          padding: 0.8rem 1rem;

        }

        .controls {

          width: 100%;

          justify-content: flex-start;

        }

        .status-bar {

          width: 100%;

          justify-content: flex-start;

        }

        body {

          padding-bottom: calc(var(--nav-height) + 8px);

        }

        .card table {

          display: block;

          overflow-x: auto;

      }

    }

      /* Feedback modal */
      #feedback-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 0.75rem 1rem;
        border-radius: 999px;
        background: var(--text);
        color: #fff;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 1200;
      }
      #feedback-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1300;
      }
      #feedback-modal {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        width: min(520px, 90vw);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      }
      #feedback-modal h3 {
        margin: 0 0 0.5rem 0;
      }
      #feedback-modal .muted {
        margin-bottom: 0.75rem;
        display: block;
      }
      #feedback-modal form {
        display: grid;
        gap: 0.75rem;
      }
      #feedback-modal textarea {
        width: 100%;
        min-height: 70px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.6rem;
        font-family: inherit;
      }
      #feedback-modal input,
      #feedback-modal select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.6rem;
        font-family: inherit;
      }
      #feedback-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
      }

    </style>

  </head>

  <body>

    <!-- Header -->

    <div class="header-bar">

      <div class="header-content">

        <div class="logo-section">

          <div class="logo">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/>

            </svg>

          </div>

          <div>

            <h1 data-i18n="app_title">AI Telephony Dashboard</h1>

            <div style="font-size: 0.75rem; color: #64748b;" data-i18n="app_tagline">Owner Command Center</div>

          </div>

        </div>

        <div class="status-bar">

          <div id="connection-status" class="status-badge muted">

            <span class="status-dot"></span>

            <span data-i18n="status_connecting">Connecting...</span>

          </div>

          <div id="plan-badge" class="status-badge muted" style="display: none;"></div>

          <div id="user-chip" class="user-chip muted" aria-live="polite">

            <div class="user-dot"></div>

            <div class="user-chip-text">Signed out</div>

          </div>

          <div id="business-switcher" class="ghost-button" style="display: none; align-items: center; gap: 0.35rem;">

            <span style="font-size: 0.8rem; color: #475569;">Business</span>

            <select id="business-select" class="locale-select" style="min-width: 170px;"></select>

          </div>

          <button id="logout-btn" class="ghost-button" type="button" style="display: none;">Logout</button>

          <a id="login-link-header" class="ghost-button" href="login.html">Login</a>

          <a class="ghost-button" href="/planner" target="_blank" rel="noopener" aria-label="Open investor planner">
            Investor Brief
          </a>

          <div class="controls">

            <label for="locale-select" style="font-size:0.8rem; color:#475569;" data-i18n="locale_label">Language</label>

            <select id="locale-select" class="locale-select" aria-label="Select language">

              <option value="en" data-i18n="locale_en">English</option>

              <option value="es" data-i18n="locale_es">Espa√±ol</option>

            </select>

            <button id="theme-toggle" type="button" data-i18n="theme_dark">Dark Mode</button>

            <button id="refresh-all" type="button" data-i18n="refresh_all">Refresh All</button>

          </div>

        </div>

      </div>

    </div>



    <!-- Main Container -->

    <div class="container">

      <div class="data-strip" id="data-strip">

        <div class="data-pill" id="data-pill-calendar">

          <div>

            <strong>Calendar sync</strong>

            <div class="pill-note">Keep owner calendar connected for auto-bookings.</div>

          </div>

          <button class="pill-action" type="button" data-target="schedule-card">Review</button>

        </div>

        <div class="data-pill" id="data-pill-voice">

          <div>

            <strong>Twilio webhooks</strong>

            <div class="pill-note">Calls should hit the voice streaming webhook.</div>

          </div>

          <button class="pill-action" type="button" data-target="integration-card">Check</button>

          <div class="muted" id="voice-health-note" style="font-size: 0.8rem; margin-top: 0.3rem;"></div>

        </div>

        <div class="data-pill" id="data-pill-billing">

          <div>

            <strong>Billing & plan</strong>

            <div class="pill-note">Verify payment method and active plan.</div>

          </div>

          <button class="pill-action" type="button" data-target="subscription-card">Open</button>

        </div>

      </div>

      <div class="quick-actions" id="quick-actions">

        <button type="button" data-target="staff-invite-form-wrapper">Invite teammate</button>

        <button type="button" data-target="integration-card">Connect apps</button>

        <button type="button" data-target="subscription-card">Manage billing</button>

        <button type="button" data-target="chat-card">Recent conversations</button>

        <button type="button" data-link="onboarding.html">Finish onboarding</button>

      </div>

      <div class="section-anchor" id="section-settings"></div>

      <div class="section-header">

        <div>

          <div class="section-eyebrow" data-i18n="access_eyebrow">Access</div>

          <div class="section-title" data-i18n="settings_title">Settings & Integrations</div>

          <div class="section-subtitle" data-i18n="settings_subtitle">Save your tokens and verify key connections.</div>

        </div>

      </div>

      <!-- Owner Authentication -->

      <div class="card" aria-labelledby="owner-auth-title">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>

            </svg>

          </div>

          <h2 id="owner-auth-title" data-i18n="owner_auth_title">Owner Authentication</h2>

        </div>

        <div class="form-group">

          <label>

          <small data-i18n="tenant_api_key_label">Tenant API Key (X-API-Key)</small>

          <input id="owner-api-key-input" type="password" placeholder="Enter your tenant API key" aria-label="Tenant API key" data-i18n="tenant_api_key_placeholder" data-i18n-attr="placeholder,aria-label" />

        </label>

      </div>

      <div class="form-group">

        <label>

          <small data-i18n="owner_token_label">Owner Token (X-Owner-Token)</small>

          <input id="owner-token-input" type="password" placeholder="Enter your owner dashboard token" aria-label="Owner token" data-i18n="owner_token_placeholder" data-i18n-attr="placeholder,aria-label" />

        </label>

      </div>

      <div class="form-group">

        <label>

          <small data-i18n="business_id_label">Business ID (X-Business-ID)</small>

          <div style="display: flex; gap: 0.5rem;">

            <input id="business-id-input" type="text" placeholder="e.g. default_business or tenant id" aria-label="Business ID" data-i18n="business_id_placeholder" data-i18n-attr="placeholder,aria-label" />

            <button id="business-apply" type="button" style="min-width: 80px;" data-i18n="apply">Apply</button>

            <button id="business-clear" type="button" style="min-width: 80px;" data-i18n="clear">Clear</button>

          </div>

        </label>

        <small class="muted" data-i18n="business_hint">Switch between businesses without changing API keys (requires role access).</small>

      </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">

          <small id="owner-auth-status" class="muted"></small>

          <span id="owner-plan-label" class="pill" style="display: none;">Plan: Starter</span>

        </div>

      </div>



      <div class="card" id="user-management-card">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v1h16v-1c0-2.66-5.33-4-8-4z"/>

            </svg>

          </div>

          <h2>User Management & Session</h2>

        </div>

        <div class="form-group">

          <div id="user-session-summary" class="muted">Signed out. Use login to continue.</div>

          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">

            <a class="ghost-button" href="login.html">Login</a>

            <button id="logout-btn-inline" class="ghost-button" type="button" style="display: none;">Logout</button>

          </div>

        </div>

        <div class="form-group" id="staff-invite-form-wrapper">

          <label style="font-weight: 700;">Invite staff to this business</label>

          <form id="staff-invite-form">

            <div class="form-group">

              <label>

                <small>Email</small>

                <input id="invite-email" type="email" placeholder="crew@example.com" required />

              </label>

            </div>

            <div class="form-group">

              <label>

                <small>Role</small>

                <select id="invite-role" required>

                  <option value="staff">Staff</option>

                  <option value="viewer">Viewer</option>

                  <option value="admin">Admin</option>

                </select>

              </label>

            </div>

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">

              <button type="submit" style="flex: 1; min-width: 160px;">Send Invite</button>

              <small class="muted">Creates an invite token. Teammates set their own password.</small>

            </div>

            <div id="staff-invite-status" class="muted" style="margin-top: 0.35rem;"></div>

          </form>

        </div>

        <div id="staff-invite-list" class="muted" style="margin-top: 0.75rem;">No invites sent yet.</div>

        </div>

      <div class="card" id="subscription-card">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M12 2a5 5 0 00-5 5c0 3.5 5 9 5 9s5-5.5 5-9a5 5 0 00-5-5zm0 7a2 2 0 110-4 2 2 0 010 4z"/>

            </svg>

          </div>

          <h2>Subscription & Billing</h2>

        </div>

        <div class="form-group">

          <span id="subscription-pill" class="pill muted">Subscription: unknown</span>

        </div>

        <div class="form-group">

          <label><small>Plan</small></label>

          <select id="plan-select">

            <option value="basic">Starter</option>

            <option value="growth">Growth</option>

            <option value="scale">Scale</option>

          </select>

        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">

          <button id="start-subscription" type="button" style="min-width: 160px;">Start/Resume Subscription</button>

          <button id="manage-billing" type="button" class="ghost-button" style="min-width: 160px;">Manage Billing</button>

        </div>

        <div id="subscription-status-text" class="muted" style="margin-top: 0.35rem;"></div>

        <div id="subscription-warning" class="pill muted" style="margin-top: 0.35rem; display: none;"></div>

        <div id="subscription-usage" class="muted" style="margin-top: 0.35rem;"></div>

        <ul id="subscription-warnings-list" class="muted" style="margin: 0.35rem 0 0 1rem; padding-left: 1rem; display: none;"></ul>

      </div>



      <div class="card" id="team-card">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13z"/>

            </svg>

          </div>

          <h2>Team & Roles</h2>

        </div>

        <div id="team-content">

          <div class="loading">Loading team...</div>

        </div>

      </div>



      <div class="card">
        <div class="card-header">
          <div>
            <p class="muted">Team & Roles</p>
            <h2>Members</h2>
          </div>
          <div class="pill connected" id="active-business-pill" aria-live="polite"></div>
        </div>

        <div class="quick-actions" style="margin-bottom: 0.75rem;">
          <div>
            <label for="active-business-input" class="muted" style="font-size: 0.8rem;">Switch active business</label>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <input id="active-business-input" type="text" placeholder="business_id" aria-label="Active business id" />
              <button type="button" class="ghost-button" id="set-active-business">Set active</button>
            </div>
          </div>
          <div>
            <label class="muted" style="font-size: 0.8rem;">Invite teammate</label>
            <button type="button" class="ghost-button" data-target="staff-invite-form-wrapper">Open invite form</button>
          </div>
        </div>

        <div id="team-table" class="muted">Loading team...</div>
      </div>

      <div class="card" id="audit-card">
        <div class="card-header">
          <div>
            <p class="muted">Team & Roles</p>
            <h2>Activity Log</h2>
          </div>
          <div class="pill muted" id="audit-count-pill">No entries</div>
        </div>

        <div class="filter-row" style="margin-bottom: 0.5rem;">
          <select id="audit-actor-filter" aria-label="Filter by actor">
            <option value="">All actors</option>
            <option value="dashboard_user">Dashboard user</option>
            <option value="system">System</option>
          </select>
          <select id="audit-method-filter" aria-label="Filter by method">
            <option value="">All methods</option>
            <option value="POST">POST</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input id="audit-path-filter" type="text" placeholder="Filter by path..." aria-label="Filter by path" />
          <button id="audit-refresh" type="button">Refresh</button>
        </div>

        <div id="audit-log-content" class="muted">Loading activity...</div>
      </div>

        <div class="card" id="callbacks-card">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.32.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1C10.07 21 3 13.93 3 5c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.24 1.02l-2.21 2.2z"/>

            </svg>

          </div>

          <h2>Callbacks & Voicemails</h2>

        </div>

        <div class="muted" id="callbacks-updated" style="font-size: 0.8rem; margin: -0.35rem 0 0.35rem;">Not refreshed yet.</div>

        <div class="filter-row">
          <input id="callbacks-filter" type="text" placeholder="Filter by phone or reason..." aria-label="Filter callbacks" />
          <select id="callbacks-status-filter" aria-label="Filter callback status">
            <option value="">All statuses</option>
            <option value="RESOLVED">Resolved</option>
            <option value="PENDING">Pending</option>
          </select>
          <select id="callbacks-sort" aria-label="Sort callbacks">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
          </select>
          <button type="button" class="ghost-button" id="callbacks-clear">Clear</button>
          <span class="muted" id="callbacks-count" style="font-size: 0.85rem;">Showing 0</span>
        </div>
        <div class="summary-row" id="callbacks-summary">No callbacks yet.</div>
        <div id="callbacks-list">

          <div class="loading">Loading callbacks...</div>

        </div>

        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">

          <button id="refresh-callbacks" type="button">Refresh</button>
          <button id="download-callbacks" type="button">Download CSV</button>

          <small class="muted">Missed/partial calls and voicemails appear here for follow-up. LLM assists intents but emergencies stay deterministic.</small>

          <label style="display:flex; align-items:center; gap:0.35rem;">
            <input type="checkbox" id="email-alerts-toggle" />
            <span class="muted">Email owner alerts (Gmail connected)</span>
          </label>

        </div>

      </div>



      <div class="card" id="integration-card">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M10 3H3v7h7V3zm0 11H3v7h7v-7zM21 3h-7v7h7V3zm0 11h-7v7h7v-7z"/>

            </svg>

          </div>

          <h2 data-i18n="integration_title">Integration Status</h2>

        </div>

        <div id="integration-status-list">

          <div class="loading" data-i18n="integration_loading">Loading integrations</div>

        </div>

      </div>



      <div class="section-anchor" id="section-dashboard"></div>

      <div class="section-header">

        <div>

          <div class="section-eyebrow" data-i18n="overview_eyebrow">Overview</div>

          <div class="section-title" data-i18n="overview_title">Owner Dashboard</div>

          <div class="section-subtitle" data-i18n="overview_subtitle">Bookings, revenue signals, and assistant tips at a glance.</div>

        </div>

      </div>



      <!-- Quick Stats -->

      <div class="dashboard-grid">

        <!-- KPI Overview -->

        <div class="card" id="kpi-card" style="grid-column: span 2;">

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>

              </svg>

            </div>

            <h2 data-i18n="kpi_title">Key Performance Indicators</h2>

          </div>

          <div class="kpi-grid" id="owner-kpis-content">

            <div class="loading" data-i18n="kpi_loading">Loading KPIs</div>

          </div>

          <button id="refresh-owner-kpis" type="button" style="margin-top: 1rem; width: 100%;" data-i18n="kpi_refresh">Refresh KPIs</button>

        </div>



        <!-- QuickBooks Link & Pending -->

        <div class="card">

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M12 2C6.48 2 2 5.58 2 10c0 2.94 1.94 5.51 4.9 7.02-.21.74-.79 2.75-.9 3.18 0 0-.02.17.09.23.11.05.25.02.25.02.33-.05 2.15-1.41 2.49-1.66.68.1 1.38.16 2.08.16 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>

              </svg>

            </div>

            <h2>QuickBooks Link & Approvals</h2>

        </div>

        <div id="owner-qbo-mode" class="muted" style="margin: 0.25rem 0;"></div>

        <div id="owner-qbo-content">

          <div class="loading">Loading QuickBooks status...</div>

        </div>

          <div class="button-row" style="margin-top: 1rem;">

            <button id="owner-qbo-connect" type="button">Link QuickBooks</button>

            <button id="owner-qbo-refresh" type="button" class="secondary">Refresh</button>

            <button id="owner-qbo-notify" type="button" class="secondary">Notify owner</button>

            <span id="owner-qbo-pill" class="status-badge warning" aria-live="polite"></span>

          </div>

          <small id="owner-qbo-status" class="muted"></small>

        </div>



        <!-- Today's Summary -->

        <div class="card">

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>

              </svg>

            </div>

            <h2 data-i18n="today_title">Today's Jobs</h2>

          </div>

          <div id="today-summary-content">

            <div class="loading" data-i18n="today_loading">Loading</div>

          </div>

          <button id="refresh-today-summary" type="button" style="margin-top: 1rem; width: 100%;" data-i18n="today_refresh">Refresh</button>

        </div>



        <!-- Tomorrow's Schedule -->

        <div class="card" id="schedule-card" style="grid-column: span 2;">

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>

              </svg>

            </div>

          <h2 data-i18n="schedule_title">Tomorrow's Schedule</h2>

        </div>

        <p id="schedule-summary" style="margin-bottom: 1rem; color: #64748b;" data-i18n="schedule_loading">Loading schedule...</p>

        <div class="muted" id="schedule-updated" style="font-size: 0.8rem; margin: -0.35rem 0 0.35rem;">Not refreshed yet.</div>

        <div id="schedule-list"></div>

        <button id="refresh-schedule" type="button" style="margin-top: 1rem; width: 100%;" data-i18n="schedule_refresh">Refresh Schedule</button>

      </div>



        <!-- Emergency Jobs -->

        <div class="card">

          <div class="card-header">

            <div class="card-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>

              </svg>

            </div>

            <h2 data-i18n="emergencies_title">Emergency Jobs</h2>

          </div>

          <div id="emergency-content">

            <div class="loading" data-i18n="emergencies_loading">Loading</div>

          </div>

          <button id="refresh-emergencies" type="button" style="margin-top: 1rem; width: 100%;" data-i18n="emergencies_refresh">Refresh</button>

        </div>



          <!-- Analytics -->

          <div class="card" style="grid-column: span 2;">

            <div class="card-header">

              <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>

            </svg>

          </div>

            <h2 data-i18n="analytics_title">Analytics Overview</h2>

          </div>

            <div id="analytics-content">

              <div class="loading" data-i18n="analytics_loading">Loading</div>

            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">

              <button id="refresh-analytics" type="button" style="flex: 1;" data-i18n="analytics_refresh">Refresh</button>

              <button id="download-service-mix" type="button" style="flex: 1;" data-i18n="analytics_download_csv">Download CSV</button>

            </div>

          </div>



          <!-- 90-Day Calendar (Tags) -->

          <div class="card" style="grid-column: span 2;" data-min-tier="100">

            <div class="card-header">

              <div class="card-icon">

                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                  <path d="M7 10h5v5H7zM3 4h18v2H3zm16 4H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z"/>

                </svg>

              </div>

              <h2 data-i18n="calendar_title">90-Day Calendar (Tags)</h2>

            </div>

            <div id="calendar-90d-content">

              <div class="loading" data-i18n="calendar_loading">Loading</div>

            </div>

            <div class="calendar-legend">

              <div class="calendar-legend-item">

                <span class="calendar-legend-swatch" style="background:#fee2e2;"></span>

                <span data-i18n="calendar_legend_emergency">Emergency</span>

              </div>

              <div class="calendar-legend-item">

                <span class="calendar-legend-swatch" style="background:#ecfdf5;"></span>

                <span data-i18n="calendar_legend_maintenance">Maintenance</span>

              </div>

              <div class="calendar-legend-item">

                <span class="calendar-legend-swatch" style="background:#e0f2fe;"></span>

                <span data-i18n="calendar_legend_routine">Routine</span>

              </div>

              <div class="calendar-legend-item">

                <span class="calendar-legend-swatch" style="background:#eef2ff;"></span>

                <span data-i18n="calendar_legend_new_client">New client</span>

              </div>

            </div>

          </div>

  

          <!-- Market by ZIP (Wealth & Value) -->

          <div class="card" style="grid-column: span 2;" data-min-tier="100">

            <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M12 2L4 5v6c0 5.52 3.84 10.74 9 12 5.16-1.26 9-6.48 9-12V5l-8-3zm0 2.18L18.16 7 12 9.82 5.84 7 12 4.18zM5 9l7 3 7-3v3c0 4.07-2.75 8.12-7 9.44C7.75 20.12 5 16.07 5 12V9z"/>

              </svg>

            </div>

            <h2 data-i18n="zip_title">Market by ZIP (Wealth & Value)</h2>

          </div>

          <div id="zip-wealth-content">

            <div class="loading" data-i18n="zip_loading">Loading</div>

          </div>

        </div>



        <!-- Service Metrics (Price & Time) -->

        <div class="card" style="grid-column: span 2;" data-min-tier="100">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M3 17h2v-7H3v7zm4 0h2V7H7v10zm4 0h2v-4h-2v4zm4 0h2V3h-2v14zM3 19h18v2H3z"/>

            </svg>

          </div>

          <h2 data-i18n="service_metrics_title">Service Metrics (Price & Time)</h2>

        </div>

        <div class="muted" id="service-metrics-updated" style="font-size: 0.8rem; margin: -0.35rem 0 0.35rem;">Not refreshed yet.</div>

        <div id="service-metrics-content">

          <div class="loading" data-i18n="service_metrics_loading">Loading</div>

        </div>

      </div>



        <!-- AI Assistant Tips -->

        <div class="card" id="ai-tips-card">

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M12 2L2 7v2h1v8l9 5 9-5V9h1V7l-10-5zm0 2.18L18.16 8 12 11.82 5.84 8 12 4.18zM4 10l7 4v6l-7-3.89V10zm16 6.11L13 20v-6l7-4v6.11z"/>

              </svg>

            </div>

            <h2 data-i18n="ai_tips_title">AI Assistant & Tips</h2>

          </div>

          <p style="color: #475569; margin-top: 0.25rem;" data-i18n="ai_tips_intro">

            Ask the owner assistant for real-time answers, or start with these shortcuts.

          </p>

          <ul class="tips-list">

            <li data-i18n="ai_tip_one">"What emergencies are pending today and who's assigned?"</li>

            <li data-i18n="ai_tip_two">"Summarize bookings and revenue this week vs last week."</li>

            <li data-i18n="ai_tip_three">"Who are my top repeat customers in the last 90 days?"</li>

          </ul>

          <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">

            <button id="open-assistant-cta" type="button" style="flex: 1;" data-i18n="ai_tip_open">Open assistant</button>

            <button id="scroll-conversations" type="button" style="flex: 1;" data-i18n="ai_tip_view_conversations">View conversations</button>

          </div>

        </div>



        <!-- Conversations -->

        <div class="card" id="chat-card" style="grid-column: span 2;">

        <div class="card-header">

          <div class="card-icon">

            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>

            </svg>

          </div>

          <h2 data-i18n="conversations_title">Recent Conversations</h2>

        </div>

        <div class="muted" id="conversations-updated" style="font-size: 0.8rem; margin: -0.35rem 0 0.35rem;">Not refreshed yet.</div>

        <div class="filter-row">

          <input id="conversations-filter" type="text" placeholder="Filter by customer or outcome..." aria-label="Filter conversations" />

          <select id="conversations-channel-filter" aria-label="Filter by channel">

            <option value="">All channels</option>

            <option value="voice">Voice</option>

            <option value="sms">SMS</option>

            <option value="chat">Chat</option>

          </select>

          <select id="conversations-sort" aria-label="Sort conversations">

            <option value="newest">Newest first</option>

            <option value="oldest">Oldest first</option>

          </select>

          <button type="button" class="ghost-button" id="conversations-clear">Clear</button>

          <span class="muted" id="conversations-count" style="font-size: 0.85rem;">Showing 0</span>

        </div>
        <div class="summary-row" id="conversations-summary">No conversations yet.</div>

        <div id="conversations-list">

          <div class="loading" data-i18n="conversations_loading">Loading</div>

        </div>

        <div id="conversation-detail" style="margin-top: 1rem;"></div>

        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">

            <button id="refresh-conversations" type="button" style="flex: 1;" data-i18n="conversations_refresh">Refresh</button>

            <button id="download-conversations" type="button" style="flex: 1;" data-i18n="conversations_download">Download CSV</button>

          </div>

        </div>

      </div>

    </div>



    <nav class="mobile-nav" aria-label="Primary navigation">

      <button type="button" data-target="kpi-card">

        <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

          <path fill="currentColor" d="M5 3h14a2 2 0 0 1 2 2v14l-4-4H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/>

        </svg>

        <span data-i18n="mobile_dashboard">Dashboard</span>

      </button>

      <button type="button" data-target="schedule-card">

        <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

          <path fill="currentColor" d="M7 10h5v5H7zM5 3h2V1h2v2h6V1h2v2h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm14 4V5H5v2h14zM5 9v10h14V9H5z"/>

        </svg>

        <span data-i18n="mobile_schedule">Schedule</span>

      </button>

      <button type="button" data-target="chat-card">

        <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

          <path fill="currentColor" d="M4 4h16v10H5.17L4 15.17zM2 2v18l4-4h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2z"/>

        </svg>

        <span data-i18n="mobile_chat">Chat</span>

      </button>

      <button type="button" data-target="integration-card">

        <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

          <path fill="currentColor" d="M4 4h16v2H4zm3 4h10v2H7zm-3 4h16v2H4zm3 4h10v2H7z"/>

        </svg>

        <span data-i18n="mobile_settings">Settings</span>

      </button>

    </nav>



    <!-- Calendar report modal -->

    <div id="calendar-report-modal" class="modal-backdrop" aria-hidden="true">

      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calendar-modal-title">

        <div class="modal-header">

          <div>

            <div id="calendar-modal-title" class="modal-title" data-i18n="modal_title">Schedule report</div>

            <div style="font-size: 0.75rem; color: #6b7280;" data-i18n="modal_subtitle">90-day calendar tags summarized for the selected day.</div>

          </div>

          <button id="calendar-modal-close" type="button" class="assistant-close" aria-label="Close schedule report" data-i18n="modal_close_btn" data-i18n-attr="aria-label">&times;</button>

        </div>

        <div id="calendar-modal-body" class="modal-body">

          <div class="loading" data-i18n="loading_preparing_report">Preparing report...</div>

        </div>

        <div class="modal-footer">

          <button id="calendar-modal-download" type="button" data-i18n="modal_download">Download PDF</button>

          <button id="calendar-modal-dismiss" type="button" data-i18n="modal_close_btn">Close</button>

        </div>

      </div>

    </div>



    <!-- Owner assistant bubble -->

    <div id="owner-assistant-root" class="assistant-root">

      <button id="owner-assistant-toggle" type="button" class="assistant-toggle">

        <span class="assistant-toggle-icon">

          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

            <path d="M4 4h16v10H5.17L4 15.17V4zm0-2c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4zm4 9h8v2H8v-2zm0-3h8v2H8V8z"/>

          </svg>

        </span>

        <span data-i18n="assistant_toggle">Ask the dashboard</span>

      </button>

      <div id="owner-assistant-panel" class="assistant-panel" aria-hidden="true">

        <div class="assistant-header">

          <div>

            <div class="assistant-title" data-i18n="assistant_title">AI Owner Assistant</div>

            <div class="assistant-subtitle" data-i18n="assistant_subtitle">Ask about metrics, data, policies, or support.</div>

          </div>

          <button id="owner-assistant-close" type="button" class="assistant-close" aria-label="Close assistant" data-i18n="modal_close_btn" data-i18n-attr="aria-label">&times;</button>

        </div>

        <div id="owner-assistant-messages" class="assistant-messages">

          <div class="assistant-message assistant-message-system">

            <span data-i18n="assistant_system_prompt">Ask me about today's jobs, emergency volume, service metrics, your customers, or privacy and security policies.</span>

          </div>

        </div>

        <form id="owner-assistant-form" class="assistant-form">

          <textarea

            id="owner-assistant-input"

            rows="2"

            data-i18n="assistant_placeholder"

            data-i18n-attr="placeholder"

            placeholder="Ask a question about this dashboard, your metrics, data, policies, or support..."

          ></textarea>

          <div class="assistant-form-actions">

            <span id="owner-assistant-status" class="assistant-status"></span>

            <button id="owner-assistant-send" type="submit" data-i18n="assistant_send">Ask</button>

          </div>

        </form>

      </div>

    </div>



    <div id="feedback-overlay">
      <div id="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="feedback-title">
        <h3 id="feedback-title">Send feedback</h3>
        <span class="muted">Share a quick bug or idea. We include tenant context automatically.</span>
        <form id="feedback-form">
          <label>
            <small>Category</small>
            <select id="feedback-category">
              <option value="bug">Bug</option>
              <option value="idea">Idea</option>
              <option value="support">Support</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            <small>Summary *</small>
            <input id="feedback-summary" type="text" placeholder="What happened?" required />
          </label>
          <label>
            <small>Steps to reproduce</small>
            <textarea id="feedback-steps" placeholder="Step 1, Step 2"></textarea>
          </label>
          <label>
            <small>Expected</small>
            <textarea id="feedback-expected" placeholder="What you expected to happen"></textarea>
          </label>
          <label>
            <small>Actual</small>
            <textarea id="feedback-actual" placeholder="What actually happened"></textarea>
          </label>
          <label>
            <small>CallSid (if applicable)</small>
            <input id="feedback-call-sid" type="text" placeholder="Twilio CallSid" />
          </label>
          <label>
            <small>Contact (optional)</small>
            <input id="feedback-contact" type="text" placeholder="Email or phone" />
          </label>
          <div id="feedback-actions">
            <button type="button" class="secondary" id="feedback-close">Cancel</button>
            <button type="submit">Send</button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">

      const DEFAULT_BACKEND_BASE = "http://localhost:8000";

      const backendBase = DEFAULT_BACKEND_BASE;

      let apiKey = localStorage.getItem("owner_api_key") || "";

      let ownerToken = localStorage.getItem("owner_owner_token") || "";

      let businessId =

        localStorage.getItem("owner_active_business_id") ||

        localStorage.getItem("owner_business_id") ||

        "";

      let accessToken = localStorage.getItem("owner_access_token") || "";

      let refreshToken = localStorage.getItem("owner_refresh_token") || "";

      let userEmail = localStorage.getItem("owner_user_email") || "";
      let emailAlertsEnabled = localStorage.getItem("owner_email_alerts") === "true";

      let userRoles = JSON.parse(localStorage.getItem("owner_user_roles") || "[]");

      let userId = localStorage.getItem("owner_user_id") || "";

      let calendar90dData = null;

      let ownerAssistantOpen = false;

      let ownerAssistantBusy = false;

      let geoMap = null;

      let geoLayer = null;

      let ownerServiceTier = null;

      let locale = localStorage.getItem("owner_locale") || "en";

      let connectionState = "connecting";

      let recentInvites = [];

      let subscriptionStatus = "unknown";

      let subscriptionPlan = "basic";

      let businessMemberships = [];

      let conversationItems = [];

      let voiceChannelsHealthy = true;

      let callbackItems = [];
      let filteredCallbacks = [];



      const i18nStrings = {

        en: {

          app_title: "AI Telephony Dashboard",

          app_tagline: "Owner Command Center",

          locale_label: "Language",

          locale_en: "English",

          locale_es: "Espa\u00f1ol",

          status_connecting: "Connecting...",

          status_connected: "Connected",

          status_error: "Connection Error",

          theme_dark: "Dark Mode",

          theme_light: "Light Mode",

          refresh_all: "Refresh All",

          refresh: "Refresh",

          access_eyebrow: "Access",

          settings_title: "Settings & Integrations",

          settings_subtitle: "Save your tokens and verify key connections.",

          owner_auth_title: "Owner Authentication",

          tenant_api_key_label: "Tenant API Key (X-API-Key)",

          tenant_api_key_placeholder: "Enter your tenant API key",

          owner_token_label: "Owner Token (X-Owner-Token)",

          owner_token_placeholder: "Enter your owner dashboard token",

          business_id_label: "Business ID (X-Business-ID)",

          business_id_placeholder: "Enter a business ID",

          apply: "Apply",

          clear: "Clear",

          business_hint: "Switch between businesses without changing API keys (requires role access).",

          integration_title: "Integration Status",

          integration_loading: "Loading integrations",

          integration_empty: "No integration data",

          integration_connected: "Connected",

          integration_disconnected: "Not connected",

          overview_eyebrow: "Overview",

          overview_title: "Owner Dashboard",

          overview_subtitle: "Bookings, revenue signals, and assistant tips at a glance.",

          kpi_title: "Key Performance Indicators",

          kpi_loading: "Loading KPIs",

          kpi_refresh: "Refresh KPIs",

          kpi_empty: "No KPI data yet",

          kpi_unable: "Unable to load KPIs",

          kpi_conversion: "Conversion",

          kpi_avg_time: "Avg Time to Book",

          kpi_repeat: "Repeat Work",

          kpi_sms: "SMS Confirms",

          kpi_data_complete: "Data Complete",

          today_title: "Today's Jobs",

          today_loading: "Loading",

          today_refresh: "Refresh",

          today_total: "Total Jobs",

          today_emergency: "Emergency Jobs",

          today_standard: "Standard Jobs",

          today_unable: "Unable to load summary",

          schedule_title: "Tomorrow's Schedule",

          schedule_loading: "Loading schedule...",

          schedule_refresh: "Refresh Schedule",

          schedule_empty: "No appointments scheduled for tomorrow",

          schedule_unable: "Unable to load schedule",

          schedule_fallback: "You have {count} appointments scheduled for tomorrow.",

          tag_emergency: "emergency",

          tag_normal: "normal",

          emergencies_title: "Emergency Jobs",

          emergencies_loading: "Loading",

          emergencies_refresh: "Refresh",

          emergencies_today: "Today",

          emergencies_last7: "Last 7 Days",

          emergencies_last30: "Last 30 Days",

          emergencies_unable: "Unable to load emergency data",

          analytics_title: "Analytics Overview",

          analytics_loading: "Loading",

          analytics_refresh: "Refresh",

          analytics_download_csv: "Download CSV",

          analytics_total: "Appointments (Last 30 Days)",

          analytics_emergency_share: "Emergency Share (30 Days)",

          analytics_repeat_share: "Repeat Work Share",

          analytics_conversion: "Lead to Booked Conversion",

          analytics_unable: "Unable to load analytics",

          calendar_title: "90-Day Calendar (Tags)",

          calendar_loading: "Loading",

          calendar_legend_emergency: "Emergency",

          calendar_legend_maintenance: "Maintenance",

          calendar_legend_routine: "Routine",

          calendar_legend_new_client: "New client",

          calendar_locked: "Upgrade to the Growth plan ($100/mo) to unlock the 90-day calendar.",

          calendar_empty: "No appointments in the next 90 days",

          calendar_unable: "Unable to load 90-day calendar",

          calendar_jobs_single: "1 job",

          calendar_jobs_plural: "{count} jobs",

          calendar_modal_title_prefix: "Schedule report for",

          calendar_modal_empty: "No appointments scheduled for this day",

          calendar_modal_overview: "Overview",

          calendar_modal_by_tag: "By tag",

          calendar_modal_by_service: "By service type",

          calendar_modal_no_tag: "No tag data",

          calendar_modal_no_service: "No service-type data",

          calendar_modal_download: "Download PDF",

          calendar_modal_close: "Close",

          calendar_modal_total_jobs: "Total jobs",

          calendar_modal_new_customers: "New customers",

          calendar_modal_est_value: "Estimated value",

          calendar_modal_avg_label: "avg",

          zip_title: "Market by ZIP (Wealth & Value)",

          zip_loading: "Loading",

          zip_locked: "Upgrade to the Growth plan ($100/mo) to unlock market-by-ZIP analytics.",

          zip_empty: "No ZIP-level data available yet",

          zip_unable: "Unable to load ZIP/wealth data",

          zip_unknown: "Unknown",

          zip_band_low: "< $50k",

          zip_band_mid: "$50k - $80k",

          zip_band_high: "\u2265 $80k",

          zip_no_income: "No income data",

          zip_jobs_value: "Jobs: {jobs} \u00b7 Value: ${value}",

          service_metrics_title: "Service Metrics (Price & Time)",

          service_metrics_loading: "Loading",

          service_metrics_locked: "Upgrade to the Growth plan ($100/mo) to unlock detailed service metrics.",

          service_metrics_empty: "No service metrics available yet",

          service_metrics_unable: "Unable to load service metrics",

          service_metrics_jobs_price: "Jobs: {jobs} . Avg Price: ${price}",

          service_metrics_avg_price: "Avg Price",

          service_metrics_avg_time: "Avg Time",

          service_metrics_range: "Range",

          service_metrics_unspecified: "(unspecified)",

          service_map_title: "Service Map (last 30 days)",

          ai_tips_title: "AI Assistant & Tips",

          ai_tips_intro: "Ask the owner assistant for real-time answers, or start with these shortcuts.",

          ai_tip_one: "\"What emergencies are pending today and who's assigned?\"",

          ai_tip_two: "\"Summarize bookings and revenue this week vs last week.\"",

          ai_tip_three: "\"Who are my top repeat customers in the last 90 days?\"",

          ai_tip_open: "Open assistant",

          ai_tip_view_conversations: "View conversations",

          conversations_title: "Recent Conversations",

          conversations_loading: "Loading",

          conversations_refresh: "Refresh",

          conversations_download: "Download CSV",

          conversations_empty: "No flagged or emergency conversations",

          conversations_unable: "Unable to load conversations",

          conversations_unknown_customer: "Unknown customer",

          conversations_channel: "Channel",

          conversations_created: "Created",

          mobile_dashboard: "Dashboard",

          mobile_schedule: "Schedule",

          mobile_chat: "Chat",

          mobile_settings: "Settings",

          modal_title: "Schedule report",

          modal_subtitle: "90-day calendar tags summarized for the selected day.",

          modal_download: "Download PDF",

          modal_close_btn: "Close",

          assistant_toggle: "Ask the dashboard",

          assistant_title: "AI Owner Assistant",

          assistant_subtitle: "Ask about metrics, data, policies, or support.",

          assistant_system_prompt: "Ask me about today's jobs, emergency volume, service metrics, your customers, or privacy and security policies.",

          assistant_placeholder: "Ask a question about this dashboard, your metrics, data, policies, or support...",

          assistant_send: "Ask",

          assistant_poc_notice: "The owner assistant is optimized for Growth and Scale plans; you can still try it in this proof of concept.",

          assistant_thinking: "Thinking...",

          assistant_unreachable: "Unable to reach assistant",

          assistant_unavailable: "Assistant unavailable.",

          assistant_limited: "The owner assistant is a Growth/Scale feature; responses may be limited in Starter.",

          loading_generic: "Loading",

          loading_preparing_report: "Preparing report...",

          owner_token_saved: "Owner token saved",

          owner_token_cleared: "Owner token cleared",

          api_key_saved: "API key saved",

          api_key_cleared: "API key cleared",

          business_set: "Business set: {id}",

          business_cleared: "Business cleared",

          plan_label: "Plan: {plan}",

          map_loading: "Loading map markers...",

          map_empty: "No geocoded appointments yet.",

          map_unknown_area: "Unknown area",

          map_service: "service",

          map_emergency: "(emergency)",

          map_locations: "{count} locations mapped",

          map_unable: "Unable to load map data",

          upgrade_growth_map: "Upgrade to the Growth plan ($100/mo) to unlock the 90-day calendar."

        },

        es: {

          app_title: "Panel de telefon\u00eda con IA",

          app_tagline: "Centro de control del propietario",

          locale_label: "Idioma",

          locale_en: "Ingl\u00e9s",

          locale_es: "Espa\u00f1ol",

          status_connecting: "Conectando...",

          status_connected: "Conectado",

          status_error: "Error de conexi\u00f3n",

          theme_dark: "Modo oscuro",

          theme_light: "Modo claro",

          refresh_all: "Actualizar todo",

          refresh: "Actualizar",

          access_eyebrow: "Acceso",

          settings_title: "Configuraci\u00f3n e integraciones",

          settings_subtitle: "Guarda tus tokens y verifica las conexiones clave.",

          owner_auth_title: "Autenticaci\u00f3n del propietario",

          tenant_api_key_label: "Clave de API del inquilino (X-API-Key)",

          tenant_api_key_placeholder: "Ingresa tu API key del inquilino",

          owner_token_label: "Token del propietario (X-Owner-Token)",

          owner_token_placeholder: "Ingresa tu token del propietario",

          business_id_label: "ID del negocio (X-Business-ID)",

          business_id_placeholder: "Ingresa un ID de negocio",

          apply: "Aplicar",

          clear: "Limpiar",

          business_hint: "Cambia entre negocios sin modificar las API keys (requiere permisos).",

          integration_title: "Estado de integraciones",

          integration_loading: "Cargando integraciones",

          integration_empty: "Sin datos de integraciones",

          integration_connected: "Conectado",

          integration_disconnected: "No conectado",

          overview_eyebrow: "Resumen",

          overview_title: "Panel del propietario",

          overview_subtitle: "Reservas, se\u00f1ales de ingresos y sugerencias del asistente en un vistazo.",

          kpi_title: "Indicadores clave",

          kpi_loading: "Cargando KPIs",

          kpi_refresh: "Actualizar KPIs",

          kpi_empty: "A\u00fan no hay KPIs",

          kpi_unable: "No se pudieron cargar los KPIs",

          kpi_conversion: "Conversi\u00f3n",

          kpi_avg_time: "Tiempo promedio para agendar",

          kpi_repeat: "Trabajo recurrente",

          kpi_sms: "Confirmaciones por SMS",

          kpi_data_complete: "Datos completos",

          today_title: "Trabajos de hoy",

          today_loading: "Cargando",

          today_refresh: "Actualizar",

          today_total: "Trabajos totales",

          today_emergency: "Trabajos de emergencia",

          today_standard: "Trabajos est\u00e1ndar",

          today_unable: "No se pudo cargar el resumen",

          schedule_title: "Agenda de ma\u00f1ana",

          schedule_loading: "Cargando agenda...",

          schedule_refresh: "Actualizar agenda",

          schedule_empty: "No hay citas programadas para ma\u00f1ana",

          schedule_unable: "No se pudo cargar la agenda",

          schedule_fallback: "Tienes {count} citas programadas para ma\u00f1ana.",

          tag_emergency: "emergencia",

          tag_normal: "normal",

          emergencies_title: "Trabajos de emergencia",

          emergencies_loading: "Cargando",

          emergencies_refresh: "Actualizar",

          emergencies_today: "Hoy",

          emergencies_last7: "\u00daltimos 7 d\u00edas",

          emergencies_last30: "\u00daltimos 30 d\u00edas",

          emergencies_unable: "No se pudieron cargar los datos de emergencia",

          analytics_title: "Resumen anal\u00edtico",

          analytics_loading: "Cargando",

          analytics_refresh: "Actualizar",

          analytics_download_csv: "Descargar CSV",

          analytics_total: "Citas (30 d\u00edas)",

          analytics_emergency_share: "Proporci\u00f3n de emergencias (30 d\u00edas)",

          analytics_repeat_share: "Proporci\u00f3n de trabajo recurrente",

          analytics_conversion: "Conversi\u00f3n de lead a reserva",

          analytics_unable: "No se pudo cargar anal\u00edtica",

          calendar_title: "Calendario de 90 d\u00edas (etiquetas)",

          calendar_loading: "Cargando",

          calendar_legend_emergency: "Emergencia",

          calendar_legend_maintenance: "Mantenimiento",

          calendar_legend_routine: "Rutina",

          calendar_legend_new_client: "Cliente nuevo",

          calendar_locked: "Actualiza al plan Growth ($100/mes) para ver el calendario de 90 d\u00edas.",

          calendar_empty: "No hay citas en los pr\u00f3ximos 90 d\u00edas",

          calendar_unable: "No se pudo cargar el calendario de 90 d\u00edas",

          calendar_jobs_single: "1 trabajo",

          calendar_jobs_plural: "{count} trabajos",

          calendar_modal_title_prefix: "Informe de agenda para",

          calendar_modal_empty: "No hay citas programadas para este d\u00eda",

          calendar_modal_overview: "Resumen",

          calendar_modal_by_tag: "Por etiqueta",

          calendar_modal_by_service: "Por tipo de servicio",

          calendar_modal_no_tag: "Sin datos de etiquetas",

          calendar_modal_no_service: "Sin datos por servicio",

          calendar_modal_download: "Descargar PDF",

          calendar_modal_close: "Cerrar",

          calendar_modal_total_jobs: "Trabajos totales",

          calendar_modal_new_customers: "Clientes nuevos",

          calendar_modal_est_value: "Valor estimado",

          calendar_modal_avg_label: "prom.",

          zip_title: "Mercado por c\u00f3digo postal (riqueza y valor)",

          zip_loading: "Cargando",

          zip_locked: "Actualiza al plan Growth ($100/mes) para ver la anal\u00edtica por c\u00f3digo postal.",

          zip_empty: "A\u00fan no hay datos a nivel de c\u00f3digo postal",

          zip_unable: "No se pudieron cargar los datos por c\u00f3digo postal",

          zip_unknown: "Desconocido",

          zip_band_low: "< $50k",

          zip_band_mid: "$50k - $80k",

          zip_band_high: "\u2265 $80k",

          zip_no_income: "Sin datos de ingresos",

          zip_jobs_value: "Trabajos: {jobs} \u00b7 Valor: ${value}",

          service_metrics_title: "M\u00e9tricas de servicio (precio y tiempo)",

          service_metrics_loading: "Cargando",

          service_metrics_locked: "Actualiza al plan Growth ($100/mes) para ver m\u00e9tricas de servicio detalladas.",

          service_metrics_empty: "A\u00fan no hay m\u00e9tricas de servicio",

          service_metrics_unable: "No se pudieron cargar las m\u00e9tricas de servicio",

          service_metrics_jobs_price: "Trabajos: {jobs} \u00b7 Precio prom.: ${price}",

          service_metrics_avg_price: "Precio prom.",

          service_metrics_avg_time: "Tiempo prom.",

          service_metrics_range: "Rango",

          service_metrics_unspecified: "(sin especificar)",

          service_map_title: "Mapa de servicio (\u00faltimos 30 d\u00edas)",

          ai_tips_title: "Asistente de IA y sugerencias",

          ai_tips_intro: "Pregunta al asistente en tiempo real o empieza con estos accesos directos.",

          ai_tip_one: "\"\u00bfQu\u00e9 emergencias est\u00e1n pendientes hoy y qui\u00e9n las tiene asignadas?\"",

          ai_tip_two: "\"Resume reservas e ingresos de esta semana vs la pasada.\"",

          ai_tip_three: "\"\u00bfQui\u00e9nes son mis mejores clientes recurrentes en los \u00faltimos 90 d\u00edas?\"",

          ai_tip_open: "Abrir asistente",

          ai_tip_view_conversations: "Ver conversaciones",

          conversations_title: "Conversaciones recientes",

          conversations_loading: "Cargando",

          conversations_refresh: "Actualizar",

          conversations_download: "Descargar CSV",

          conversations_empty: "No hay conversaciones marcadas o de emergencia",

          conversations_unable: "No se pudieron cargar las conversaciones",

          conversations_unknown_customer: "Cliente desconocido",

          conversations_channel: "Canal",

          conversations_created: "Creado",

          mobile_dashboard: "Panel",

          mobile_schedule: "Agenda",

          mobile_chat: "Chat",

          mobile_settings: "Ajustes",

          modal_title: "Informe de agenda",

          modal_subtitle: "Etiquetas del calendario de 90 d\u00edas resumidas para el d\u00eda seleccionado.",

          modal_download: "Descargar PDF",

          modal_close_btn: "Cerrar",

          assistant_toggle: "Preg\u00fantale al panel",

          assistant_title: "Asistente del propietario",

          assistant_subtitle: "Pregunta sobre m\u00e9tricas, datos, pol\u00edticas o soporte.",

          assistant_system_prompt: "Preg\u00fantame sobre los trabajos de hoy, volumen de emergencias, m\u00e9tricas de servicio, tus clientes o pol\u00edticas de privacidad y seguridad.",

          assistant_placeholder: "Haz una pregunta sobre este panel, tus m\u00e9tricas, datos, pol\u00edticas o soporte...",

          assistant_send: "Preguntar",

          assistant_poc_notice: "El asistente est\u00e1 optimizado para los planes Growth y Scale; a\u00fan puedes probarlo en este piloto.",

          assistant_thinking: "Pensando...",

          assistant_unreachable: "No se pudo contactar al asistente",

          assistant_unavailable: "Asistente no disponible.",

          assistant_limited: "El asistente es una funci\u00f3n de Growth/Scale; las respuestas pueden ser limitadas en Starter.",

          loading_generic: "Cargando",

          loading_preparing_report: "Preparando informe...",

          owner_token_saved: "Token del propietario guardado",

          owner_token_cleared: "Token del propietario eliminado",

          api_key_saved: "API key guardada",

          api_key_cleared: "API key eliminada",

          business_set: "Negocio seleccionado: {id}",

          business_cleared: "Negocio eliminado",

          plan_label: "Plan: {plan}",

          map_loading: "Cargando marcadores del mapa...",

          map_empty: "A\u00fan no hay citas geocodificadas.",

          map_unknown_area: "Zona desconocida",

          map_service: "servicio",

          map_emergency: "(emergencia)",

          map_locations: "{count} ubicaciones en el mapa",

          map_unable: "No se pudieron cargar los datos del mapa",

          upgrade_growth_map: "Actualiza al plan Growth ($100/mes) para ver el calendario de 90 d\u00edas."

        },

      };



      if (!i18nStrings[locale]) {

        locale = "en";

      }



      function t(key, fallback = "") {

        const table = i18nStrings[locale] || i18nStrings.en;

        if (table && Object.prototype.hasOwnProperty.call(table, key)) {

          return table[key];

        }

        if (i18nStrings.en && Object.prototype.hasOwnProperty.call(i18nStrings.en, key)) {

          return i18nStrings.en[key];

        }

        return fallback || key;

      }



      function formatTemplate(str, vars = {}) {

        return String(str || "").replace(/\{(\w+)\}/g, (match, key) => {

          return Object.prototype.hasOwnProperty.call(vars, key) ? vars[key] : match;

        });

      }



      function applyLocale() {

        const table = i18nStrings[locale] || i18nStrings.en;

        document.documentElement.lang = locale;

        document.querySelectorAll("[data-i18n]").forEach((el) => {

          const key = el.getAttribute("data-i18n");

          const attr = el.getAttribute("data-i18n-attr");

          const value = table && Object.prototype.hasOwnProperty.call(table, key)

            ? table[key]

            : i18nStrings.en?.[key];

          if (value === undefined) return;

          if (attr) {

            attr.split(",").forEach((attrNameRaw) => {

              const attrName = attrNameRaw.trim();

              if (!attrName) return;

              if (attrName === "text") {

                el.textContent = value;

              } else {

                el.setAttribute(attrName, value);

              }

            });

          } else {

            el.textContent = value;

          }

        });

        const localeSelect = document.getElementById("locale-select");

        if (localeSelect && localeSelect.value !== locale) {

          localeSelect.value = locale;

        }

        updateConnectionStatus(connectionState);

        setThemeToggleLabel();

      }



      function initLocale() {

        const select = document.getElementById("locale-select");

        if (select) {

          select.value = locale;

          select.addEventListener("change", () => {

            locale = select.value || "en";

            localStorage.setItem("owner_locale", locale);

            applyLocale();

            refreshAllData();

          });

        } else {

          document.documentElement.lang = locale;

        }

      }



      function updateConnectionStatus(state) {

        connectionState = state || "connecting";

        const el = document.getElementById("connection-status");

        if (!el) return;

        

        const dot = el.querySelector(".status-dot");

        const text = el.querySelector("span:last-child");

        

        if (state === "ok") {

          el.className = "status-badge success";

          text.textContent = t("status_connected");

        } else if (state === "error") {

          el.className = "status-badge error";

          text.textContent = t("status_error");

        } else {

          el.className = "status-badge muted";

          text.textContent = t("status_connecting");

        }

      }



      function setDataSourceStatus(id, state, note) {

        const pill = document.getElementById(id);

        if (!pill) return;

        pill.classList.remove("success", "warn", "error");

        if (state === "ok") pill.classList.add("success");

        else if (state === "warn") pill.classList.add("warn");

        else if (state === "error") pill.classList.add("error");

        const noteEl = pill.querySelector(".pill-note");

        if (noteEl && note) {

          noteEl.textContent = note;

        }

        if (id === "data-pill-voice") {

          const extra = document.getElementById("voice-health-note");

          if (extra && note) extra.textContent = note;

        }

      }



      function renderOutcomeBadge(outcome) {

        const text = (outcome || "").toLowerCase();

        if (!text) return '<span class="pill-badge muted">No outcome</span>';

        if (text.includes("book") || text.includes("scheduled")) return '<span class="pill-badge success">Booked</span>';

        if (text.includes("voicemail") || text.includes("missed")) return '<span class="pill-badge warn">Voicemail</span>';

        if (text.includes("callback")) return '<span class="pill-badge warn">Callback</span>';

        return `<span class="pill-badge">${escapeHtml(outcome || "Outcome")}</span>`;

      }



      function renderCallbackStatus(status) {

        const text = (status || "").toUpperCase();

        if (text === "RESOLVED") return '<span class="pill-badge success">Resolved</span>';

        if (text === "PENDING") return '<span class="pill-badge warn">Pending</span>';

        return `<span class="pill-badge">${escapeHtml(text || "PENDING")}</span>`;

      }

      function renderConversationSummary(list = []) {
        const row = document.getElementById("conversations-summary");
        if (!row) return;
        if (!list.length) {
          row.textContent = "No conversations yet.";
          return;
        }
        const total = list.length;
        const byChannel = list.reduce((acc, item) => {
          const key = (item.channel || "unknown").toLowerCase();
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
        const booked = list.filter((c) => (c.outcome || "").toLowerCase().includes("book")).length;
        const parts = [
          `Total ${total}`,
          `Voice ${byChannel.voice || 0}`,
          `SMS ${byChannel.sms || 0}`,
          `Chat ${byChannel.chat || 0}`,
          `Booked ${booked}`,
        ];
        row.textContent = parts.join(" | ");
      }



      function initDataStrip() {

        document.querySelectorAll(".pill-action[data-target]").forEach((btn) => {

          btn.addEventListener("click", () => {

            const targetId = btn.getAttribute("data-target");

            const target = targetId ? document.getElementById(targetId) : null;

            if (target) {

              target.scrollIntoView({ behavior: "smooth", block: "start" });

            }

          });

        });

        setDataSourceStatus("data-pill-calendar", "warn", "Checking calendar sync...");

        setDataSourceStatus("data-pill-voice", "warn", "Awaiting webhook status...");

        setDataSourceStatus("data-pill-billing", "warn", "Loading plan & payment...");

      }

      

      function initQuickActions() {

        document.querySelectorAll(".quick-actions button[data-target]").forEach((btn) => {

          btn.addEventListener("click", () => {

            const targetId = btn.getAttribute("data-target");

            const target = targetId ? document.getElementById(targetId) : null;

            if (target) {

              target.scrollIntoView({ behavior: "smooth", block: "start" });

            }

          });

        });

        document.querySelectorAll(".quick-actions button[data-link]").forEach((btn) => {

          btn.addEventListener("click", () => {

            const href = btn.getAttribute("data-link");

            if (href) window.location.href = href;

          });

        });

      }



      function updateRefreshed(id, isError = false) {

        const el = document.getElementById(id);

        if (!el) return;

        const stamp = new Date().toLocaleTimeString();

        el.textContent = isError ? `Last attempt ${stamp} (error)` : `Updated ${stamp}`;

        el.classList.toggle("muted", !isError);

        el.style.color = isError ? "#b91c1c" : "#64748b";

      }



      function attachRefreshBadge(buttonId, labelId) {

        const button = document.getElementById(buttonId);

        if (!button) return;

        const label = document.getElementById(labelId);

        if (!label) return;

        button.addEventListener("click", () => updateRefreshed(labelId));

      }



      function initConversationFilters() {

        const textInput = document.getElementById("conversations-filter");

        const channelSelect = document.getElementById("conversations-channel-filter");

        const sortSelect = document.getElementById("conversations-sort");

        const clearBtn = document.getElementById("conversations-clear");

        textInput?.addEventListener("input", () => applyConversationFilters());

        channelSelect?.addEventListener("change", () => applyConversationFilters());

        sortSelect?.addEventListener("change", () => applyConversationFilters());

        clearBtn?.addEventListener("click", () => {

          if (textInput) textInput.value = "";

          if (channelSelect) channelSelect.value = "";

          if (sortSelect) sortSelect.value = "newest";

          applyConversationFilters();

        });

      }



      function initCallbackFilters() {
        const textInput = document.getElementById("callbacks-filter");
        const statusSelect = document.getElementById("callbacks-status-filter");
        const sortSelect = document.getElementById("callbacks-sort");
        const clearBtn = document.getElementById("callbacks-clear");
        textInput?.addEventListener("input", () => applyCallbackFilters());
        statusSelect?.addEventListener("change", () => applyCallbackFilters());
        sortSelect?.addEventListener("change", () => applyCallbackFilters());
        clearBtn?.addEventListener("click", () => {
          if (textInput) textInput.value = "";
          if (statusSelect) statusSelect.value = "";
          if (sortSelect) sortSelect.value = "newest";
          applyCallbackFilters();
        });
      }

      function renderCallbackSummary(list = []) {
        const row = document.getElementById("callbacks-summary");
        if (!row) return;
        if (!list.length) {
          row.textContent = "No callbacks yet.";
          return;
        }
        const total = list.length;
        const resolved = list.filter((c) => (c.status || "").toUpperCase() === "RESOLVED").length;
        const pending = total - resolved;
        const voicemails = list.filter((c) => c.voicemail_url).length;
        row.textContent = `Total ${total} | Pending ${pending} | Resolved ${resolved} | Voicemail ${voicemails}`;
      }

      function downloadCallbacksCsv() {
        const data = (filteredCallbacks && filteredCallbacks.length) ? filteredCallbacks : callbackItems || [];
        if (!data.length) {
          alert("No callbacks to download.");
          return;
        }
        const header = ["phone", "reason", "status", "last_seen", "voicemail_url"];
        const rows = data.map((cb) => [
          cb.phone || "",
          cb.reason || "",
          cb.status || "",
          cb.last_seen || "",
          cb.voicemail_url || "",
        ]);
        const csv = [header, ...rows].map((r) =>
          r.map((cell) => `"${String(cell).replace(/"/g, '""')}"`).join(",")
        ).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "callbacks.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      async function loadTeam() {
        const table = document.getElementById("team-table");
        if (!table) return;
        if (!hasOwnerPrivileges()) {
          table.textContent = "Team management requires owner or admin.";
          return;
        }
        table.textContent = "Loading team...";
        try {
          const res = await authorizedFetch("/v1/owner/users");
          if (!res.ok) throw new Error(`Unable to load team (${res.status})`);
          const data = await res.json();
          const users = Array.isArray(data?.users) ? data.users : [];
          if (!users.length) {
            table.innerHTML = '<div class="muted">No teammates yet.</div>';
            return;
          }
          table.innerHTML = `
            <div class="table" role="table" aria-label="Team members">
              ${users
                .map(
                  (u) => `
                  <div class="table-row" role="row">
                    <div class="table-cell" role="cell">
                      <div style="font-weight:600;">${escapeHtml(u.email || "")}</div>
                      <div class="muted" style="font-size:0.8rem;">User ID: ${escapeHtml(u.id || "")}</div>
                    </div>
                    <div class="table-cell" role="cell">
                      <label class="muted" style="font-size:0.75rem;">Role</label>
                      <select data-user-id="${escapeHtml(u.id)}" class="role-select" ${hasOwnerPrivileges() ? "" : "disabled"}>
                        ${["owner", "admin", "staff", "viewer"]
                          .map((r) => `<option value="${r}" ${u.role === r ? "selected" : ""}>${r}</option>`)
                          .join("")}
                      </select>
                    </div>
                  </div>
                `
                )
                .join("")}
            </div>
          `;

          document.querySelectorAll(".role-select").forEach((select) => {
            select.addEventListener("change", async (evt) => {
              const userId = evt.target.getAttribute("data-user-id");
              const role = evt.target.value;
              if (!userId) return;
              try {
                const res = await authorizedFetch(`/v1/owner/users/${userId}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ role }),
                });
                if (!res.ok) {
                  throw new Error(`Unable to update role (${res.status})`);
                }
              } catch (err) {
                console.error(err);
                alert(err?.message || "Role update failed.");
              }
            });
          });
        } catch (err) {
          console.error(err);
          table.textContent = err?.message || "Unable to load team.";
        }
      }

      async function loadActiveBusiness() {
        const pill = document.getElementById("active-business-pill");
        if (!pill) return;
        try {
          const res = await authorizedFetch("/v1/auth/me");
          if (!res.ok) throw new Error();
          const data = await res.json();
          const businessId = data?.active_business_id || "default_business";
          pill.textContent = `Active business: ${businessId}`;
        } catch {
          pill.textContent = "Active business: unknown";
        }
      }

      async function setActiveBusiness() {
        const input = document.getElementById("active-business-input");
        const requestedBiz = input?.value?.trim();
        if (!requestedBiz) return;
        try {
          const res = await authorizedFetch("/v1/auth/active-business", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ business_id: requestedBiz }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.detail || `Unable to set active business (${res.status})`);
          persistSessionFromTokens(data);
          const nextBiz = data?.user?.active_business_id || requestedBiz;
          const nextRoles = Array.isArray(data?.user?.roles) ? data.user.roles : userRoles;
          businessId = nextBiz;
          localStorage.setItem("owner_business_id", nextBiz);
          localStorage.setItem("owner_active_business_id", nextBiz);
          if (nextRoles?.length) userRoles = nextRoles;
          renderBusinessSwitcher();
          updateUserUi();
          await loadActiveBusiness();
          loadTeam();
          loadInvites();
          loadAuditLog();
          refreshAllData();
        } catch (err) {
          console.error(err);
          alert(err?.message || "Unable to set active business.");
        }
      }

      async function loadAuditLog() {
        const container = document.getElementById("audit-log-content");
        const pill = document.getElementById("audit-count-pill");
        const actorSelect = document.getElementById("audit-actor-filter");
        const methodSelect = document.getElementById("audit-method-filter");
        const pathInput = document.getElementById("audit-path-filter");
        if (!container) return;
        if (!hasOwnerPrivileges()) {
          container.textContent = "Activity log requires owner or admin.";
          if (pill) {
            pill.textContent = "Restricted";
            pill.className = "pill muted";
          }
          return;
        }
        const params = new URLSearchParams({ limit: "50" });
        const actor = actorSelect?.value || "";
        const method = methodSelect?.value || "";
        const path = pathInput?.value?.trim() || "";
        if (actor) params.append("actor_type", actor);
        if (method) params.append("method", method);
        if (path) params.append("path_contains", path);
        container.innerHTML = '<div class="loading">Loading activity...</div>';
        try {
          const res = await authorizedFetch(`/v1/owner/audit?${params.toString()}`);
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data?.detail || `Unable to load activity (${res.status})`);
          }
          const events = Array.isArray(data) ? data : [];
          if (!events.length) {
            container.innerHTML = '<div class="muted">No recent activity.</div>';
            if (pill) {
              pill.textContent = "0 entries";
              pill.className = "pill muted";
            }
            return;
          }
          container.innerHTML = events
            .map(
              (ev) => `
              <div class="metric-row" style="align-items:flex-start; gap:0.5rem;">
                <div style="min-width:90px; font-weight:600;">${escapeHtml(ev.method || "")}</div>
                <div style="flex:1;">
                  <div style="font-weight:600;">${escapeHtml(ev.path || "")}</div>
                  <div class="muted" style="font-size:0.8rem;">
                    ${new Date(ev.created_at).toLocaleString()} ¬∑ ${escapeHtml(ev.actor_type || "user")} ¬∑ Status ${ev.status_code ?? ""}
                  </div>
                </div>
              </div>
            `
            )
            .join("");
          if (pill) {
            pill.textContent = `${events.length} entr${events.length === 1 ? "y" : "ies"}`;
            pill.className = "pill connected";
          }
        } catch (err) {
          console.error(err);
          container.textContent = err?.message || "Unable to load activity.";
          if (pill) {
            pill.textContent = "Error";
            pill.className = "pill muted";
          }
        }
      }

      function renderConversationSummary(list = []) {
        const row = document.getElementById("conversations-summary");
        if (!row) return;
        if (!list.length) {
          row.textContent = "No conversations yet.";
          return;
        }
        const total = list.length;
        const byChannel = list.reduce((acc, item) => {
          const key = (item.channel || "unknown").toLowerCase();
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
        const booked = list.filter((c) => (c.outcome || "").toLowerCase().includes("book")).length;
        row.textContent = `Total ${total} | Voice ${byChannel.voice || 0} | SMS ${byChannel.sms || 0} | Chat ${byChannel.chat || 0} | Booked ${booked}`;
      }


      function persistSessionFromTokens(data) {

        if (!data) return;

        accessToken = data.access_token || "";

        refreshToken = data.refresh_token || "";

        const user = data.user || {};

        userEmail = user.email || userEmail || "";

        userRoles = Array.isArray(user.roles) ? user.roles : [];

        userId = user.id || userId || "";

        if (user.active_business_id) {

          businessId = user.active_business_id;

          localStorage.setItem("owner_business_id", businessId);

          localStorage.setItem("owner_active_business_id", businessId);

        }

        localStorage.setItem("owner_access_token", accessToken);

        localStorage.setItem("owner_refresh_token", refreshToken);

        localStorage.setItem("owner_user_email", userEmail);

        localStorage.setItem("owner_user_roles", JSON.stringify(userRoles || []));

        if (userId) localStorage.setItem("owner_user_id", userId);

      }



      function clearSession(redirect = false) {

        accessToken = "";

        refreshToken = "";

        userEmail = "";

        userRoles = [];

        userId = "";

        businessId = "";

        localStorage.removeItem("owner_access_token");

        localStorage.removeItem("owner_refresh_token");

        localStorage.removeItem("owner_user_email");

        localStorage.removeItem("owner_user_roles");

        localStorage.removeItem("owner_user_id");

        localStorage.removeItem("owner_business_id");

        localStorage.removeItem("owner_active_business_id");

        updateUserUi();

        if (redirect) {

          window.location.href = "login.html";

        }

      }



      function hasOwnerPrivileges() {

        return userRoles.some((r) => ["owner", "admin"].includes(String(r).toLowerCase()));

      }



      function renderBusinessSwitcher() {

        const switcher = document.getElementById("business-switcher");

        const select = document.getElementById("business-select");

        if (!switcher || !select) return;

        if (!businessMemberships.length) {

          switcher.style.display = "none";

          select.innerHTML = "";

          return;

        }

        switcher.style.display = "inline-flex";

        select.innerHTML = businessMemberships

          .map(

            (m) =>

              `<option value="${escapeHtml(m.business_id)}">${escapeHtml(m.business_name || m.business_id)} (${escapeHtml(m.role)})</option>`

          )

          .join("");

        if (businessId) {

          select.value = businessId;

        }

      }



      function updateUserUi() {

        const chip = document.getElementById("user-chip");

        const logoutBtn = document.getElementById("logout-btn");

        const logoutInline = document.getElementById("logout-btn-inline");

        const loginLink = document.getElementById("login-link-header");

        const sessionInfo = document.getElementById("user-session-summary");

        const inviteWrapper = document.getElementById("staff-invite-form-wrapper");

        const staffList = document.getElementById("staff-invite-list");

        const subBadge = document.getElementById("subscription-pill");



        const signedIn = !!accessToken;

        const rolesLabel = userRoles.length ? `(${userRoles.join(", ")})` : "";

        const chipText = signedIn

          ? `Signed in as ${userEmail || "user"} ${rolesLabel}`.trim()

          : "Signed out";



        if (chip) {

          chip.querySelector(".user-chip-text").textContent = chipText;

          chip.classList.toggle("muted", !signedIn);

        }

        if (logoutBtn) logoutBtn.style.display = signedIn ? "inline-flex" : "none";

        if (logoutInline) logoutInline.style.display = signedIn ? "inline-flex" : "none";

        if (loginLink) loginLink.style.display = signedIn ? "none" : "inline-flex";

        if (sessionInfo) {

          const activeBiz = businessMemberships.find((m) => m.business_id === businessId);

          const businessLabel = activeBiz

            ? `${activeBiz.business_name || activeBiz.business_id} (${activeBiz.role})`

            : businessId || "unset";

          sessionInfo.textContent = signedIn

            ? `Active business: ${businessLabel}`

            : "Signed out. Use login to continue.";

        }

        if (inviteWrapper) inviteWrapper.style.display = hasOwnerPrivileges()

          ? "block"

          : "none";

        if (staffList && !hasOwnerPrivileges()) {

          staffList.textContent = "Staff invites require owner or admin.";

        }

        if (subBadge) {

          const statusLabel = subscriptionStatus || "unknown";

          subBadge.textContent = `Subscription: ${statusLabel}`;

          subBadge.className = "pill";

          if (statusLabel === "active") {

            subBadge.classList.add("connected");

          } else if (statusLabel === "past_due" || statusLabel === "canceled") {

            subBadge.classList.add("disconnected");

          } else {

            subBadge.classList.add("muted");

          }

        }

        renderBusinessSwitcher();

      }



      async function refreshAccessToken() {

        if (!refreshToken) return false;

        try {

          const res = await fetch(`${backendBase}/v1/auth/refresh`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify({

              refresh_token: refreshToken,

              business_id: businessId || undefined,

            }),

          });

          if (!res.ok) {

            clearSession();

            return false;

          }

          const data = await res.json();

          persistSessionFromTokens(data);

          updateUserUi();

          return true;

        } catch (err) {

          clearSession();

          return false;

        }

      }



      async function loadBusinesses() {

        try {

          const res = await authorizedFetch("/v1/auth/me/businesses");

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || `Unable to load businesses (${res.status})`);

          }

          businessMemberships = Array.isArray(data?.memberships) ? data.memberships : [];

          renderBusinessSwitcher();

        } catch (err) {

          businessMemberships = [];

          renderBusinessSwitcher();

        }

      }



      async function switchBusiness(newBusinessId) {

        if (!newBusinessId || newBusinessId === businessId) return;

        if (!refreshToken) return;

        const sessionInfo = document.getElementById("user-session-summary");

        try {

          if (sessionInfo) sessionInfo.textContent = "Switching business...";

          const res = await fetch(`${backendBase}/v1/auth/refresh`, {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify({

              refresh_token: refreshToken,

              business_id: newBusinessId,

            }),

          });

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || "Unable to switch business");

          }

          persistSessionFromTokens(data);

          businessId = data?.user?.active_business_id || newBusinessId;

          updateUserUi();

          loadTeam();

          loadInvites();

          loadSubscriptionStatus();

          refreshAllData();

        } catch (err) {

          if (sessionInfo) sessionInfo.textContent = err?.message || "Unable to switch business.";

        }

      }



      function authHeaders() {

        const headers = {};

        if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;

        if (apiKey) headers["X-API-Key"] = apiKey;

        if (ownerToken) headers["X-Owner-Token"] = ownerToken;

        if (businessId) headers["X-Business-ID"] = businessId;

        return headers;

      }



      async function authorizedFetch(path, init = {}) {

        const baseInit = {

          ...init,

          headers: { ...(init.headers || {}), ...authHeaders() },

        };

        let res = await fetch(backendBase + path, baseInit);

        if (res.status === 401 && refreshToken) {

          const refreshed = await refreshAccessToken();

          if (refreshed) {

            const retryInit = {

              ...init,

              headers: { ...(init.headers || {}), ...authHeaders() },

            };

            res = await fetch(backendBase + path, retryInit);

          }

        }

        return res;

      }



      async function fetchJson(path, init = {}) {

        try {

          const res = await authorizedFetch(path, init);

          if (!res.ok) {

            updateConnectionStatus("error");

            throw new Error("Request failed: " + res.status);

          }

          updateConnectionStatus("ok");

          return res.json();

        } catch (err) {

          updateConnectionStatus("error");

          throw err;

        }

      }



      function escapeHtml(value) {

        if (value === null || value === undefined) return "";

        return String(value)

          .replace(/&/g, "&amp;")

          .replace(/</g, "&lt;")

          .replace(/>/g, "&gt;")

          .replace(/"/g, "&quot;")

          .replace(/'/g, "&#39;");

      }



      function generateTempPassword() {

        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*";

        let pwd = "";

        for (let i = 0; i < 12; i += 1) {

          pwd += chars[Math.floor(Math.random() * chars.length)];

        }

        return pwd;

      }



      function formatPercent(value) {

        if (value === null || value === undefined || isNaN(value)) {

          return "0%";

        }

        const pct = Math.round(Number(value) * 100);

        return `${pct}%`;

      }



      function formatMinutes(value) {

        if (value === null || value === undefined || isNaN(value)) {

          return "0m";

        }

        const minutes = Math.max(0, Math.round(Number(value)));

        if (minutes < 60) {

          return `${minutes}m`;

        }

        const hours = Math.floor(minutes / 60);

        const rem = minutes % 60;

        return rem ? `${hours}h ${rem}m` : `${hours}h`;

      }



      function formatCurrency(value) {

        if (value === null || value === undefined || isNaN(value)) {

          return "0";

        }

        const num = Number(value);

        return num.toLocaleString(locale || undefined, { maximumFractionDigits: 0 });

      }



      function tierCodeToLabel(tier) {

        if (!tier) return "Unselected";

        if (tier === "20") return "Starter ($20/mo)";

        if (tier === "100") return "Growth ($100/mo)";

        if (tier === "200") return "Scale ($200/mo)";

        return tier;

      }



      function tierCodeToNumber(tier) {

        if (!tier) return 0;

        const n = Number(tier);

        return Number.isFinite(n) ? n : 0;

      }



      function featureEnabledForTier(requiredTierCode) {

        const required = tierCodeToNumber(requiredTierCode);

        const actual = tierCodeToNumber(ownerServiceTier);

        if (!required || !actual) return true;

        return actual >= required;

      }



      function renderIntegrationStatuses(list) {

        const container = document.getElementById("integration-status-list");

        if (!container) return;

        if (!list || !list.length) {

          container.innerHTML = `<div class="empty-state">${t("integration_empty")}</div>`;

          setDataSourceStatus("data-pill-voice", "warn", "Connect your Twilio number");

          setDataSourceStatus("data-pill-calendar", "warn", "Connect calendar to auto-book");

          return;

        }

        const twilioConnected = list.some((item) => (item?.provider || "").toLowerCase() === "twilio" && item?.connected);

        const calendarConnected = list.some((item) => (item?.provider || "").toLowerCase() === "gcalendar" && item?.connected);

        setDataSourceStatus("data-pill-voice", twilioConnected ? "ok" : "warn", twilioConnected ? "Twilio webhooks connected" : "Wire voice webhooks to streaming URL");

        setDataSourceStatus("data-pill-calendar", calendarConnected ? "ok" : "warn", calendarConnected ? "Calendar connected" : "Connect Google Calendar");

        container.innerHTML = list

          .map((item) => {

            const connected = !!item?.connected;

            const label = escapeHtml(item?.label || item?.provider || "Integration");

            const statusRaw = (item?.status || "").toLowerCase();

            let statusText = connected ? t("integration_connected") : t("integration_disconnected");

            if (statusRaw === "error") statusText = "Error";

            if (!connected && statusRaw && statusRaw !== "disconnected" && statusRaw !== "error") {
              statusText = statusRaw;
            }

            const statusClass = statusRaw === "error" ? "error" : connected ? "connected" : "disconnected";

            return `

              <div class="integration-row ${statusClass}">

                <div>

                  <div class="label">${label}</div>

                  <div class="metric-label">${escapeHtml(item?.provider || "")}</div>

                </div>

                <span class="status">${statusText}</span>

              </div>

            `;

          })

          .join("");

      }



      async function loadOwnerKpis() {

        const el = document.getElementById("owner-kpis-content");

        if (!el) return;

        el.innerHTML = `<div class="loading">${t("kpi_loading")}</div>`;



        try {

          const [customers, sms, ttb, funnel, completeness] = await Promise.all([

            fetchJson("/v1/owner/customers/analytics?days=365"),

            fetchJson("/v1/owner/sms-metrics"),

            fetchJson("/v1/owner/time-to-book?days=90"),

            fetchJson("/v1/owner/conversion-funnel?days=90"),

            fetchJson("/v1/owner/data-completeness?days=365"),

          ]);



          const kpis = [];



          const convRate = funnel && typeof funnel.overall_conversion_rate === "number"

            ? funnel.overall_conversion_rate

            : null;

          if (convRate !== null) {

            kpis.push({ label: t("kpi_conversion"), value: formatPercent(convRate) });

          }



          const avgMinutes = ttb && typeof ttb.overall_average_minutes === "number"

            ? ttb.overall_average_minutes

            : null;

          if (avgMinutes !== null) {

            kpis.push({ label: t("kpi_avg_time"), value: formatMinutes(avgMinutes) });

          }



          const repeatShare = customers && customers.economics && typeof customers.economics.repeat_customer_share === "number"

            ? customers.economics.repeat_customer_share

            : null;

          if (repeatShare !== null) {

            kpis.push({ label: t("kpi_repeat"), value: formatPercent(repeatShare) });

          }



          const smsShare = sms && typeof sms.confirmation_share_via_sms === "number"

            ? sms.confirmation_share_via_sms

            : null;

          if (smsShare !== null) {

            kpis.push({ label: t("kpi_sms"), value: formatPercent(smsShare) });

          }



          const completenessScore = completeness && typeof completeness.appointment_completeness_score === "number"

            ? completeness.appointment_completeness_score

            : null;

          if (completenessScore !== null) {

            kpis.push({ label: t("kpi_data_complete"), value: formatPercent(completenessScore) });

          }



          if (!kpis.length) {

            el.innerHTML = `<div class="empty-state">${t("kpi_empty")}</div>`;

            return;

          }



          el.innerHTML = kpis.map(kpi => `

            <div class="kpi-card">

              <div class="kpi-value">${escapeHtml(kpi.value)}</div>

              <div class="kpi-label">${escapeHtml(kpi.label)}</div>

            </div>

          `).join("");

        } catch (err) {

          el.innerHTML = `<div class="empty-state">${t("kpi_unable")}</div>`;

        }

      }



      async function loadOwnerQbo() {

        const content = document.getElementById("owner-qbo-content");

        const modeEl = document.getElementById("owner-qbo-mode");

        const statusEl = document.getElementById("owner-qbo-status");

        const badgeEl = document.getElementById("owner-qbo-pill");

        const connectBtn = document.getElementById("owner-qbo-connect");

        if (!content) return;

        content.innerHTML = '<div class="loading">Loading QuickBooks status...</div>';

        if (statusEl) statusEl.textContent = "";

        try {

          const [summary, pending] = await Promise.all([

            fetchJson("/v1/owner/qbo/summary"),

            fetchJson("/v1/owner/qbo/pending"),

          ]);

          if (modeEl) {
            modeEl.textContent = summary.connected
              ? `QuickBooks: live mode${summary.realm_id ? " (" + summary.realm_id + ")" : ""}`
              : summary.configured
                ? "QuickBooks: live credentials set, connect to go live."
                : "QuickBooks: demo/stub mode until client_id/secret/redirect are set.";
          }

          const badge = summary.connected

            ? '<span class="status-badge success">Connected</span>'

            : '<span class="status-badge warning">Not connected</span>';

          if (badgeEl) {

            badgeEl.className = "status-badge " + (summary.connected ? "success" : summary.configured ? "warning" : "muted");

            badgeEl.textContent = summary.connected ? "Connected" : summary.configured ? "Ready to link" : "Stub mode";

          }

          if (connectBtn) {

            if (summary.connected) {

              connectBtn.disabled = true;

              connectBtn.textContent = "QuickBooks linked";

            } else if (!summary.configured) {

              connectBtn.disabled = true;

              connectBtn.textContent = "Configure QBO first";

            } else {

              connectBtn.disabled = false;

              connectBtn.textContent = "Link QuickBooks";

            }

          }

          const pendingItems = (pending.items || []).slice(0, 5);

          const pendingHtml =

            pendingItems.length > 0

              ? pendingItems

                  .map(

                    (item) => `

              <div class="usage-row">

                <div class="usage-cell strong">${escapeHtml(item.customer_name || "Customer")}</div>

                <div class="usage-cell">${escapeHtml(item.service_type || "Service")} - ${escapeHtml(item.quote_status || "pending")}</div>

                <div class="usage-cell">$${formatNumber(item.quoted_value || 0)}</div>

              </div>

            `

                  )

                  .join("")

              : '<div class="muted">No pending approvals.</div>';

          content.innerHTML = `

            <div class="info-grid">

              <div>

                <div class="info-label">Status</div>

                <div class="info-value">${badge}</div>

                <div class="info-sub">${summary.connected ? "Realm: " + escapeHtml(summary.realm_id || "unknown") : "Not linked"}</div>

              </div>

              <div>

                <div class="info-label">Pending approvals</div>

                <div class="info-value">${formatNumber(summary.pending_count || 0)}</div>

                <div class="info-sub">Items waiting to sync to QuickBooks</div>

              </div>

            </div>

            <div style="margin-top: 0.75rem;">

              <div class="info-label">Pending items (latest)</div>

              ${pendingHtml}

            </div>

          `;

          if (statusEl) {

            statusEl.textContent = summary.connected

              ? `Connected to QuickBooks${summary.realm_id ? " (" + summary.realm_id + ")" : ""}`

              : "Not connected to QuickBooks yet.";

          }

        } catch (err) {

          content.innerHTML = `<div class="error">Unable to load QuickBooks status.</div>`;

          if (statusEl) statusEl.textContent = err.message || "Error loading QuickBooks status.";

          if (badgeEl) {

            badgeEl.className = "status-badge warning";

            badgeEl.textContent = "Status unknown";

          }

          if (connectBtn) {

            connectBtn.disabled = false;

            connectBtn.textContent = "Link QuickBooks";

          }

        }

      }



      async function notifyOwnerQbo() {

        const statusEl = document.getElementById("owner-qbo-status");

        if (statusEl) statusEl.textContent = "Sending QBO notification...";

        try {

          const res = await fetch(backendBase + "/v1/owner/qbo/notify", {

            method: "POST",

            headers: { ...authHeaders(), "Content-Type": "application/json" },

            body: JSON.stringify({ send_sms: true, send_email: false }),

          });

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data.detail || "Notify failed");

          }

          if (statusEl) statusEl.textContent = "Notification sent to owner.";

        } catch (err) {

          if (statusEl) statusEl.textContent = "Unable to notify: " + (err.message || err);

        }

      }



      async function connectOwnerQbo() {

        const statusEl = document.getElementById("owner-qbo-status");
        const connectBtn = document.getElementById("owner-qbo-connect");
        const modeEl = document.getElementById("owner-qbo-mode");

        if (statusEl) statusEl.textContent = "Opening QuickBooks authorization...";
        if (connectBtn) connectBtn.disabled = true;

        try {

          const data = await fetchJson("/v1/integrations/qbo/authorize");

          if (data && data.authorization_url) {

            window.open(data.authorization_url, "_blank");

            if (statusEl) statusEl.textContent = "Complete QuickBooks OAuth in the new tab, then refresh.";

          } else {

            if (statusEl) statusEl.textContent = "Authorization URL not available.";
            if (modeEl) modeEl.textContent = "QuickBooks: demo/stub mode (missing client_id/secret/redirect).";

          }

        } catch (err) {

          console.error(err);
          if (statusEl) {
            statusEl.textContent =
              err?.detail ||
              err?.message ||
              "QuickBooks is not configured for this environment. Set QBO client id/secret/redirect to enable live mode.";
          }

        } finally {

          if (connectBtn) connectBtn.disabled = false;
        }

      }



      async function loadTodaySummary() {

        const el = document.getElementById("today-summary-content");

        if (!el) return;

        el.innerHTML = `<div class="loading">${t("today_loading")}</div>`;

        

        try {

          const data = await fetchJson("/v1/owner/summary/today");

          const total = data?.total_appointments ?? 0;

          const emergency = data?.emergency_appointments ?? 0;

          const standard = data?.standard_appointments ?? 0;



          el.innerHTML = `

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("today_total"))}</span>

              <span class="metric-value">${escapeHtml(total)}</span>

            </div>

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("today_emergency"))}</span>

              <span class="metric-value" style="color: #ef4444;">${escapeHtml(emergency)}</span>

            </div>

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("today_standard"))}</span>

              <span class="metric-value">${escapeHtml(standard)}</span>

            </div>

          `;

        } catch (err) {

          el.innerHTML = `<div class="empty-state">${t("today_unable")}</div>`;

        }

      }



      async function loadSchedule() {

        const summaryEl = document.getElementById("schedule-summary");

        const listEl = document.getElementById("schedule-list");

        if (!summaryEl || !listEl) return;

        

        summaryEl.textContent = t("schedule_loading");

        listEl.innerHTML = "";

        

        try {

          const data = await fetchJson("/v1/owner/schedule/tomorrow");

          const appointments = Array.isArray(data?.appointments) ? data.appointments : [];

          updateRefreshed("schedule-updated");



          summaryEl.textContent = data?.reply_text || formatTemplate(t("schedule_fallback"), { count: appointments.length });

          setDataSourceStatus(

            "data-pill-calendar",

            appointments.length ? "ok" : "warn",

            appointments.length ? `Calendar in sync . ${appointments.length} booking(s)` : "No upcoming bookings found"

          );



          if (!appointments.length) {

            listEl.innerHTML = `<div class="empty-state">${t("schedule_empty")}</div>`;

            return;

          }



          listEl.innerHTML = appointments.map(apt => {

            const start = apt.start_time ? new Date(apt.start_time) : null;

            const timeLabel = start && !isNaN(start.getTime())

              ? start.toLocaleTimeString(locale || undefined, { hour: "numeric", minute: "2-digit" })

              : "";

            const tag = apt.is_emergency ? "emergency" : "normal";

            const tagText = apt.is_emergency ? t("tag_emergency") : t("tag_normal");

            return `

              <div class="metric-row">

                <div>

                  <div style="font-weight: 600;">${escapeHtml(apt.customer_name || t("conversations_unknown_customer"))}</div>

                  <div style="font-size: 0.875rem; color: #64748b;">${escapeHtml(timeLabel)}</div>

                </div>

                <span class="tag tag-${tag}">${escapeHtml(tagText)}</span>

              </div>

            `;

          }).join("");

        } catch (err) {

          summaryEl.textContent = t("schedule_unable");

          setDataSourceStatus("data-pill-calendar", "error", "Calendar unavailable");

          updateRefreshed("schedule-updated", true);

        }

      }



      async function loadEmergencyJobs() {

        const el = document.getElementById("emergency-content");

        if (!el) return;

        el.innerHTML = `<div class="loading">${t("emergencies_loading")}</div>`;

        

        try {

          const [today, week, month] = await Promise.all([

            fetchJson("/v1/owner/service-mix?days=1"),

            fetchJson("/v1/owner/service-mix?days=7"),

            fetchJson("/v1/owner/service-mix?days=30"),

          ]);



          const todayEmerg = today?.emergency_appointments_30d ?? 0;

          const weekEmerg = week?.emergency_appointments_30d ?? 0;

          const monthEmerg = month?.emergency_appointments_30d ?? 0;



          el.innerHTML = `

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("emergencies_today"))}</span>

              <span class="metric-value">${escapeHtml(todayEmerg)}</span>

            </div>

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("emergencies_last7"))}</span>

              <span class="metric-value">${escapeHtml(weekEmerg)}</span>

            </div>

            <div class="metric-row">

              <span class="metric-label">${escapeHtml(t("emergencies_last30"))}</span>

              <span class="metric-value">${escapeHtml(monthEmerg)}</span>

            </div>

          `;

        } catch (err) {

          el.innerHTML = `<div class="empty-state">${t("emergencies_unable")}</div>`;

        }

      }



      async function loadAnalytics() {

        const el = document.getElementById("analytics-content");

        if (!el) return;

        el.innerHTML = `<div class="loading">${t("analytics_loading")}</div>`;



        try {

          const [mix, customers, funnel] = await Promise.all([

            fetchJson("/v1/owner/service-mix?days=30"),

            fetchJson("/v1/owner/customers/analytics?days=365"),

            fetchJson("/v1/owner/conversion-funnel?days=90"),

          ]);



          const total30 = mix?.total_appointments_30d ?? 0;

          const emergency30 = mix?.emergency_appointments_30d ?? 0;

          const emergencyShare = total30 > 0 ? emergency30 / total30 : 0;



          const repeatShare = customers?.economics?.repeat_customer_share ?? 0;

          const convRate = funnel?.overall_conversion_rate ?? 0;



          el.innerHTML = `

            <div class="feature-grid">

              <div class="feature-item">

                <div class="feature-icon">

                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path fill="white" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>

                  </svg>

                </div>

                <div>

                  <div style="font-weight: 600;">${escapeHtml(total30)}</div>

                  <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(t("analytics_total"))}</div>

                </div>

              </div>

              <div class="feature-item">

                <div class="feature-icon">

                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path fill="white" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>

                  </svg>

                </div>

                <div>

                  <div style="font-weight: 600;">${escapeHtml(formatPercent(emergencyShare))}</div>

                  <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(t("analytics_emergency_share"))}</div>

                </div>

              </div>

              <div class="feature-item">

                <div class="feature-icon">

                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path fill="white" d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm0 15l-4-4 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>

                  </svg>

                </div>

                <div>

                  <div style="font-weight: 600;">${escapeHtml(formatPercent(repeatShare))}</div>

                  <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(t("analytics_repeat_share"))}</div>

                </div>

              </div>

              <div class="feature-item">

                <div class="feature-icon">

                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                    <path fill="white" d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm0 15l-4-4 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>

                  </svg>

                </div>

                <div>

                  <div style="font-weight: 600;">${escapeHtml(formatPercent(convRate))}</div>

                  <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(t("analytics_conversion"))}</div>

                </div>

              </div>

            </div>

          `;

        } catch (err) {

          el.innerHTML = `<div class="empty-state">${t("analytics_unable")}</div>`;

        }

      }



        

      async function loadZipWealth() {

        const el = document.getElementById("zip-wealth-content");

        if (!el) return;

        if (!featureEnabledForTier("100")) {

          el.innerHTML = `<div class="empty-state">${t("zip_locked")}</div>`;

          return;

        }

        el.innerHTML = `<div class="loading">${t("zip_loading")}</div>`;

        try {

          const data = await fetchJson("/v1/owner/neighborhoods?days=365");

          const items = Array.isArray(data?.items) ? data.items : [];

          if (!items.length) {

            el.innerHTML = `<div class="empty-state">${t("zip_empty")}</div>`;

            return;

          }

          const rows = items

            .filter(item => typeof item.label === "string" && item.label.length > 0)

            .map(item => {

              const zip = String(item.label);

              const value = Number(item.estimated_value_total || 0);

              const income = item.median_household_income;

              let band = t("zip_unknown");

              let color = "#e2e8f0";

              if (typeof income === "number") {

                if (income < 50000) {

                  band = t("zip_band_low");

                  color = "#bfdbfe";

                } else if (income < 80000) {

                  band = t("zip_band_mid");

                  color = "#fed7aa";

                } else {

                  band = t("zip_band_high");

                  color = "#bbf7d0";

                }

              }

              return { zip, value, income, band, color, appointments: item.appointments || 0 };

            })

            .sort((a, b) => b.value - a.value);



          el.innerHTML = `

            <div class="kpi-grid">

              ${rows.map(row => `

                <div class="metric-row" style="background: ${row.color}; border-radius: 12px; padding: 0.75rem 0.9rem;">

                  <div style="display: flex; justify-content: space-between; align-items: center;">

                    <div>

                      <div style="font-weight: 600;">ZIP ${escapeHtml(row.zip)}</div>

                      <div style="font-size: 0.75rem; color: #475569;">

                        ${escapeHtml(formatTemplate(t("zip_jobs_value"), { jobs: row.appointments, value: formatCurrency(row.value) }))}

                      </div>

                    </div>

                    <div style="text-align: right;">

                      <div style="font-size: 0.8rem; font-weight: 600;">

                        ${row.income ? "$" + formatCurrency(row.income) : escapeHtml(t("zip_no_income"))}

                      </div>

                      <div style="font-size: 0.75rem; color: #475569;">${row.band}</div>

                    </div>

                  </div>

                </div>

              `).join("")}

            </div>

          `;

        } catch (err) {

          console.error("Error loading ZIP wealth data", err);

          el.innerHTML = `<div class="empty-state">${t("zip_unable")}</div>`;

        }

      }



      function ensureGeoCard() {

        const grid = document.querySelector(".dashboard-grid");

        if (!grid) return;

        if (document.getElementById("geo-map-card")) return;

        const card = document.createElement("div");

        card.className = "card";

        card.id = "geo-map-card";

        card.innerHTML = `

          <div class="card-header">

            <div class="card-icon">

              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>

              </svg>

            </div>

            <h2 data-i18n="service_map_title">Service Map (last 30 days)</h2>

            <button id="refresh-geo-map" type="button" class="secondary" data-i18n="refresh">Refresh</button>

          </div>

          <div id="geo-map" class="map-container"></div>

          <div id="geo-map-status" style="margin-top:0.5rem; font-size:0.85rem; color:#64748b;"></div>

        `;

        grid.prepend(card);

      }



      async function loadGeoMarkers() {

        ensureGeoCard();

        const statusEl = document.getElementById("geo-map-status");

        const mapEl = document.getElementById("geo-map");

        if (!mapEl) return;

        if (statusEl) statusEl.textContent = t("map_loading");

        try {

          const data = await fetchJson("/v1/owner/geo/markers?days=30");

          const markers = Array.isArray(data?.markers) ? data.markers : [];

          if (!geoMap) {

            geoMap = L.map("geo-map").setView([39.0997, -94.5786], 11);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {

              attribution: "&copy; OpenStreetMap contributors",

            }).addTo(geoMap);

            geoLayer = L.layerGroup().addTo(geoMap);

          }

          geoLayer.clearLayers();

          if (!markers.length) {

            if (statusEl) statusEl.textContent = t("map_empty");

            return;

          }

          markers.forEach((m) => {

            const color = m.is_emergency ? "#ef4444" : "#3b82f6";

            const circle = L.circleMarker([m.lat, m.lng], {

              radius: m.is_emergency ? 8 : 6,

              color,

              fillColor: color,

              fillOpacity: 0.7,

            }).addTo(geoLayer);

            circle.bindPopup(`

              <strong>${escapeHtml(m.label || t("map_unknown_area"))}</strong><br/>

              ${escapeHtml(m.address || "")}<br/>

              ${escapeHtml(m.service_type || t("map_service"))} ${m.is_emergency ? t("map_emergency") : ""}

            `);

          });

          geoMap.fitBounds(geoLayer.getBounds(), { maxZoom: 13 });

          if (statusEl) statusEl.textContent = formatTemplate(t("map_locations"), { count: markers.length });

        } catch (err) {

          console.error("Error loading geo markers", err);

          if (statusEl) statusEl.textContent = t("map_unable");

        }

      }



      function refreshAllData() {

        loadOwnerKpis();

        loadOwnerQbo();

        loadTodaySummary();

        loadSchedule();

        loadEmergencyJobs();

        loadAnalytics();

        loadZipWealth();

        loadCalendar90d();

        loadServiceMetrics();

        loadGeoMarkers();

        loadConversations();

        loadInvites();

        loadAuditLog();

        loadCallbacks();

      }



      async function loadServiceMetrics() {

        const el = document.getElementById("service-metrics-content");

        if (!el) return;

        if (!featureEnabledForTier("100")) {

          el.innerHTML = `<div class="empty-state">${t("service_metrics_locked")}</div>`;

            return;

          }

          el.innerHTML = `<div class="loading">${t("service_metrics_loading")}</div>`;

        try {

          const data = await fetchJson("/v1/owner/service-metrics?days=90");

          const items = Array.isArray(data?.items) ? data.items : [];

          updateRefreshed("service-metrics-updated");

          if (!items.length) {

            el.innerHTML = `<div class="empty-state">${t("service_metrics_empty")}</div>`;

            return;

          }

          const rows = items.map(item => {

            const svc = item.service_type || t("service_metrics_unspecified");

            const jobs = item.appointments || 0;

            const totalValue = item.estimated_value_total || 0;

            const avgValue = item.estimated_value_average || 0;

            const minDur = item.scheduled_minutes_min;

            const maxDur = item.scheduled_minutes_max;

            const avgDur = item.scheduled_minutes_average;

            return {

              svc,

              jobs,

              totalValue,

              avgValue,

              minDur,

              maxDur,

              avgDur,

            };

          }).sort((a, b) => b.totalValue - a.totalValue);



          el.innerHTML = `

            <div class="kpi-grid">

              ${rows.map(row => `

                <div class="metric-row">

                  <div>

                    <div style="font-weight: 600;">${escapeHtml(row.svc)}</div>

                    <div style="font-size: 0.75rem; color: #64748b;">

                      ${escapeHtml(formatTemplate(t("service_metrics_jobs_price"), { jobs: row.jobs, price: formatCurrency(row.avgValue) }))}

                    </div>

                  </div>

                  <div style="text-align: right; font-size: 0.75rem; color: #475569;">

                    <div>${escapeHtml(t("service_metrics_avg_time"))}: ${formatMinutes(row.avgDur)}</div>

                    <div>${escapeHtml(t("service_metrics_range"))}: ${formatMinutes(row.minDur)} to ${formatMinutes(row.maxDur)}</div>

                </div>

              </div>

            `).join("")}

            </div>

          `;

        } catch (err) {

            console.error("Error loading service metrics", err);

            el.innerHTML = `<div class="empty-state">${t("service_metrics_unable")}</div>`;

            updateRefreshed("service-metrics-updated", true);

          }

        }



        async function loadCalendar90d() {

          const container = document.getElementById("calendar-90d-content");

          if (!container) return;

          if (!featureEnabledForTier("100")) {

            container.innerHTML = `<div class="empty-state">${t("calendar_locked")}</div>`;

            return;

          }

          container.innerHTML = `<div class="loading">${t("calendar_loading")}</div>`;



          try {

            const data = await fetchJson("/v1/owner/calendar/90d");

            calendar90dData = data;

            const days = Array.isArray(data?.days) ? data.days : [];

            if (!days.length) {

              container.innerHTML = `<div class="empty-state">${t("calendar_empty")}</div>`;

              return;

            }



            const gridHtml = `

              <div class="calendar-grid">

                ${days.map(day => {

                  const date = day.date;

                  const total = day.total_appointments || 0;

                  const tags = day.tag_counts || {};

                  const emergency = tags.emergency || tags["emergency"] || 0;

                  const maintenance = tags.maintenance || tags["maintenance"] || 0;

                  const newClients = tags.new_client || tags["new_client"] || 0;

                  const routine = tags.routine || tags["routine"] || 0;

                  const classes = ["calendar-day"];

                  if (emergency > 0) classes.push("calendar-day-emergency");

                  else if (newClients > 0) classes.push("calendar-day-new-client");

                  else if (maintenance > 0) classes.push("calendar-day-maintenance");

                  else if (routine > 0) classes.push("calendar-day-routine");

                  const label = typeof date === "string" ? date.slice(5) : "";

                  const title = total === 1

                    ? t("calendar_jobs_single")

                    : formatTemplate(t("calendar_jobs_plural"), { count: total });

                  return `

                    <button

                      type="button"

                      class="${classes.join(" ")}"

                      data-calendar-date="${escapeHtml(date)}"

                      title="${escapeHtml(title)}"

                    >

                      <div class="calendar-day-date">${escapeHtml(label)}</div>

                      <div class="calendar-day-total">${escapeHtml(total)}</div>

                    </button>

                  `;

                }).join("")}

              </div>

            `;

            container.innerHTML = gridHtml;



            const buttons = container.querySelectorAll("[data-calendar-date]");

            buttons.forEach((btn) => {

              btn.addEventListener("click", () => {

                const dateStr = btn.getAttribute("data-calendar-date");

                if (dateStr) {

                  openCalendarModal(dateStr);

                }

              });

            });

          } catch (err) {

            console.error("Error loading 90-day calendar", err);

            container.innerHTML = `<div class="empty-state">${t("calendar_unable")}</div>`;

          }

        }



        function openCalendarModal(dateStr) {

          const modal = document.getElementById("calendar-report-modal");

          const body = document.getElementById("calendar-modal-body");

          const titleEl = document.getElementById("calendar-modal-title");

          if (!modal || !body || !titleEl || !calendar90dData) return;



          const days = Array.isArray(calendar90dData.days) ? calendar90dData.days : [];

          const day = days.find((d) => d.date === dateStr);



          titleEl.textContent = `${t("calendar_modal_title_prefix")} ${dateStr}`;



          if (!day) {

            body.innerHTML = `<div class="empty-state">${t("calendar_modal_empty")}</div>`;

          } else {

            const tags = day.tag_counts || {};

            const services = day.service_type_counts || {};

            const total = day.total_appointments || 0;

            const newCustomers = day.new_customers || 0;

            const estTotal = day.estimated_value_total || 0;

            const estAvg = day.estimated_value_average;



            const tagRows = Object.keys(tags)

              .sort()

              .map((tag) => {

                const count = tags[tag] ?? 0;

                return `

                  <tr>

                    <td style="padding: 0.1rem 0.5rem;">${escapeHtml(tag)}</td>

                    <td style="padding: 0.1rem 0.5rem; text-align: right;">${escapeHtml(count)}</td>

                  </tr>

                `;

              })

              .join("");



            const svcRows = Object.keys(services)

              .sort()

              .map((svc) => {

                const count = services[svc] ?? 0;

                return `

                  <tr>

                    <td style="padding: 0.1rem 0.5rem;">${escapeHtml(svc)}</td>

                    <td style="padding: 0.1rem 0.5rem; text-align: right;">${escapeHtml(count)}</td>

                  </tr>

                `;

              })

              .join("");



            const overviewLine = (() => {

              const base = `${t("calendar_modal_total_jobs")}: ${escapeHtml(total)} | ${t("calendar_modal_new_customers")}: ${escapeHtml(newCustomers)} | ${t("calendar_modal_est_value")}: $${formatCurrency(estTotal)}`;

              if (estAvg !== null && estAvg !== undefined && !isNaN(estAvg)) {

                return `${base} (${t("calendar_modal_avg_label")}: $${formatCurrency(estAvg)})`;

              }

              return base;

            })();



            body.innerHTML = `

              <div style="margin-bottom: 0.75rem;">

                <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(t("calendar_modal_overview"))}</div>

                <div style="font-size: 0.8rem; color: #4b5563;">

                  ${overviewLine}

                </div>

              </div>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">

                <div>

                  <div style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">${escapeHtml(t("calendar_modal_by_tag"))}</div>

                  ${

                    tagRows

                      ? `<table style="width: 100%; font-size: 0.8rem;">${tagRows}</table>`

                      : `<div class="empty-state" style="padding: 0.5rem 0; font-size: 0.8rem;">${escapeHtml(t("calendar_modal_no_tag"))}</div>`

                  }

                </div>

                <div>

                  <div style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">${escapeHtml(t("calendar_modal_by_service"))}</div>

                  ${

                    svcRows

                      ? `<table style="width: 100%; font-size: 0.8rem;">${svcRows}</table>`

                      : `<div class="empty-state" style="padding: 0.5rem 0; font-size: 0.8rem;">${escapeHtml(t("calendar_modal_no_service"))}</div>`

                  }

                </div>

              </div>

            `;

          }



          modal.dataset.date = dateStr;

          modal.style.display = "flex";

          modal.setAttribute("aria-hidden", "false");

        }



        function closeCalendarModal() {

          const modal = document.getElementById("calendar-report-modal");

          if (!modal) return;

          modal.style.display = "none";

          modal.setAttribute("aria-hidden", "true");

          delete modal.dataset.date;

        }



        function initCalendarModal() {

          const closeButton = document.getElementById("calendar-modal-close");

          const dismissButton = document.getElementById("calendar-modal-dismiss");

          const downloadButton = document.getElementById("calendar-modal-download");

          const modal = document.getElementById("calendar-report-modal");



          closeButton?.addEventListener("click", closeCalendarModal);

          dismissButton?.addEventListener("click", closeCalendarModal);



          if (modal) {

            modal.addEventListener("click", (evt) => {

              if (evt.target === modal) {

                closeCalendarModal();

              }

            });

          }



          downloadButton?.addEventListener("click", () => {

            if (!modal) return;

            const dateStr = modal.dataset.date;

            if (!dateStr) return;

            const url = `${backendBase}/v1/owner/calendar/report.pdf?day=${encodeURIComponent(dateStr)}`;

            window.open(url, "_blank");

          });

        }

      async function loadConversations() {

        const listEl = document.getElementById("conversations-list");

        const detailEl = document.getElementById("conversation-detail");

        if (!listEl) return;

        listEl.innerHTML = `<div class="loading">${t("conversations_loading")}</div>`;

        if (detailEl) detailEl.innerHTML = "";



        try {

          const data = await fetchJson("/v1/owner/conversations/review");

          const items = Array.isArray(data?.items) ? data.items : [];

          updateRefreshed("conversations-updated");

          conversationItems = items;

          applyConversationFilters();

        } catch (err) {

          listEl.innerHTML = `<div class="empty-state">${t("conversations_unable")}</div>`;

          if (detailEl) detailEl.innerHTML = "";

          updateRefreshed("conversations-updated", true);

        }

      }



      function renderConversationList(list) {

        const listEl = document.getElementById("conversations-list");

        const detailEl = document.getElementById("conversation-detail");

        const countEl = document.getElementById("conversations-count");

        if (!listEl) return;



        if (!list || !list.length) {

          listEl.innerHTML = `<div class="empty-state">${t("conversations_empty")}</div>`;

          if (countEl) countEl.textContent = "Showing 0";

          if (detailEl) detailEl.innerHTML = "";

          return;

        }



        listEl.innerHTML = list.map(conv => `

          <div class="metric-row" data-conversation-id="${escapeHtml(conv.id)}">

            <div>

              <div style="font-weight: 600;">${escapeHtml(conv.customer_name || t("conversations_unknown_customer"))}</div>

              <div style="display:flex; gap:0.4rem; align-items:center; flex-wrap:wrap; margin-top: 0.2rem;">

                <span class="pill-badge ${escapeHtml(String(conv.channel || "").toLowerCase())}">

                  ${escapeHtml(String(conv.channel || "").toUpperCase() || "N/A")}

                </span>

                ${renderOutcomeBadge(conv.outcome)}

              </div>

            </div>

          </div>

        `).join("");



        if (countEl) countEl.textContent = `Showing ${list.length} of ${conversationItems.length}`;



        listEl.querySelectorAll(".metric-row").forEach(row => {

          row.addEventListener("click", () => {

            if (!detailEl) return;

            const id = row.getAttribute("data-conversation-id") || "";

            const conv = conversationItems.find(c => c.id === id);

            if (!conv) return;

            const created = conv.created_at ? new Date(conv.created_at) : null;

            const createdLabel = created && !isNaN(created.getTime())

              ? created.toLocaleString(locale || undefined)

              : "";

            detailEl.innerHTML = `

              <div style="padding-top: 1rem; border-top: 1px solid #f1f5f9;">

                <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(conv.customer_name || t("conversations_unknown_customer"))}</div>

                <div style="display:flex; gap:0.4rem; flex-wrap:wrap; margin-bottom: 0.25rem;">

                  <span class="pill-badge ${escapeHtml(String(conv.channel || "").toLowerCase())}">

                    ${escapeHtml(String(conv.channel || "").toUpperCase() || "N/A")}

                  </span>

                  ${renderOutcomeBadge(conv.outcome)}

                </div>

                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">

                  ${escapeHtml(t("conversations_created"))}: ${escapeHtml(createdLabel)}

                </div>

                <div style="font-size: 0.875rem; color: #4b5563;">${escapeHtml(conv.outcome || "")}</div>

              </div>

            `;

          });

        });

      }



      function applyConversationFilters() {

        const text = (document.getElementById("conversations-filter")?.value || "").toLowerCase();

        const channel = (document.getElementById("conversations-channel-filter")?.value || "").toLowerCase();

        const sort = (document.getElementById("conversations-sort")?.value || "newest").toLowerCase();

        let list = conversationItems || [];

        if (channel) {

          list = list.filter((c) => (c.channel || "").toLowerCase() === channel);

        }

        if (text) {

          list = list.filter((c) => {

            const combined = `${c.customer_name || ""} ${c.outcome || ""}`.toLowerCase();

            return combined.includes(text);

          });

        }

        list = list.slice().sort((a, b) => {

          const aDate = a.created_at ? new Date(a.created_at).getTime() : 0;

          const bDate = b.created_at ? new Date(b.created_at).getTime() : 0;

          return sort === "oldest" ? aDate - bDate : bDate - aDate;

        });

        renderConversationList(list);
        renderConversationSummary(list);

      }



      function appendAssistantMessage(role, text) {

        const container = document.getElementById("owner-assistant-messages");

        if (!container) return null;

        const div = document.createElement("div");

        div.className = "assistant-message";

        if (role === "user") {

          div.classList.add("assistant-message-user");

        } else if (role === "assistant") {

          div.classList.add("assistant-message-assistant");

        } else {

          div.classList.add("assistant-message-system");

        }

        div.textContent = text;

        container.appendChild(div);

        container.scrollTop = container.scrollHeight;

        return div;

      }



      async function askOwnerAssistant(question) {

        const statusEl = document.getElementById("owner-assistant-status");

        if (!question || !question.trim()) return null;

        if (ownerAssistantBusy) return null;

        if (!featureEnabledForTier("100")) {

          if (statusEl) {

            statusEl.textContent = t("assistant_limited");

          }

        }

        ownerAssistantBusy = true;

        if (statusEl) statusEl.textContent = t("assistant_thinking");



        let assistantDiv = appendAssistantMessage("assistant", "");

        try {

          const res = await fetch(`${backendBase}/v1/chat/stream`, {

            method: "POST",

            headers: {

              "Content-Type": "application/json",

              Accept: "text/event-stream",

              ...authHeaders(),

            },

            body: JSON.stringify({

              text: question,

              conversation_id: ownerAssistantConversationId,

            }),

          });

          if (!res.ok || !res.body) {

            const msg = `Error ${res.status}`;

            if (statusEl) statusEl.textContent = msg;

            return null;

          }



          const reader = res.body.getReader();

          const decoder = new TextDecoder();

          let buffer = "";



          function handleEventBlock(block) {

            let event = "message";

            const dataLines = [];

            for (const line of block.split("\n")) {

              if (line.startsWith("event:")) {

                event = line.slice(6).trim();

              } else if (line.startsWith("data:")) {

                dataLines.push(line.slice(5).trim());

              }

            }

            const data = dataLines.join("\n");

            if (event === "meta") {

              try {

                const meta = JSON.parse(data);

                if (meta.conversation_id) {

                  ownerAssistantConversationId = meta.conversation_id;

                }

              } catch (e) {

                // ignore parse errors

              }

              return false;

            }

            if (event === "done") {

              return true;

            }

            if (assistantDiv && data) {

              const spacer = assistantDiv.textContent ? " " : "";

              assistantDiv.textContent = `${assistantDiv.textContent || ""}${spacer}${data}`;

            }

            return false;

          }



          let done = false;

          while (!done) {

            const { value, done: readerDone } = await reader.read();

            if (readerDone) break;

            buffer += decoder.decode(value, { stream: true });

            let idx;

            while ((idx = buffer.indexOf("\n\n")) !== -1) {

              const block = buffer.slice(0, idx);

              buffer = buffer.slice(idx + 2);

              const stop = handleEventBlock(block);

              if (stop) {

                done = true;

                break;

              }

            }

          }

          if (statusEl) statusEl.textContent = "";

          return true;

        } catch (err) {

          console.error("Error calling owner assistant", err);

          if (statusEl) statusEl.textContent = t("assistant_unreachable");

          if (assistantDiv) assistantDiv.textContent = t("assistant_unavailable");

          return null;

        } finally {

          ownerAssistantBusy = false;

        }

      }



      function initOwnerAssistant() {

        const toggle = document.getElementById("owner-assistant-toggle");

        const panel = document.getElementById("owner-assistant-panel");

        const closeBtn = document.getElementById("owner-assistant-close");

        const form = document.getElementById("owner-assistant-form");

        const input = document.getElementById("owner-assistant-input");



        if (!toggle || !panel || !form || !input) {

          return;

        }



        // If the tenant is on Starter tier, keep the UI visible but

        // remind them this assistant is a Growth feature when they open it.

        const isGrowthOrHigher = featureEnabledForTier("100");



        function setOpen(open) {

          ownerAssistantOpen = open;

          panel.style.display = open ? "flex" : "none";

          panel.setAttribute("aria-hidden", open ? "false" : "true");

          if (open) {

            input.focus();

          }

        }



        toggle.addEventListener("click", () => {

          if (!isGrowthOrHigher) {

            const status = document.getElementById("owner-assistant-status");

            if (status) {

              status.textContent = t("assistant_poc_notice");

              status.className = "assistant-status";

            }

          }

          setOpen(!ownerAssistantOpen);

        });



        closeBtn?.addEventListener("click", () => {

          setOpen(false);

        });



        form.addEventListener("submit", async (evt) => {

          evt.preventDefault();

          const question = (input.value || "").trim();

          if (!question) return;

          appendAssistantMessage("user", question);

          input.value = "";

          await askOwnerAssistant(question);

        });

      }



      async function loadOwnerOnboardingProfile() {

        try {

          const data = await fetchJson("/v1/owner/onboarding/profile");

          ownerServiceTier = data && typeof data.service_tier === "string" ? data.service_tier : null;

          if (typeof data?.owner_email_alerts_enabled === "boolean") {
            emailAlertsEnabled = data.owner_email_alerts_enabled;
            localStorage.setItem("owner_email_alerts", emailAlertsEnabled ? "true" : "false");
            const toggle = document.getElementById("email-alerts-toggle");
            if (toggle) toggle.checked = emailAlertsEnabled;
          }

          const labelEl = document.getElementById("owner-plan-label");

          if (labelEl) {

            const label = tierCodeToLabel(ownerServiceTier);

            labelEl.textContent = formatTemplate(t("plan_label"), { plan: label });

            labelEl.style.display = "inline-flex";

          }

          renderIntegrationStatuses(data?.integrations || []);

        } catch (err) {

          renderIntegrationStatuses([]);

          // On failure, keep tier unset and let features load as default.

        }

      }

      async function saveEmailAlertsPreference(enabled) {
        try {
          const res = await authorizedFetch("/v1/owner/onboarding/profile", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ owner_email_alerts_enabled: !!enabled }),
          });
          if (!res.ok) {
            throw new Error(`Unable to save email alerts (${res.status})`);
          }
          emailAlertsEnabled = !!enabled;
          localStorage.setItem("owner_email_alerts", emailAlertsEnabled ? "true" : "false");
        } catch (err) {
          console.error(err);
          const toggle = document.getElementById("email-alerts-toggle");
          if (toggle) toggle.checked = emailAlertsEnabled;
          alert(err?.message || "Unable to update email alerts preference.");
        }
      }



      function initAuth() {

        const apiInput = document.getElementById("owner-api-key-input");

        const tokenInput = document.getElementById("owner-token-input");

        const businessInput = document.getElementById("business-id-input");

        const businessApply = document.getElementById("business-apply");

        const businessClear = document.getElementById("business-clear");

        const statusEl = document.getElementById("owner-auth-status");



        if (apiInput) {

          if (apiKey) apiInput.value = apiKey;

          apiInput.addEventListener("change", (e) => {

            apiKey = (e.target.value || "").trim();

            if (apiKey) {

              localStorage.setItem("owner_api_key", apiKey);

              if (statusEl) {

                statusEl.textContent = t("api_key_saved");

                statusEl.className = "success";

              }

            } else {

              localStorage.removeItem("owner_api_key");

              if (statusEl) {

                statusEl.textContent = t("api_key_cleared");

                statusEl.className = "muted";

              }

            }

          });

        }



        function persistBusinessId(nextId) {

          businessId = (nextId || "").trim();

          if (businessInput) businessInput.value = businessId;

          if (businessId) {

            localStorage.setItem("owner_business_id", businessId);

            localStorage.setItem("owner_active_business_id", businessId);

            if (statusEl) {

              statusEl.textContent = formatTemplate(t("business_set"), { id: businessId });

              statusEl.className = "success";

            }

          } else {

            localStorage.removeItem("owner_business_id");

            localStorage.removeItem("owner_active_business_id");

            if (statusEl) {

              statusEl.textContent = t("business_cleared");

              statusEl.className = "muted";

            }

          }

          updateUserUi();

        }



        if (businessInput) {

          if (businessId) businessInput.value = businessId;

          businessInput.addEventListener("change", (e) => {

            persistBusinessId(e.target.value);

          });

        }

        if (businessApply) {

          businessApply.addEventListener("click", () => {

            persistBusinessId(businessInput ? businessInput.value : businessId);

          });

        }

        if (businessClear) {

          businessClear.addEventListener("click", () => {

            persistBusinessId("");

          });

        }



        if (tokenInput) {

          if (ownerToken) tokenInput.value = ownerToken;

          tokenInput.addEventListener("change", (e) => {

            ownerToken = (e.target.value || "").trim();

            if (ownerToken) {

              localStorage.setItem("owner_owner_token", ownerToken);

              if (statusEl) {

                statusEl.textContent = t("owner_token_saved");

                statusEl.className = "success";

              }

            } else {

              localStorage.removeItem("owner_owner_token");

              if (statusEl) {

                statusEl.textContent = t("owner_token_cleared");

                statusEl.className = "muted";

              }

            }

          });

        }

      }



      function setThemeToggleLabel() {

        const themeToggle = document.getElementById("theme-toggle");

        if (!themeToggle) return;

        const isDark = document.body.classList.contains("dark");

        themeToggle.textContent = isDark ? t("theme_light") : t("theme_dark");

      }



      function initThemeToggle() {

        const themeToggle = document.getElementById("theme-toggle");

        const storedTheme = localStorage.getItem("owner_theme") || "light";

        if (storedTheme === "dark") {

          document.body.classList.add("dark");

        }

        if (themeToggle) {

          setThemeToggleLabel();

          themeToggle.addEventListener("click", () => {

            const isDark = document.body.classList.toggle("dark");

            localStorage.setItem("owner_theme", isDark ? "dark" : "light");

            setThemeToggleLabel();

          });

        }

      }



      function renderRecentInvites() {

        const list = document.getElementById("staff-invite-list");

        if (!list) return;

        if (!recentInvites.length) {

          list.textContent = hasOwnerPrivileges()

            ? "No invites sent yet."

            : "Staff invites require owner or admin.";

          return;

        }

        list.innerHTML = recentInvites

          .map(

            (invite) => `

              <div class="metric-row">

                <div>

                  <div style="font-weight: 600;">${escapeHtml(invite.email)}</div>

                  <div style="font-size: 0.75rem; color: #64748b;">${escapeHtml(invite.role)}</div>

                  ${

                    invite.invite_token

                      ? `<div class="muted" style="font-size: 0.75rem; word-break: break-all;">Token: ${escapeHtml(invite.invite_token)}</div>`

                      : ""

                  }

                </div>

                <div class="pill ${invite.status === "accepted" ? "connected" : invite.status === "expired" ? "disconnected" : "muted"}" style="font-size: 0.7rem;">

                  ${escapeHtml(invite.status || "pending")}

                </div>

                <div class="pill muted" style="font-size: 0.7rem;">

                  ${invite.expires_at ? new Date(invite.expires_at).toLocaleString() : "no expiry"}

                </div>

              </div>`

          )

          .join("");

      }



      async function loadInvites() {

        const list = document.getElementById("staff-invite-list");

        if (list) {

          list.textContent = hasOwnerPrivileges()

            ? "Loading invites..."

            : "Staff invites require owner or admin.";

        }

        try {

          const res = await authorizedFetch("/v1/owner/invites");

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || `Unable to load invites (${res.status})`);

          }

          recentInvites = Array.isArray(data?.invites) ? data.invites : [];

          renderRecentInvites();

        } catch (err) {

          if (list) list.textContent = err?.message || "Unable to load invites.";

        }

      }



      function renderCallbacks(items = []) {

        const list = document.getElementById("callbacks-list");

        const count = document.getElementById("callbacks-count");

        if (!list) return;

        if (!items.length) {

          list.innerHTML = '<div class="muted">No callbacks yet.</div>';

          if (count) count.textContent = "Showing 0";

          return;

        }

        if (count) count.textContent = `Showing ${items.length} of ${callbackItems.length || items.length}`;

        const emailToggle = document.getElementById("email-alerts-toggle");
        if (emailToggle) {
          emailToggle.checked = emailAlertsEnabled;
        }

        list.innerHTML = items

          .map(

            (cb) => `

              <div class="metric-row" style="align-items: center; gap: 0.5rem;">

                <div>

                  <div style="font-weight: 700;">${escapeHtml(cb.phone || "unknown")}</div>

                  <div class="muted" style="font-size: 0.8rem;">

                    ${escapeHtml(cb.reason || "callback")} | Seen ${cb.last_seen ? new Date(cb.last_seen).toLocaleString() : "n/a"}

                  </div>

                  ${

                    cb.voicemail_url

                      ? `<a href="${escapeHtml(cb.voicemail_url)}" target="_blank" class="pill-badge warn">Voicemail</a>`

                      : ""

                  }

                </div>

                ${renderCallbackStatus(cb.status)}

                <div style="display:flex; gap:0.35rem; flex-wrap:wrap;">
                  <button class="ghost-button" data-callback-phone="${escapeHtml(cb.phone)}">Mark resolved</button>
                  <button class="ghost-button" data-copy-phone="${escapeHtml(cb.phone)}">Copy</button>
                </div>

              </div>

            `

          )

          .join("");

        list.querySelectorAll("[data-callback-phone]").forEach((btn) => {

          btn.addEventListener("click", async (e) => {

            const phone = e.target.getAttribute("data-callback-phone");

            try {

              const res = await authorizedFetch(`/v1/owner/callbacks/${encodeURIComponent(phone)}`, {

                method: "PATCH",

                headers: { "Content-Type": "application/json" },

                body: JSON.stringify({ status: "RESOLVED", last_result: "Handled" }),

              });

              if (!res.ok) {

                throw new Error("Update failed");

              }

              loadCallbacks();

            } catch (err) {

              console.error("Unable to update callback", err);

            }

          });

        });

        list.querySelectorAll("[data-copy-phone]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const phone = btn.getAttribute("data-copy-phone") || "";
            try {
              await navigator.clipboard.writeText(phone);
              btn.textContent = "Copied";
              setTimeout(() => {
                btn.textContent = "Copy";
              }, 1200);
            } catch (err) {
              console.error("Clipboard failed", err);
            }
          });
        });

      }



      async function loadCallbacks() {

        const list = document.getElementById("callbacks-list");

        if (list) list.innerHTML = '<div class="loading">Loading callbacks...</div>';

        try {

          const res = await authorizedFetch("/v1/owner/callbacks");

          const data = await res.json();

          if (!res.ok) throw new Error(data?.detail || `Unable to load callbacks (${res.status})`);

          const items = Array.isArray(data?.callbacks) ? data.callbacks : [];

          callbackItems = items;

          updateRefreshed("callbacks-updated");

          applyCallbackFilters();

        } catch (err) {

          if (list) list.innerHTML = `<div class="error">${escapeHtml(err?.message || "Unable to load callbacks")}</div>`;

          updateRefreshed("callbacks-updated", true);

        }

      }



      function applyCallbackFilters() {
        const text = (document.getElementById("callbacks-filter")?.value || "").toLowerCase();
        const status = (document.getElementById("callbacks-status-filter")?.value || "").toUpperCase();
        const sort = (document.getElementById("callbacks-sort")?.value || "newest").toLowerCase();
        let list = callbackItems || [];
        if (status) {
          list = list.filter((c) => (c.status || "").toUpperCase() === status);
        }
        if (text) {
          list = list.filter((c) => {
            const combined = `${c.phone || ""} ${c.reason || ""}`.toLowerCase();
            return combined.includes(text);
          });
        }
        list = list.slice().sort((a, b) => {
          const aDate = a.last_seen ? new Date(a.last_seen).getTime() : 0;
          const bDate = b.last_seen ? new Date(b.last_seen).getTime() : 0;
          return sort === "oldest" ? aDate - bDate : bDate - aDate;
        });
        filteredCallbacks = list;
        renderCallbacks(list);
        renderCallbackSummary(list);
      }


      async function loadSubscriptionStatus() {

        const statusText = document.getElementById("subscription-status-text");

        const warning = document.getElementById("subscription-warning");

        const usage = document.getElementById("subscription-usage");

        const planBadge = document.getElementById("plan-badge");

        const warningsList = document.getElementById("subscription-warnings-list");

        try {

          const res = await authorizedFetch("/v1/billing/subscription/status");

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || `Unable to load subscription (${res.status})`);

          }

          subscriptionStatus = data?.status || "unknown";

          subscriptionPlan = data?.plan || subscriptionPlan || "basic";

          const select = document.getElementById("plan-select");

          if (select && subscriptionPlan) {

            select.value = subscriptionPlan;

          }

          if (statusText) {

            const endLabel = data?.current_period_end ? new Date(data.current_period_end).toLocaleString() : "n/a";

            const graceNote =
              data?.in_grace && !data?.blocked
                ? ` ‚Ä¢ In grace (${data?.grace_remaining_days || 0} days left)`
                : data?.blocked && data?.message
                ? ` ‚Ä¢ ${data.message}`
                : "";

            statusText.textContent = `Status: ${subscriptionStatus}${graceNote} . Period end: ${endLabel}`;

          }

          if (usage) {

            const parts = [];

            if (data?.calls_limit) {

              parts.push(`Calls ${data.calls_used || 0}/${data.calls_limit}`);

            }

            if (data?.appointments_limit) {

              parts.push(`Appointments ${data.appointments_used || 0}/${data.appointments_limit}`);

            }

            usage.textContent = parts.join(" . ");

          }

          if (warningsList) {

            const warnings = Array.isArray(data?.usage_warnings) ? data.usage_warnings : [];

            warningsList.innerHTML = warnings

              .map((w) => `<li>${escapeHtml(w)}</li>`)

              .join("");

            warningsList.style.display = warnings.length ? "block" : "none";

          }

          if (planBadge) {

            planBadge.style.display = "inline-flex";

            planBadge.textContent = `Plan: ${subscriptionPlan}`;

            const pillState =

              data?.blocked || subscriptionStatus === "canceled"

                ? "disconnected"

                : subscriptionStatus === "active"

                ? "success"

                : "warn";

            planBadge.className = "status-badge " + pillState;

          }

          const billingState =

            data?.blocked

              ? "error"

              : subscriptionStatus === "active"

              ? "ok"

              : "warn";

          const billingNote =

            data?.blocked && data?.message

              ? data.message

              : data?.in_grace

              ? `In grace period (${data?.grace_remaining_days || 0} days remaining)`

              : subscriptionStatus === "active"

              ? "Billing active"

              : subscriptionStatus === "past_due"

              ? "Past due ¬∑ update payment method"

              : "Add payment method to activate";

          setDataSourceStatus("data-pill-billing", billingState, billingNote);

          const startBtn = document.getElementById("start-subscription");

          if (startBtn) {

            startBtn.textContent = subscriptionStatus === "active" ? "Update plan" : "Start/Resume Subscription";

          }

          if (warning) {

            warning.style.display = "none";

            warning.className = "pill muted";

            if (data?.blocked) {

              warning.style.display = "inline-flex";

              warning.classList.add("disconnected");

              warning.textContent = data?.message || "Subscription inactive. Upgrade to use voice/chat.";

            } else if (data?.in_grace) {

              warning.style.display = "inline-flex";

              warning.textContent = `In grace period (${data?.grace_remaining_days || 0} days remaining).`;

            }

          }

        } catch (err) {

          if (statusText) statusText.textContent = err?.message || "Unable to load subscription.";

          setDataSourceStatus("data-pill-billing", "error", "Billing unreachable");

        } finally {

          updateUserUi();

        }

      }



async function loadTeam() {

        const container = document.getElementById("team-content");

        if (!container) return;

        container.innerHTML = '<div class="loading">Loading team...</div>';

        try {

          const res = await fetchJson("/v1/owner/users");

          const users = Array.isArray(res?.users) ? res.users : [];

          if (!users.length) {

            container.innerHTML = '<div class="muted">No users found for this business.</div>';

            return;

          }

          const canEdit = hasOwnerPrivileges();

          container.innerHTML = users

            .map((u) => {

              const role = escapeHtml(u.role || "");

              const email = escapeHtml(u.email || "");

              const name = escapeHtml(u.name || "");

              const roleControls = canEdit

                ? `<select data-user-role="${u.id}" class="pill">

                    <option value="owner" ${role === "owner" ? "selected" : ""}>Owner</option>

                    <option value="admin" ${role === "admin" ? "selected" : ""}>Admin</option>

                    <option value="staff" ${role === "staff" ? "selected" : ""}>Staff</option>

                    <option value="viewer" ${role === "viewer" ? "selected" : ""}>Viewer</option>

                  </select>`

                : `<span class="pill muted">${role}</span>`;

              return `

                <div class="metric-row" style="align-items: center; gap: 0.5rem;">

                  <div>

                    <div style="font-weight: 600;">${name || email}</div>

                    <div class="muted" style="font-size: 0.8rem;">${email}</div>

                  </div>

                  ${roleControls}

                </div>

              `;

            })

            .join("");

          if (canEdit) {

            container.querySelectorAll("[data-user-role]").forEach((el) => {

              el.addEventListener("change", async (e) => {

                const userId = e.target.getAttribute("data-user-role");

                const role = e.target.value;

                try {

                  await authorizedFetch(`/v1/owner/users/${userId}`, {

                    method: "PATCH",

                    headers: {

                      "Content-Type": "application/json",

                    },

                    body: JSON.stringify({ role }),

                  });

                } catch (err) {

                  e.target.classList.add("error");

                }

              });

            });

          }

        } catch (err) {

          container.innerHTML = `<div class="error">Unable to load team.</div>`;

        }

      }



      async function startSubscription() {

        const select = document.getElementById("plan-select");

        const planId = select ? select.value : "basic";

        const statusText = document.getElementById("subscription-status-text");

        try {

          if (statusText) {

            statusText.textContent = "Starting checkout session...";

          }

          const res = await authorizedFetch("/v1/billing/create-checkout-session", {

            method: "POST",

            headers: { "Content-Type": "application/x-www-form-urlencoded", ...authHeaders() },

            body: new URLSearchParams({ plan_id: planId }),

          });

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || `Checkout failed (${res.status})`);

          }

          if (statusText) statusText.textContent = "Redirecting to checkout...";

          if (data.url) {

            window.open(data.url, "_blank");

          }

        } catch (err) {

          if (statusText) {

            statusText.textContent = err?.message || "Unable to start subscription.";

          }

        }

      }



      async function openBillingPortal() {

        const statusText = document.getElementById("subscription-status-text");

        try {

          if (statusText) {

            statusText.textContent = "Opening billing portal...";

          }

          const res = await authorizedFetch("/v1/billing/portal-link");

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || `Portal unavailable (${res.status})`);

          }

          if (data.url) {

            window.open(data.url, "_blank");

          }

        } catch (err) {

          if (statusText) {

            statusText.textContent = err?.message || "Billing portal unavailable.";

          }

        }

      }



      async function handleStaffInvite(event) {

        event.preventDefault();

        const emailInput = document.getElementById("invite-email");

        const roleInput = document.getElementById("invite-role");

        const statusEl = document.getElementById("staff-invite-status");

        if (!emailInput || !roleInput) return;

        if (!hasOwnerPrivileges()) {

          if (statusEl) statusEl.textContent = "Invites require owner or admin.";

          return;

        }

        const email = (emailInput.value || "").trim();

        const role = (roleInput.value || "staff").trim();

        if (!email) {

          if (statusEl) statusEl.textContent = "Email is required.";

          return;

        }

        if (statusEl) {

          statusEl.textContent = "Sending invite...";

          statusEl.className = "muted";

        }

        try {

          const res = await authorizedFetch("/v1/owner/invites", {

            method: "POST",

            headers: {

              "Content-Type": "application/json",

            },

            body: JSON.stringify({

              email,

              role,

            }),

          });

          const data = await res.json();

          if (!res.ok) {

            throw new Error(data?.detail || "Invite failed");

          }

          recentInvites.unshift(data);

          renderRecentInvites();

          emailInput.value = "";

          if (statusEl) {

            statusEl.textContent = data?.invite_token

              ? `Invite created. Share this token with your teammate: ${data.invite_token}`

              : "Invite created. We will email or share the link.";

            statusEl.className = "success";

          }

        } catch (err) {

          if (statusEl) {

            statusEl.textContent = err?.message || "Unable to send invite.";

            statusEl.className = "error";

          }

        }

      }



      function initButtons() {

        document.getElementById("refresh-owner-kpis")?.addEventListener("click", loadOwnerKpis);

        document.getElementById("owner-qbo-refresh")?.addEventListener("click", loadOwnerQbo);

        document.getElementById("owner-qbo-notify")?.addEventListener("click", notifyOwnerQbo);

        document.getElementById("owner-qbo-connect")?.addEventListener("click", connectOwnerQbo);

        document.getElementById("refresh-today-summary")?.addEventListener("click", loadTodaySummary);

        document.getElementById("refresh-schedule")?.addEventListener("click", loadSchedule);

        document.getElementById("refresh-emergencies")?.addEventListener("click", loadEmergencyJobs);

        document.getElementById("refresh-analytics")?.addEventListener("click", loadAnalytics);

        document.getElementById("refresh-conversations")?.addEventListener("click", loadConversations);

        document.getElementById("refresh-geo-map")?.addEventListener("click", loadGeoMarkers);



        document.getElementById("download-service-mix")?.addEventListener("click", () => {

          window.open(backendBase + "/v1/owner/export/service-mix.csv", "_blank");

        });

        document.getElementById("download-conversations")?.addEventListener("click", () => {

          window.open(backendBase + "/v1/owner/export/conversations.csv", "_blank");

        });



        document.getElementById("refresh-all")?.addEventListener("click", () => {

          refreshAllData();

        });



        document.getElementById("open-assistant-cta")?.addEventListener("click", () => {

          document.getElementById("owner-assistant-toggle")?.click();

        });

        document.getElementById("scroll-conversations")?.addEventListener("click", () => {

          const chatCard = document.getElementById("chat-card");

          if (chatCard) {

            chatCard.scrollIntoView({ behavior: "smooth", block: "start" });

          }

        });



        document.getElementById("logout-btn")?.addEventListener("click", () => {

          clearSession(true);

        });

        document.getElementById("logout-btn-inline")?.addEventListener("click", () => {

          clearSession(true);

        });

        document.getElementById("staff-invite-form")?.addEventListener("submit", handleStaffInvite);

        document.getElementById("start-subscription")?.addEventListener("click", startSubscription);

        document.getElementById("manage-billing")?.addEventListener("click", openBillingPortal);

        document.getElementById("team-card")?.addEventListener("mouseenter", loadTeam);

        document.getElementById("business-select")?.addEventListener("change", (e) => {

          const value = e.target.value;

          switchBusiness(value);

        });

        document.getElementById("refresh-callbacks")?.addEventListener("click", loadCallbacks);
        document.getElementById("download-callbacks")?.addEventListener("click", downloadCallbacksCsv);
        document.getElementById("set-active-business")?.addEventListener("click", setActiveBusiness);
        document.getElementById("audit-refresh")?.addEventListener("click", loadAuditLog);
        document.getElementById("audit-actor-filter")?.addEventListener("change", loadAuditLog);
        document.getElementById("audit-method-filter")?.addEventListener("change", loadAuditLog);
        document.getElementById("audit-path-filter")?.addEventListener("change", loadAuditLog);
        document.getElementById("email-alerts-toggle")?.addEventListener("change", (e) => {
          saveEmailAlertsPreference(!!e.target.checked);
        });

      }



      function initMobileNav() {

        const buttons = Array.from(document.querySelectorAll(".mobile-nav button[data-target]"));

        if (!buttons.length) return;



        const setActive = (btn) => {

          buttons.forEach((b) => b.classList.toggle("active", b === btn));

        };



        const observer = new IntersectionObserver(

          (entries) => {

            entries.forEach((entry) => {

              if (entry.isIntersecting && entry.target.__navButton) {

                setActive(entry.target.__navButton);

              }

            });

          },

          { rootMargin: "-140px 0px -40% 0px", threshold: 0.1 }

        );



        buttons.forEach((btn) => {

          const targetId = btn.dataset.target;

          const target = targetId ? document.getElementById(targetId) : null;

          if (target) {

            target.__navButton = btn;

            observer.observe(target);

          }

          btn.addEventListener("click", () => {

            if (target) {

              target.scrollIntoView({ behavior: "smooth", block: "start" });

              setActive(btn);

            }

          });

        });

      }



      window.addEventListener("DOMContentLoaded", () => {

        initLocale();

        applyLocale();

        initDataStrip();

        initQuickActions();

        initConversationFilters();

        initCallbackFilters();

        updateConnectionStatus("connecting");

        updateUserUi();

        // Light status chips for streaming/intent readiness

        const statusContainer = document.querySelector(".status-bar");

        if (statusContainer) {

          const chip = document.createElement("div");

          chip.className = "status-badge success";

          chip.textContent = "Voice streaming ready";

          statusContainer.appendChild(chip);

          const intentChip = document.createElement("div");

          intentChip.className = "status-badge muted";

          intentChip.textContent = "Intent threshold 0.5";

          statusContainer.appendChild(intentChip);

        }

        if (!accessToken && !apiKey && !ownerToken) {

          window.location.href = "login.html";

          return;

        }

        initAuth();

        initThemeToggle();

        initButtons();

        loadBusinesses();

        loadTeam();
        loadActiveBusiness();

        loadInvites();

        loadAuditLog();

        loadCallbacks();

        initMobileNav();

        initCalendarModal();

        initOwnerAssistant();

    loadOwnerOnboardingProfile();

    loadSubscriptionStatus();

    refreshAllData();

    // Feedback modal
    const feedbackBtn = document.createElement("button");
    feedbackBtn.id = "feedback-fab";
    feedbackBtn.type = "button";
    feedbackBtn.textContent = "Send Feedback";
    document.body.appendChild(feedbackBtn);

    const feedbackOverlay = document.getElementById("feedback-overlay");
    const feedbackForm = document.getElementById("feedback-form");
    const feedbackClose = document.getElementById("feedback-close");

    function openFeedback() {
      if (feedbackOverlay) feedbackOverlay.style.display = "flex";
    }
    function closeFeedback() {
      if (feedbackOverlay) feedbackOverlay.style.display = "none";
    }
    feedbackBtn.addEventListener("click", openFeedback);
    feedbackClose?.addEventListener("click", closeFeedback);
    feedbackOverlay?.addEventListener("click", (e) => {
      if (e.target === feedbackOverlay) closeFeedback();
    });

    feedbackForm?.addEventListener("submit", async (evt) => {
      evt.preventDefault();
      const payload = {
        category: document.getElementById("feedback-category")?.value || "bug",
        summary: (document.getElementById("feedback-summary")?.value || "").trim(),
        steps: (document.getElementById("feedback-steps")?.value || "").trim() || null,
        expected: (document.getElementById("feedback-expected")?.value || "").trim() || null,
        actual: (document.getElementById("feedback-actual")?.value || "").trim() || null,
        call_sid: (document.getElementById("feedback-call-sid")?.value || "").trim() || null,
        contact: (document.getElementById("feedback-contact")?.value || "").trim() || null,
        url: window.location.href,
      };
      if (!payload.summary) {
        alert("Please add a short summary.");
        return;
      }
      try {
        const res = await authorizedFetch("/v1/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`Submit failed (${res.status})`);
        closeFeedback();
        alert("Thanks for the feedback!");
      } catch (err) {
        console.error(err);
        alert(err?.message || "Unable to submit feedback right now.");
      }
    });

  });

</script>

</body>

</html>
