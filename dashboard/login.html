<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Login | AI Telephony Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap");
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at 15% 15%, rgba(37, 99, 235, 0.08), transparent 26%),
          radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.08), transparent 24%),
          #f7fafc;
        color: #0f172a;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.25rem;
      }
      .shell {
        width: min(1080px, 100%);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }
      .panel {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
      }
      .panel h1 {
        margin: 0;
        font-size: 1.3rem;
        color: #0f172a;
      }
      .panel p {
        margin: 0.35rem 0 1rem 0;
        color: #475569;
      }
      .help-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 0.6rem; }
      .help-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.7rem 0.85rem;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
      }
      .help-item strong { color: #0f172a; }
      .help-item .muted { font-size: 0.85rem; }
      .help-link {
        color: #2563eb;
        font-weight: 700;
        text-decoration: none;
      }
      .logo-mark {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, #2563eb 0%, #22c55e 100%);
        display: grid;
        place-items: center;
        color: white;
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
      }
      label {
        display: block;
        color: #475569;
        font-weight: 600;
        margin-bottom: 0.35rem;
        font-size: 0.9rem;
      }
      input,
      select {
        width: 100%;
        padding: 0.7rem 0.85rem;
        border-radius: 12px;
        border: 1px solid #cbd5e1;
        background: #ffffff;
        color: #0f172a;
        font-size: 0.95rem;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      }
      :is(a, button, input, select, textarea):focus-visible {
        outline: 2px solid #0ea5e9;
        outline-offset: 2px;
      }
      .button {
        width: 100%;
        padding: 0.8rem;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #2563eb 0%, #22c55e 100%);
        color: white;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }
      .button.secondary {
        background: #ffffff;
        border: 1px solid #cbd5e1;
        color: #0f172a;
      }
      .button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
      }
      .form-group { margin-bottom: 1rem; }
      .status {
        min-height: 20px;
        font-size: 0.9rem;
        color: #475569;
      }
      .status.error { color: #b91c1c; }
      .status.success { color: #166534; }
      .footer {
        margin-top: 0.75rem;
        font-size: 0.9rem;
        color: #475569;
        text-align: center;
      }
      .footer a { color: #2563eb; }
      .inline-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        font-size: 0.9rem;
      }
      .input-wrap {
        position: relative;
      }
      .toggle-visibility {
        position: absolute;
        right: 0.6rem;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: #475569;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .strength {
        height: 8px;
        width: 100%;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }
      .strength span {
        display: block;
        height: 100%;
        width: 0%;
        background: #f59e0b;
        transition: width 0.2s ease, background 0.2s ease;
      }
      .muted { color: #64748b; font-size: 0.85rem; }

      @media (max-width: 480px) {
        body { padding: 1rem; }
        .panel { padding: 1.25rem; }
        .help-item { flex-direction: column; align-items: flex-start; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="panel">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
          <div class="logo-mark">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/>
            </svg>
          </div>
          <div>
            <h1>AI Telephony Dashboard</h1>
            <p>Secure sign-in for owners and staff.</p>
          </div>
        </div>
        <form id="login-form" novalidate>
          <div class="form-group">
            <label for="login-email">Email</label>
            <input id="login-email" name="email" type="email" placeholder="you@example.com" required />
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <div class="input-wrap">
              <input id="login-password" name="password" type="password" placeholder="Enter your password" required />
              <button class="toggle-visibility" type="button" data-target="login-password">Show</button>
            </div>
            <div class="strength" aria-hidden="true"><span id="login-strength"></span></div>
            <div class="muted" id="login-hint"></div>
          </div>
          <div class="form-group">
            <label for="login-business">Business ID (optional)</label>
            <input id="login-business" name="business" type="text" placeholder="e.g. default_business" />
          </div>
          <div class="inline-row">
            <label style="display: flex; align-items: center; gap: 0.4rem; font-weight: 500; color: #475569;">
              <input type="checkbox" id="remember-me" checked /> Remember me
            </label>
            <a class="muted" href="#" id="forgot-password">Forgot password?</a>
          </div>
          <button class="button" type="submit">Login</button>
          <div id="login-status" class="status" role="status" aria-live="polite"></div>
        </form>
        <div class="footer">
          <button id="to-dashboard" class="button secondary" type="button">Back to dashboard</button>
        </div>
      </div>
      <div class="panel">
        <h1 style="margin-bottom: 0.25rem;">Register owner</h1>
        <p style="margin-bottom: 0.75rem;">Create an owner account, then weâ€™ll log you in.</p>
        <form id="register-form" novalidate>
          <div class="form-group">
            <label for="reg-email">Email</label>
            <input id="reg-email" name="email" type="email" placeholder="owner@example.com" required />
          </div>
          <div class="form-group">
            <label for="reg-name">Name (optional)</label>
            <input id="reg-name" name="name" type="text" placeholder="Your name" />
          </div>
          <div class="form-group">
            <label for="reg-password">Password</label>
            <div class="input-wrap">
              <input id="reg-password" name="password" type="password" placeholder="At least 8 characters" required />
              <button class="toggle-visibility" type="button" data-target="reg-password">Show</button>
            </div>
            <div class="strength" aria-hidden="true"><span id="reg-strength"></span></div>
            <div class="muted" id="reg-hint"></div>
          </div>
          <button class="button" type="submit">Register & Login</button>
          <div id="register-status" class="status" role="status" aria-live="polite"></div>
        </form>
        <div class="footer" style="margin-top: 1rem;">
          Staff? Ask your owner/admin for an invite, then log in with your email.
        </div>
      </div>
      <div class="panel">
        <h1 style="margin-bottom: 0.25rem;">Accept invite</h1>
        <p style="margin-bottom: 0.75rem;">Join your team by pasting the invite token.</p>
        <form id="invite-form" novalidate>
          <div class="form-group">
            <label for="invite-token">Invite token</label>
            <input id="invite-token" name="token" type="text" placeholder="paste your invite token" required />
          </div>
          <div class="form-group">
            <label for="invite-name">Name</label>
            <input id="invite-name" name="name" type="text" placeholder="Your name" />
          </div>
          <div class="form-group">
            <label for="invite-password">Password</label>
            <input id="invite-password" name="password" type="password" placeholder="Choose a password" required />
          </div>
          <button class="button" type="submit">Accept invite & Login</button>
          <div id="invite-status" class="status" role="status" aria-live="polite"></div>
        </form>
      </div>
      <div class="panel">
        <h1 style="margin-bottom: 0.25rem;">Need help?</h1>
        <p style="margin-bottom: 0.75rem;">Quick links to unblock sign-in or onboarding.</p>
        <ul class="help-list">
          <li class="help-item">
            <div>
              <strong>Password reset</strong>
              <div class="muted">Send a reset from the owner dashboard.</div>
            </div>
            <a class="help-link" href="../WIKI.md#password-reset" target="_blank" rel="noopener noreferrer">Open</a>
          </li>
          <li class="help-item">
            <div>
              <strong>Invite issues</strong>
              <div class="muted">Validate tokens & expiration.</div>
            </div>
            <a class="help-link" href="../WIKI.md#invites" target="_blank" rel="noopener noreferrer">Check</a>
          </li>
          <li class="help-item">
            <div>
              <strong>Tenant & roles</strong>
              <div class="muted">Confirm business ID and role scopes.</div>
            </div>
            <a class="help-link" href="../README.md#troubleshooting" target="_blank" rel="noopener noreferrer">Read</a>
          </li>
        </ul>
      </div>
    </div>

    <script type="module">
      const DEFAULT_BACKEND_BASE = "http://localhost:8000";
      const backendBase = DEFAULT_BACKEND_BASE;

      function persistSession(data) {
        if (!data) return;
        const user = data.user || {};
        localStorage.setItem("owner_access_token", data.access_token || "");
        localStorage.setItem("owner_refresh_token", data.refresh_token || "");
        if (user.email) localStorage.setItem("owner_user_email", user.email);
        localStorage.setItem("owner_user_roles", JSON.stringify(user.roles || []));
        if (user.id) localStorage.setItem("owner_user_id", user.id);
        if (user.active_business_id) {
          localStorage.setItem("owner_business_id", user.active_business_id);
          localStorage.setItem("owner_active_business_id", user.active_business_id);
        }
      }

      function redirectToDashboard() {
        window.location.href = "index.html";
      }

      async function login(email, password, businessId) {
        const res = await fetch(`${backendBase}/v1/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            password,
            business_id: businessId || undefined,
          }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.detail || `Login failed (${res.status})`);
        }
        persistSession(data);
        return data;
      }

      async function acceptInvite(token, password, name) {
        const res = await fetch(`${backendBase}/v1/auth/invite/accept`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, password, name: name || undefined }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data?.detail || `Invite failed (${res.status})`);
        }
        persistSession(data);
        return data;
      }

      function setStatus(el, message, cls = "") {
        if (!el) return;
        el.textContent = message || "";
        el.className = `status ${cls}`.trim();
      }

      document.getElementById("login-form")?.addEventListener("submit", async (evt) => {
        evt.preventDefault();
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value;
        const businessId = document.getElementById("login-business").value.trim();
        const statusEl = document.getElementById("login-status");
        const remember = document.getElementById("remember-me").checked;
        try {
          setStatus(statusEl, "Signing in...");
          await login(email, password, businessId);
          setStatus(statusEl, "Signed in. Redirecting...", "success");
          if (!remember) {
            sessionStorage.setItem("owner_access_token", localStorage.getItem("owner_access_token"));
            localStorage.clear();
          }
          redirectToDashboard();
        } catch (err) {
          setStatus(statusEl, err?.message || "Unable to login.", "error");
        }
      });

      document.getElementById("register-form")?.addEventListener("submit", async (evt) => {
        evt.preventDefault();
        const email = document.getElementById("reg-email").value.trim();
        const password = document.getElementById("reg-password").value;
        const name = document.getElementById("reg-name").value.trim();
        const statusEl = document.getElementById("register-status");
        try {
          setStatus(statusEl, "Creating account...");
          const res = await fetch(`${backendBase}/v1/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, name: name || undefined, role: "owner" }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data?.detail || `Register failed (${res.status})`);
          }
          setStatus(statusEl, "Account created. Signing in...", "success");
          await login(email, password, data?.active_business_id);
          redirectToDashboard();
        } catch (err) {
          setStatus(statusEl, err?.message || "Unable to register.", "error");
        }
      });

      document.getElementById("invite-form")?.addEventListener("submit", async (evt) => {
        evt.preventDefault();
        const token = document.getElementById("invite-token").value.trim();
        const password = document.getElementById("invite-password").value;
        const name = document.getElementById("invite-name").value.trim();
        const statusEl = document.getElementById("invite-status");
        try {
          setStatus(statusEl, "Accepting invite...");
          await acceptInvite(token, password, name);
          setStatus(statusEl, "Invite accepted. Redirecting...", "success");
          redirectToDashboard();
        } catch (err) {
          setStatus(statusEl, err?.message || "Unable to accept invite.", "error");
        }
      });

      document.getElementById("to-dashboard")?.addEventListener("click", redirectToDashboard);

      if (localStorage.getItem("owner_access_token")) {
        redirectToDashboard();
      }

      const params = new URLSearchParams(window.location.search);
      const inviteToken = params.get("invite");
      if (inviteToken) {
        const tokenInput = document.getElementById("invite-token");
        if (tokenInput) tokenInput.value = inviteToken;
      }

      function computeStrength(pw) {
        let score = 0;
        if (pw.length >= 8) score += 30;
        if (/[A-Z]/.test(pw)) score += 20;
        if (/[0-9]/.test(pw)) score += 20;
        if (/[^A-Za-z0-9]/.test(pw)) score += 20;
        if (pw.length >= 12) score += 10;
        return Math.min(score, 100);
      }
      function updateStrength(inputId, barId, hintId) {
        const val = document.getElementById(inputId)?.value || "";
        const score = computeStrength(val);
        const bar = document.getElementById(barId);
        const hint = document.getElementById(hintId);
        if (bar) {
          bar.style.width = `${score}%`;
          bar.style.background =
            score > 70 ? "#16a34a" : score > 40 ? "#f59e0b" : "#ef4444";
        }
        if (hint) {
          if (!val) hint.textContent = "";
          else if (score > 70) hint.textContent = "Strong password";
          else if (score > 40) hint.textContent = "Okay, add a symbol or more length";
          else hint.textContent = "Weak, use 8+ chars with mix of cases, numbers, symbols";
        }
      }
      document.getElementById("login-password")?.addEventListener("input", () =>
        updateStrength("login-password", "login-strength", "login-hint")
      );
      document.getElementById("reg-password")?.addEventListener("input", () =>
        updateStrength("reg-password", "reg-strength", "reg-hint")
      );
      document.getElementById("forgot-password")?.addEventListener("click", (e) => {
        e.preventDefault();
        alert("Reset link sent (stub).");
      });
      document.querySelectorAll(".toggle-visibility").forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.dataset.target;
          const input = document.getElementById(targetId);
          if (!input) return;
          const isPassword = input.type === "password";
          input.type = isPassword ? "text" : "password";
          btn.textContent = isPassword ? "Hide" : "Show";
        });
      });
    </script>
  </body>
</html>
