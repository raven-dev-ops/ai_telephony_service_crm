<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Telephony Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        min-height: 100vh;
        color: #1a202c;
      }
      
      .header-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 1rem 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }
      
      .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      
      .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .logo {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
      }
      
      .logo svg {
        width: 28px;
        height: 28px;
        fill: white;
      }
      
      h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .status-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-left: auto;
        flex-wrap: wrap;
      }
      
      .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      
      .status-badge.success {
        background: #d4edda;
        color: #155724;
      }
      
      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
      }
      
      .status-badge.muted {
        background: #e2e8f0;
        color: #64748b;
      }
      
      .status-badge.warning {
        background: #fff3cd;
        color: #856404;
      }
      
      button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: none;
        background: #1e3a8a;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
      }
      
      button:hover {
        background: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
      }
      
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      :where(a, button, input, textarea, select, [tabindex]:not([tabindex="-1"])):focus-visible {
        outline: 3px solid #0ea5e9;
        outline-offset: 2px;
      }
      
      button.secondary {
        background: #64748b;
      }
      
      button.secondary:hover {
        background: #475569;
      }
      
      button.danger {
        background: #dc2626;
      }
      
      button.danger:hover {
        background: #b91c1c;
      }
      
      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }
      
      .card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        transition: all 0.3s;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      
      .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      
      .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f7fafc;
      }
      
      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
      }
      
      .card-icon.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }
      
      .card-icon.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      
      .card-icon.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }
      
      .card-icon svg {
        width: 20px;
        height: 20px;
        fill: white;
      }
      
      .card h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        flex: 1;
      }
      
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
      }
      
      .info-item {
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 3px solid #1e3a8a;
      }
      
      .info-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
      }
      
      .info-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
        margin: 1rem 0;
      }
      
      th {
        background: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
      }
      
      td {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f5f9;
      }
      
      tr:hover {
        background: #f8fafc;
      }
      
      .status-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .status-active {
        background: #d1fae5;
        color: #065f46;
      }
      
      .status-suspended {
        background: #fee;
        color: #991b1b;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .table-scroll {
        width: 100%;
        overflow-x: auto;
      }

      .table-scroll table {
        min-width: 640px;
      }

    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: flex-end;
      z-index: 1000;
    }

    .drawer {
      background: #ffffff;
      width: min(420px, 90vw);
      height: 100%;
      padding: 1.25rem;
      box-shadow: -8px 0 30px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
    }

      .spark {
        width: 100px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
        display: inline-block;
        vertical-align: middle;
      }

      .spark .fill {
        height: 100%;
        background: linear-gradient(90deg, #4f46e5, #38bdf8);
      }

      .spark.dual .fill {
        background: linear-gradient(90deg, #0ea5e9, #22c55e);
      }

    .drawer header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .pill {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #f8fafc;
      color: #475569;
    }
      input[type="text"],
      input[type="password"],
      input[type="number"],
      select,
      textarea {
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-family: inherit;
        font-size: 0.875rem;
        transition: all 0.2s;
        width: 100%;
      }
      
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #1e3a8a;
        box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
      }
      
      label {
        display: block;
        margin-bottom: 0.5rem;
      }
      
      label small {
        font-weight: 600;
        color: #475569;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      .action-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #94a3b8;
      }
      
      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 3px solid #e2e8f0;
        border-top-color: #1e3a8a;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 0.5rem;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 64px;
        height: 64px;
        fill: #cbd5e1;
        margin-bottom: 1rem;
      }
      
      .alert {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: flex;
        align-items: start;
        gap: 0.75rem;
      }
      
      .alert-warning {
        background: #fffbeb;
        border-left: 4px solid #f59e0b;
        color: #92400e;
      }
      
      .alert-info {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        color: #1e3a8a;
      }
      
      .alert-success {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
        color: #065f46;
      }
      
      .alert-danger {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
      }
      
      .checklist {
        list-style: none;
        padding: 0;
      }
      
      .checklist li {
        padding: 0.75rem;
        margin: 0.5rem 0;
        background: #f8fafc;
        border-radius: 8px;
        display: flex;
        align-items: start;
        gap: 0.75rem;
      }
      
      .checklist li::before {
        content: "âœ“";
        width: 24px;
        height: 24px;
        background: #10b981;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
      }
      
      body.dark {
        background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        color: #e2e8f0;
      }
      
      body.dark .header-bar {
        background: rgba(15, 23, 42, 0.95);
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark .card {
        background: #1e293b;
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark .card h2 {
        color: #e2e8f0;
      }
      
      body.dark th {
        background: #0f172a;
        color: #cbd5e1;
      }
      
      body.dark td {
        border-bottom-color: #334155;
      }
      
      body.dark tr:hover {
        background: #334155;
      }
      
      body.dark input,
      body.dark select,
      body.dark textarea {
        background: #0f172a;
        border-color: #475569;
        color: #e2e8f0;
      }
      
      body.dark .info-item {
        background: #0f172a;
      }
      
      body.dark .checklist li {
        background: #0f172a;
      }
      
      .tour-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      
      .tour-panel {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      }
      
      body.dark .tour-panel {
        background: #1e293b;
        color: #e2e8f0;
      }
      
      .success { color: #059669; }
      .error { color: #dc2626; }
      .muted { color: #64748b; }
    </style>
  </head>
  <body>
    <!-- Tour Overlay -->
    <div id="admin-tour-overlay" class="tour-overlay" aria-hidden="true">
      <div class="tour-panel" role="dialog" aria-modal="true" aria-labelledby="admin-tour-heading">
        <div id="admin-tour-step1">
          <h2 id="admin-tour-heading" style="margin-bottom: 1rem;">Welcome to Admin Dashboard</h2>
          <p style="margin-bottom: 1rem; color: #64748b;">
            Use this view to manage tenants, monitor usage, and keep Twilio webhooks healthy for the platform.
          </p>
          <p style="margin-bottom: 1rem; color: #64748b;">
            Start with the <strong>Tenants</strong> card to see all configured businesses and quick links to their owner dashboards.
          </p>
          <div style="display: flex; gap: 0.5rem;">
            <button id="admin-tour-next" type="button">Next</button>
            <button id="admin-tour-skip" type="button" class="secondary">Skip Tour</button>
          </div>
        </div>
        <div id="admin-tour-step2" style="display: none;">
          <h2 style="margin-bottom: 1rem;">Monitor & Secure</h2>
          <p style="margin-bottom: 1rem; color: #64748b;">
            Use <strong>Tenant Usage</strong> to see activity per tenant, and <strong>Twilio Health</strong> to monitor webhook status.
          </p>
          <p style="margin-bottom: 1rem; color: #64748b;">
            The <strong>Safety Checklist</strong> helps ensure production readiness with key security settings.
          </p>
          <button id="admin-tour-done" type="button">Got It</button>
        </div>
      </div>
    </div>

    <!-- Header -->
    <div class="header-bar">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div>
            <h1>Admin Dashboard</h1>
            <div style="font-size: 0.75rem; color: #64748b;">Platform Management</div>
          </div>
        </div>
        <div class="status-bar">
          <div id="environment-label-admin" class="status-badge muted">Environment: Loading...</div>
          <div class="action-group" style="margin: 0;">
            <button id="admin-theme-toggle" type="button">ðŸŒ™ Dark</button>
            <button id="test-admin-access" type="button">Test Access</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Usage Detail Drawer -->
    <div id="usage-detail-overlay" class="drawer-overlay" aria-hidden="true">
      <div class="drawer" role="dialog" aria-modal="true" aria-labelledby="usage-detail-title">
        <header>
          <div>
            <h2 id="usage-detail-title">Tenant Detail</h2>
            <div id="usage-detail-subtitle" class="muted" style="font-size:0.9rem;"></div>
          </div>
          <button id="usage-detail-close" type="button" class="secondary">Close</button>
        </header>
        <div id="usage-detail-body"></div>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Admin Key Input -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon warning">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
            </svg>
          </div>
          <h2>Admin Authentication</h2>
        </div>
        <div class="form-group">
          <label>
            <small>Admin API Key (X-Admin-API-Key)</small>
            <input id="admin-key-input" type="password" placeholder="Enter your admin API key" />
          </label>
          <small id="admin-key-status" class="muted"></small>
        </div>
        <div id="demo-banner-admin" class="alert alert-warning" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
          </svg>
          <div>
            <strong>Demo Environment</strong><br />
            Do not use with real customer data. This is a non-production environment.
          </div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Tenants Management -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
              </svg>
            </div>
            <h2>Tenants</h2>
          </div>
          <div class="form-group">
            <input id="tenant-search" type="text" placeholder="Search by ID or name..." />
          </div>
          <div class="form-group" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.5rem;">
            <select id="tenant-status-filter">
              <option value="all">All statuses</option>
              <option value="ACTIVE">Active</option>
              <option value="SUSPENDED">Suspended</option>
            </select>
            <select id="tenant-vertical-filter">
              <option value="all">All verticals</option>
            </select>
          </div>
          <div id="tenants-content">
            <div class="loading">Loading tenants</div>
          </div>
          <button id="refresh-tenants" type="button" style="width: 100%; margin-top: 1rem;">Refresh Tenants</button>
        </div>

        <!-- Beta Health -->
        <div class="card" style="grid-column: span 2;" id="beta-health-card">
          <div class="card-header">
            <div class="card-icon warn">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z"/>
              </svg>
            </div>
            <h2>Beta Health (KPIs)</h2>
          </div>
          <div id="beta-health-content" class="info-grid">
            <div class="info-item">
              <div class="info-label">Call answer rate</div>
              <div class="info-value" id="beta-call-answer">--</div>
              <div class="info-sub" id="beta-call-answer-sub">Waiting for usage data</div>
            </div>
            <div class="info-item">
              <div class="info-label">Booking rate</div>
              <div class="info-value" id="beta-booking-rate">--</div>
              <div class="info-sub" id="beta-booking-sub">Appointments vs conversations</div>
            </div>
            <div class="info-item">
              <div class="info-label">Emergency capture</div>
              <div class="info-value" id="beta-emergency-capture">--</div>
              <div class="info-sub" id="beta-emergency-sub">Emergencies tagged/booked</div>
            </div>
            <div class="info-item">
              <div class="info-label">Pending reschedules</div>
              <div class="info-value" id="beta-reschedules">--</div>
              <div class="info-sub">Across all tenants</div>
            </div>
            <div class="info-item">
              <div class="info-label">SMS opt-out rate</div>
              <div class="info-value" id="beta-optout-rate">--</div>
              <div class="info-sub">Customers opted out / total</div>
            </div>
            <div class="info-item">
              <div class="info-label">Active tenants</div>
              <div class="info-value" id="beta-active-tenants">--</div>
              <div class="info-sub" id="beta-last-activity">Last activity n/a</div>
            </div>
          </div>
        </div>

        <!-- Tenant Usage -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon success">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
              </svg>
            </div>
            <h2>Tenant Usage</h2>
          </div>
          <div class="form-group" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:0.5rem;">
            <input id="usage-search" type="text" placeholder="Search tenant..." />
            <select id="usage-status-filter">
              <option value="all">All statuses</option>
              <option value="ACTIVE">Active</option>
              <option value="SUSPENDED">Suspended</option>
            </select>
            <select id="usage-health-filter">
              <option value="all">All health</option>
              <option value="healthy">Healthy</option>
              <option value="warn">Degraded</option>
              <option value="critical">Critical</option>
            </select>
            <select id="usage-vertical-filter">
              <option value="all">All verticals</option>
            </select>
          </div>
          <div id="usage-content">
            <div class="loading">Loading usage data</div>
          </div>
          <div class="action-group">
            <button id="refresh-usage" type="button">Refresh</button>
            <button id="download-usage-csv" type="button" class="secondary">Download CSV</button>
            <button id="download-usage-json" type="button" class="secondary">Download JSON</button>
          </div>
        </div>

        <!-- Twilio Health -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.5 15.5c-1.2 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/>
              </svg>
            </div>
            <h2>Twilio Health</h2>
          </div>
          <div id="twilio-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-twilio" type="button" style="width: 100%; margin-top: 1rem;">Refresh</button>
        </div>

        <!-- Stripe Health -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 5.58 2 10c0 2.94 1.94 5.51 4.9 7.02-.21.74-.79 2.75-.9 3.18 0 0-.02.17.09.23.11.05.25.02.25.02.33-.05 2.15-1.41 2.49-1.66.68.1 1.38.16 2.08.16 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>
              </svg>
            </div>
            <h2>Stripe Health</h2>
          </div>
          <div id="stripe-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-stripe" type="button" style="width: 100%; margin-top: 1rem;">Refresh</button>
        </div>

        <!-- GCP Storage Health -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon success">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6l9-4 9 4v6c0 5.25-3.5 10-9 11-5.5-1-9-5.75-9-11V6zm9 2L6.74 6.52 5.5 7.09 12 10l6.5-2.91-1.24-.57L12 8zm0 3.5L6 9v3.5c0 3.87 2.69 7.19 6 7.93 3.31-.74 6-4.06 6-7.93V9l-6 2.5z"/>
              </svg>
            </div>
            <h2>GCP Storage Health</h2>
          </div>
          <div id="gcp-storage-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-gcp-storage" type="button" style="width: 100%; margin-top: 1rem;">Refresh</button>
        </div>

        <!-- Governance -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
              </svg>
            </div>
            <h2>Governance</h2>
          </div>
          <div id="governance-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-governance" type="button" style="width: 100%; margin-top: 1rem;">Refresh</button>
        </div>

        <!-- Safety Checklist -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon warning">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm-1.06 13.54L7.4 12l1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/>
              </svg>
            </div>
            <h2>Safety & Production Checklist</h2>
          </div>
          <ul class="checklist">
            <li>
              <div>
                <strong>Admin API Key</strong><br />
                <small>Set <code>ADMIN_API_KEY</code> and protect all <code>/v1/admin/*</code> routes</small>
              </div>
            </li>
            <li>
              <div>
                <strong>Strong Tenancy</strong><br />
                <small>Configure unique per-tenant API keys and set <code>REQUIRE_BUSINESS_API_KEY=true</code></small>
              </div>
            </li>
            <li>
              <div>
                <strong>Twilio Signatures</strong><br />
                <small>Enable <code>VERIFY_TWILIO_SIGNATURES=true</code> and secure <code>TWILIO_AUTH_TOKEN</code></small>
              </div>
            </li>
            <li>
              <div>
                <strong>Database Backend</strong><br />
                <small>Use database-backed repositories for production data persistence</small>
              </div>
            </li>
            <li>
              <div>
                <strong>Session Store</strong><br />
                <small>Use Redis for shared session storage: <code>SESSION_STORE_BACKEND=redis</code></small>
              </div>
            </li>
            <li>
              <div>
                <strong>Environment Separation</strong><br />
                <small>Keep dev/staging/prod separate with distinct credentials</small>
              </div>
            </li>
          </ul>
        </div>

        <!-- Notifications Config -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
              </svg>
            </div>
            <h2>Notifications</h2>
          </div>
          <div class="form-group">
            <label>
              <small>Select Tenant</small>
              <select id="notifications-tenant-select">
                <option value="">Loading...</option>
              </select>
            </label>
          </div>
          <div id="notifications-form">
            <p class="muted"><small>Select a tenant to edit settings</small></p>
          </div>
          <small id="notifications-status"></small>
        </div>

        <!-- Audit Log -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
            </div>
            <h2>Audit Log</h2>
          </div>
          <div class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <div class="form-group">
              <label>
                <small>Tenant ID</small>
                <input id="audit-business-id" type="text" placeholder="optional" />
              </label>
            </div>
            <div class="form-group">
              <label>
                <small>Role</small>
                <select id="audit-role">
                  <option value="">Any</option>
                  <option value="admin">Admin</option>
                  <option value="owner_dashboard">Owner</option>
                  <option value="tenant_api">Tenant API</option>
                  <option value="widget">Widget</option>
                </select>
              </label>
            </div>
            <div class="form-group">
              <label>
                <small>Window</small>
                <select id="audit-since-minutes">
                  <option value="">Any Time</option>
                  <option value="60">Last Hour</option>
                  <option value="240">Last 4 Hours</option>
                  <option value="1440">Last 24 Hours</option>
                </select>
              </label>
            </div>
          </div>
          <div id="audit-content">
            <div class="loading">Loading audit log</div>
          </div>
          <button id="refresh-audit" type="button" style="width: 100%; margin-top: 1rem;">Refresh Audit Log</button>
        </div>

        <!-- Admin Runbook -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon success">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
              </svg>
            </div>
            <h2>Quick Actions</h2>
          </div>
          <div class="action-group">
            <button id="seed-demo-tenants" type="button" style="width: 100%;">Seed Demo Tenants</button>
            <button id="runbook-test-health" type="button" class="secondary" style="width: 100%;">Test Backend Health</button>
            <button id="runbook-test-twilio" type="button" class="secondary" style="width: 100%;">Check Twilio Status</button>
          </div>
          <div style="margin-top: 1rem;">
            <small id="runbook-status" class="muted"></small>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const DEFAULT_BACKEND_BASE = "http://localhost:8000";
      const backendBase = DEFAULT_BACKEND_BASE;
      let adminKey = localStorage.getItem("admin_api_key") || "";
      let adminTheme = localStorage.getItem("admin_theme") || "light";
      let tenantCache = [];
      let usageCache = [];
      let usageSort = { key: "appointments_last_30_days", dir: "desc" };
      
      if (adminTheme === "dark") {
        document.body.classList.add("dark");
      }

      function adminHeaders() {
        const headers = {};
        if (adminKey) headers["X-Admin-API-Key"] = adminKey;
        return headers;
      }

      async function fetchJson(path, options = {}) {
        const init = {
          headers: { ...adminHeaders(), ...(options.headers || {}) },
          method: options.method || "GET",
        };
        if (options.body) {
          init.body = options.body;
        }
        const res = await fetch(backendBase + path, init);
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error("Request failed: " + res.status + (text ? " " + text : ""));
        }
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          return res.json();
        }
        return res.text();
      }

      function escapeHtml(value) {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // Admin key handling
      const adminKeyInput = document.getElementById("admin-key-input");
      const adminKeyStatus = document.getElementById("admin-key-status");
      
      if (adminKeyInput && adminKeyStatus) {
        if (adminKey) {
          adminKeyInput.value = adminKey;
          adminKeyStatus.textContent = "Using saved admin key";
          adminKeyStatus.className = "success";
        }
        
        adminKeyInput.addEventListener("change", (e) => {
          adminKey = e.target.value.trim();
          if (adminKey) {
            localStorage.setItem("admin_api_key", adminKey);
            adminKeyStatus.textContent = "Admin key saved";
            adminKeyStatus.className = "success";
          } else {
            localStorage.removeItem("admin_api_key");
            adminKeyStatus.textContent = "Admin key cleared";
            adminKeyStatus.className = "muted";
          }
        });
      }

      // Theme toggle
      const themeToggle = document.getElementById("admin-theme-toggle");
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const isDark = document.body.classList.toggle("dark");
          adminTheme = isDark ? "dark" : "light";
          localStorage.setItem("admin_theme", adminTheme);
          themeToggle.textContent = isDark ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
        });
        themeToggle.textContent = adminTheme === "dark" ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
      }

      // Test admin access
      const testAdminBtn = document.getElementById("test-admin-access");
      if (testAdminBtn && adminKeyStatus) {
        testAdminBtn.addEventListener("click", async () => {
          try {
            await fetchJson("/v1/admin/businesses");
            adminKeyStatus.textContent = "Admin access OK";
            adminKeyStatus.className = "success";
          } catch (err) {
            adminKeyStatus.textContent = "Admin access failed: " + String(err.message || err);
            adminKeyStatus.className = "error";
          }
        });
      }

      // Load environment
      async function loadAdminEnvironment() {
        const label = document.getElementById("environment-label-admin");
        const demoBanner = document.getElementById("demo-banner-admin");
        if (!label) return;
        
        try {
          const info = await fetchJson("/v1/admin/environment");
          const env = String(info.environment || "dev").toLowerCase();
          
          if (env === "prod" || env === "production") {
            label.className = "status-badge success";
            label.textContent = "Environment: Production";
            if (demoBanner) demoBanner.style.display = "none";
          } else if (env === "staging") {
            label.className = "status-badge warning";
            label.textContent = "Environment: Staging";
            if (demoBanner) demoBanner.style.display = "block";
          } else {
            label.className = "status-badge muted";
            label.textContent = "Environment: Development";
            if (demoBanner) demoBanner.style.display = "block";
          }
        } catch (err) {
          label.textContent = "Environment: Unknown";
          label.className = "status-badge error";
          if (demoBanner) demoBanner.style.display = "block";
        }
      }

      // Placeholder load functions (simplified for demo)
      async function loadTenants() {
        const el = document.getElementById("tenants-content");
        const select = document.getElementById("notifications-tenant-select");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading tenants</div>';
        try {
          const data = await fetchJson("/v1/admin/businesses");
          tenantCache = Array.isArray(data) ? data : [];
          // Populate vertical filter options
          const verticals = Array.from(new Set(tenantCache.map((t) => (t.vertical || "").toLowerCase()).filter(Boolean)));
          const tenantVerticalFilter = document.getElementById("tenant-vertical-filter");
          if (tenantVerticalFilter) {
            tenantVerticalFilter.innerHTML = '<option value="all">All verticals</option>';
            verticals.sort().forEach((v) => {
              tenantVerticalFilter.insertAdjacentHTML("beforeend", `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`);
            });
          }
          renderTenants(tenantCache);
          if (select) {
            select.innerHTML = '<option value="">Select tenant...</option>';
            tenantCache.forEach((t) => {
              select.insertAdjacentHTML(
                "beforeend",
                `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name || t.id)}</option>`
              );
            });
          }
        } catch (err) {
          console.error("loadTenants failed", err);
          el.innerHTML = '<div class="empty-state"><p>Unable to load tenants</p><small>' + escapeHtml(err.message || err) + "</small></div>";
        }
      }

      async function loadUsage() {
        const el = document.getElementById("usage-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading usage data</div>';
        try {
          const data = await fetchJson("/v1/admin/businesses/usage");
          usageCache = Array.isArray(data) ? data : [];
          const verticals = Array.from(new Set(usageCache.map((u) => (u.vertical || "").toLowerCase()).filter(Boolean)));
          const usageVerticalFilter = document.getElementById("usage-vertical-filter");
          if (usageVerticalFilter) {
            usageVerticalFilter.innerHTML = '<option value="all">All verticals</option>';
            verticals.sort().forEach((v) => {
              usageVerticalFilter.insertAdjacentHTML("beforeend", `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`);
            });
          }
          renderUsageTable();
          renderBetaHealth();
        } catch (err) {
          console.error("loadUsage failed", err);
          el.innerHTML = '<div class="empty-state"><p>Unable to load usage data</p><small>' + escapeHtml(err.message || err) + "</small></div>";
          const beta = document.getElementById("beta-health-content");
          if (beta) beta.innerHTML = '<div class="empty-state">Unable to load usage for beta KPIs.</div>';
        }
      }

      function renderBetaHealth() {
        const el = document.getElementById("beta-health-content");
        if (!el) return;
        if (!Array.isArray(usageCache) || !usageCache.length) {
          el.innerHTML = '<div class="empty-state" style="grid-column: span 3;">Load usage to see beta KPIs.</div>';
          return;
        }
        const sum = (items, key) => items.reduce((acc, cur) => acc + (Number(cur?.[key] || 0) || 0), 0);
        const totalVoice = sum(usageCache, "twilio_voice_requests");
        const voiceErr = sum(usageCache, "twilio_voice_errors");
        const totalAppts = sum(usageCache, "total_appointments");
        const totalConv = sum(usageCache, "total_conversations");
        const emergAppts = sum(usageCache, "emergency_appointments");
        const emergConv = sum(usageCache, "emergency_conversations");
        const reschedules = sum(usageCache, "pending_reschedules");
        const totalCustomers = sum(usageCache, "total_customers");
        const optOuts = sum(usageCache, "sms_opt_out_customers");
        const activeTenants = usageCache.length;
        const lastActivity = usageCache
          .map((u) => new Date(u.last_activity_at || 0))
          .filter((d) => d.getTime() > 0)
          .sort((a, b) => b.getTime() - a.getTime())[0];

        const callAnswerRate = totalVoice > 0 ? 1 - voiceErr / totalVoice : null;
        const bookingRate = totalConv > 0 ? totalAppts / totalConv : null;
        const emergencyCapture = emergConv > 0 ? emergAppts / emergConv : null;
        const optOutRate = totalCustomers > 0 ? optOuts / totalCustomers : null;

        const pct = (val) => (val === null ? "n/a" : `${(val * 100).toFixed(1)}%`);
        const asInt = (val) => (val === null || Number.isNaN(val) ? "n/a" : String(val));

        const setVal = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        };

        setVal("beta-call-answer", pct(callAnswerRate));
        setVal("beta-booking-rate", pct(bookingRate));
        setVal("beta-emergency-capture", pct(emergencyCapture));
        setVal("beta-reschedules", asInt(reschedules));
        setVal("beta-optout-rate", pct(optOutRate));
        setVal("beta-active-tenants", String(activeTenants));
        setVal(
          "beta-last-activity",
          lastActivity ? `Last activity: ${lastActivity.toLocaleString()}` : "Last activity n/a"
        );

        const setSub = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };
        setSub(
          "beta-call-answer-sub",
          totalVoice > 0 ? `${voiceErr} errors of ${totalVoice} voice requests` : "No voice traffic yet"
        );
        setSub(
          "beta-booking-sub",
          totalConv > 0 ? `${totalAppts} appts / ${totalConv} conversations` : "No conversations yet"
        );
        setSub(
          "beta-emergency-sub",
          emergConv > 0 ? `${emergAppts} emergencies booked of ${emergConv} emergency conv.` : "No emergency conv."
        );
      }

      async function loadTwilioHealth() {
        const el = document.getElementById("twilio-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading</div>';
        try {
          const data = await fetchJson("/v1/admin/twilio/health");
          const cfg = data.config || {};
          const voice = data.twilio_voice_requests ?? 0;
          const sms = data.twilio_sms_requests ?? 0;
          const voiceErrors = data.twilio_voice_errors ?? 0;
          const smsErrors = data.twilio_sms_errors ?? 0;

          el.innerHTML = `
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Provider</div>
                <div class="info-value">${cfg.provider || "stub"}</div>
                <div class="info-sub">From: ${cfg.from_number_set ? "set" : "not set"}</div>
                <div class="info-sub">Owner: ${cfg.owner_number_set ? "set" : "not set"}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Credentials</div>
                <div class="info-value">${cfg.account_sid_set && cfg.auth_token_set ? "Set" : "Missing"}</div>
                <div class="info-sub">Verify sigs: ${cfg.verify_signatures ? "on" : "off"}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Usage</div>
                <div class="info-value">${formatNumber(voice + sms)}</div>
                <div class="info-sub">${formatNumber(voice)} voice / ${formatNumber(sms)} sms</div>
              </div>
              <div class="info-item">
                <div class="info-label">Errors</div>
                <div class="info-value">${formatNumber(voiceErrors + smsErrors)}</div>
                <div class="info-sub">${formatNumber(voiceErrors)} voice / ${formatNumber(smsErrors)} sms</div>
              </div>
            </div>
            <div style="margin-top: 0.75rem;">
              <div class="info-label">Per-business</div>
              ${
                (data.per_business || [])
                  .map(
                    (b) => `
                <div class="usage-row">
                  <div class="usage-cell strong">${escapeHtml(b.business_id)}</div>
                  <div class="usage-cell">Voice: ${formatNumber(b.voice_requests)} (${formatNumber(b.voice_errors)} errors)</div>
                  <div class="usage-cell">SMS: ${formatNumber(b.sms_requests)} (${formatNumber(b.sms_errors)} errors)</div>
                </div>`
                  )
                  .join("") || '<div class="muted">No per-business stats yet.</div>'
              }
            </div>
          `;
        } catch (err) {
          el.innerHTML = `<div class="error">Failed to load Twilio health: ${escapeHtml(err.message || err)}</div>`;
        }
      }

      async function loadStripeHealth() {
        const el = document.getElementById("stripe-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading</div>';
        try {
          const data = await fetchJson("/v1/admin/stripe/health");
          const cfg = data.config || {};
          const subCounts = data.subscriptions_by_status || {};
          const cfgBadges = [
            { label: "API key", ok: cfg.api_key_set },
            { label: "Publishable key", ok: cfg.publishable_key_set },
            { label: "Webhook secret", ok: cfg.webhook_secret_set },
            { label: "Price basic", ok: cfg.price_basic_set },
            { label: "Price growth", ok: cfg.price_growth_set },
            { label: "Price scale", ok: cfg.price_scale_set },
            { label: "Verify sigs", ok: cfg.verify_signatures },
            { label: cfg.use_stub ? "Stub mode" : "Live mode", ok: true },
          ];
          const badgeHtml = cfgBadges
            .map(
              (b) =>
                `<span class="status-badge ${b.ok ? "success" : "warning"}" style="margin-bottom:0.35rem;">${escapeHtml(
                  b.label
                )}: ${b.ok ? "set" : "missing"}</span>`
            )
            .join(" ");

          const statusRows =
            Object.entries(subCounts).length > 0
              ? Object.entries(subCounts)
                  .map(
                    ([k, v]) =>
                      `<div class="info-row"><div class="info-label">Status: ${escapeHtml(
                        k
                      )}</div><div class="info-value">${formatNumber(v)}</div></div>`
                  )
                  .join("")
              : '<div class="muted">No subscription status data yet.</div>';

          el.innerHTML = `
            <div class="info-grid">
              <div>
                <div class="info-label">Config</div>
                <div style="display:flex; flex-wrap:wrap; gap:0.35rem;">${badgeHtml}</div>
              </div>
              <div>
                <div class="info-label">Activations</div>
                <div class="info-value">${formatNumber(data.subscription_activations || 0)}</div>
                <div class="info-sub">Failures: ${formatNumber(data.subscription_failures || 0)} | Webhook errors: ${formatNumber(
                  data.billing_webhook_failures || 0
                )}</div>
              </div>
              <div>
                <div class="info-label">Stripe IDs</div>
                <div class="info-value">${formatNumber(data.customers_with_stripe_id || 0)}</div>
                <div class="info-sub">Businesses w/ subscription: ${formatNumber(data.businesses_with_subscription || 0)}</div>
              </div>
            </div>
            <div style="margin-top:0.75rem;">
              <div class="info-label">Subscriptions by status</div>
              ${statusRows}
            </div>
          `;
        } catch (err) {
          el.innerHTML = `<div class="error">Failed to load Stripe health: ${escapeHtml(err.message || err)}</div>`;
        }
      }
      async function loadGcpStorageHealth() {
        const el = document.getElementById("gcp-storage-content");
        if (!el) return;
        try {
          const data = await fetchJson("/v1/admin/gcp/storage-health");
          const configured = !!data.configured;
          const bucket = data.bucket_name || "(not set)";
          const project = data.project_id || "(not set)";
          const libraryAvailable = !!data.library_available;
          const canConnect = !!data.can_connect;
          const error = data.error || "";

          const statusLabel = !configured
            ? "Not Configured"
            : !libraryAvailable
              ? "Client Library Missing"
              : canConnect
                ? "Healthy"
                : "Degraded";

          const statusClass = canConnect
            ? "status-badge success"
            : configured
              ? "status-badge warning"
              : "status-badge muted";

          el.innerHTML = `
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Project ID</div>
                <div class="info-value">${project}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Dashboard Bucket</div>
                <div class="info-value">${bucket}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Status</div>
                <div class="${statusClass}">${statusLabel}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Details</div>
                <div class="info-value">${error || "OK"}</div>
              </div>
            </div>
          `;
        } catch (err) {
          console.error("Error loading GCP storage health", err);
          el.innerHTML = '<div class="empty-state"><p>Unable to load GCP storage health.</p></div>';
        }
      }

      async function loadGovernance() {
        const el = document.getElementById("governance-content");
        if (!el) return;
        el.innerHTML = `
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Tenants</div>
              <div class="info-value">0</div>
            </div>
            <div class="info-item">
              <div class="info-label">Multi-Tenant</div>
              <div class="info-value">No</div>
            </div>
          </div>
        `;
      }

      async function loadAudit() {
        const el = document.getElementById("audit-content");
        if (!el) return;
        el.innerHTML = '<div class="empty-state"><p>No audit events</p></div>';
      }

      // Wire buttons
      document.getElementById("refresh-tenants")?.addEventListener("click", loadTenants);
      document.getElementById("refresh-usage")?.addEventListener("click", loadUsage);
      document.getElementById("refresh-twilio")?.addEventListener("click", loadTwilioHealth);
      document.getElementById("refresh-stripe")?.addEventListener("click", loadStripeHealth);
      document.getElementById("refresh-gcp-storage")?.addEventListener("click", loadGcpStorageHealth);
      document.getElementById("refresh-governance")?.addEventListener("click", loadGovernance);
      document.getElementById("refresh-audit")?.addEventListener("click", loadAudit);

      // Tour functionality
      const tourOverlay = document.getElementById("admin-tour-overlay");
      const tourStep1 = document.getElementById("admin-tour-step1");
      const tourStep2 = document.getElementById("admin-tour-step2");
      
      if (tourOverlay && tourStep1 && tourStep2) {
        const dismissed = localStorage.getItem("admin_tour_dismissed");
        
        if (dismissed !== "1") {
          tourOverlay.style.display = "flex";
        }
        
        document.getElementById("admin-tour-next")?.addEventListener("click", () => {
          tourStep1.style.display = "none";
          tourStep2.style.display = "block";
        });
        
        const closeTour = () => {
          localStorage.setItem("admin_tour_dismissed", "1");
          tourOverlay.style.display = "none";
        };
        
        document.getElementById("admin-tour-done")?.addEventListener("click", closeTour);
        document.getElementById("admin-tour-skip")?.addEventListener("click", closeTour);
      }

      // Initial load
      loadAdminEnvironment();
      loadTenants();
      loadUsage();
      loadTwilioHealth();
      loadStripeHealth();
      loadGcpStorageHealth();
      loadGovernance();
      loadAudit();

      // Helpers
      function formatNumber(value) {
        if (value === null || value === undefined || Number.isNaN(Number(value))) return "0";
        return Number(value).toLocaleString();
      }

      function usageHealth(u) {
        const voiceErr = u.twilio_voice_errors || 0;
        const smsErr = u.twilio_sms_errors || 0;
        const voiceReq = u.twilio_voice_requests || 0;
        const smsReq = u.twilio_sms_requests || 0;
        const totalErr = voiceErr + smsErr;
        const totalReq = voiceReq + smsReq;
        const rate = totalReq ? totalErr / totalReq : 0;
        if (totalErr === 0) return { state: "healthy", label: "Healthy", rate };
        if (rate > 0.05) return { state: "critical", label: "Critical", rate };
        return { state: "warn", label: "Degraded", rate };
      }

      function apptSpark(u) {
        const ratio = Math.min(
          100,
          Math.round(
            ((u.appointments_last_7_days || 0) / Math.max(1, u.appointments_last_30_days || 0)) * 100
          )
        );
        return `<div class="spark"><div class="fill" style="width:${ratio}%;"></div></div>`;
      }

      function smsSpark(u) {
        const owner = u.sms_owner_messages || 0;
        const cust = u.sms_customer_messages || 0;
        const total = owner + cust || 1;
        const ownerPct = Math.round((owner / total) * 100);
        return `<div class="spark dual"><div class="fill" style="width:${ownerPct}%;"></div></div>`;
      }

      function formatRelative(isoString) {
        if (!isoString) return "n/a";
        const dt = new Date(isoString);
        if (Number.isNaN(dt.getTime())) return "n/a";
        const diffMs = Date.now() - dt.getTime();
        const mins = Math.floor(diffMs / 60000);
        if (mins < 1) return "just now";
        if (mins < 60) return `${mins}m ago`;
        const hours = Math.floor(mins / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
      }

      let usageDetailReturnFocus = null;

      function renderUsageDetail(tenantId) {
        const overlay = document.getElementById("usage-detail-overlay");
        const title = document.getElementById("usage-detail-title");
        const subtitle = document.getElementById("usage-detail-subtitle");
        const body = document.getElementById("usage-detail-body");
        if (!overlay || !title || !body) return;
        const u = usageCache.find((x) => x.id === tenantId);
        if (!u) return;
        const health = usageHealth(u);
        title.textContent = u.name || u.id;
        subtitle.textContent = `${u.id} â€¢ ${u.status || "ACTIVE"} â€¢ ${u.vertical || "n/a"}`;
        const errRate = (u.twilio_error_rate || 0).toFixed(3);
        body.innerHTML = `
          <div style="display:grid; gap:0.75rem;">
            <div>
              <div class="pill">Health: ${health.label}</div>
              <div class="muted" style="margin-top:0.25rem;">Twilio error rate: ${errRate}</div>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Appointments (30d)</div>
                <div class="info-value">${formatNumber(u.appointments_last_30_days || 0)}</div>
                <div class="info-sub">${formatNumber(u.appointments_last_7_days || 0)} in 7d</div>
                ${apptSpark(u)}
              </div>
              <div class="info-item">
                <div class="info-label">Emergencies (30d)</div>
                <div class="info-value">${formatNumber(u.emergencies_last_30_days || 0)}</div>
                <div class="info-sub">${formatNumber(u.emergencies_last_7_days || 0)} in 7d</div>
              </div>
              <div class="info-item">
                <div class="info-label">SMS</div>
                <div class="info-value">${formatNumber(u.sms_total_messages || 0)}</div>
                <div class="info-sub">${formatNumber(u.sms_owner_messages || 0)} owner / ${formatNumber(u.sms_customer_messages || 0)} customer</div>
                ${smsSpark(u)}
              </div>
              <div class="info-item">
                <div class="info-label">Twilio Requests</div>
                <div class="info-value">${formatNumber((u.twilio_voice_requests || 0) + (u.twilio_sms_requests || 0))}</div>
                <div class="info-sub">${formatNumber(u.twilio_voice_errors || 0)} voice / ${formatNumber(u.twilio_sms_errors || 0)} sms errors</div>
              </div>
            </div>
            <div>
              <div class="info-label">Last activity</div>
              <div class="info-value">${formatRelative(u.last_activity_at)}</div>
              <div class="info-sub">${u.last_activity_at || ""}</div>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Customers</div>
                <div class="info-value">${formatNumber(u.total_customers || 0)}</div>
                <div class="info-sub">${formatNumber(u.sms_opt_out_customers || 0)} SMS opt-out</div>
              </div>
              <div class="info-item">
                <div class="info-label">Conversations</div>
                <div class="info-value">${formatNumber(u.total_conversations || 0)}</div>
                <div class="info-sub">${formatNumber(u.flagged_conversations || 0)} flagged</div>
              </div>
              <div class="info-item">
                <div class="info-label">Pending Reschedules</div>
                <div class="info-value">${formatNumber(u.pending_reschedules || 0)}</div>
              </div>
            </div>
          </div>
        `;
        usageDetailReturnFocus = document.activeElement;
        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");
        document.getElementById("usage-detail-close")?.focus();
      }

      function closeUsageDetail() {
        const overlay = document.getElementById("usage-detail-overlay");
        if (overlay) {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
        }
        const focusTarget =
          usageDetailReturnFocus && usageDetailReturnFocus.focus
            ? usageDetailReturnFocus
            : document.getElementById("test-admin-access");
        focusTarget?.focus();
        usageDetailReturnFocus = null;
      }

      function renderTenants(source) {
        const el = document.getElementById("tenants-content");
        const search = (document.getElementById("tenant-search")?.value || "").toLowerCase().trim();
        const statusFilter = (document.getElementById("tenant-status-filter")?.value || "all").toUpperCase();
        const verticalFilter = (document.getElementById("tenant-vertical-filter")?.value || "all").toLowerCase();
        if (!el) return;
        const filtered = (source || []).filter((t) => {
          const haystack = `${t.id || ""} ${t.name || ""} ${t.owner_email || ""}`.toLowerCase();
          const status = String(t.status || "ACTIVE").toUpperCase();
          const vertical = (t.vertical || "").toLowerCase();
          const matchesSearch = !search || haystack.includes(search);
          const matchesStatus = statusFilter === "ALL" || status === statusFilter;
          const matchesVertical = verticalFilter === "all" || vertical === verticalFilter;
          return matchesSearch && matchesStatus && matchesVertical;
        });
        if (!filtered.length) {
          el.innerHTML = '<div class="empty-state"><p>No tenants match that search</p></div>';
          return;
        }
        const rows = filtered
          .map((t) => {
            const statusClass = String(t.status || "ACTIVE").toUpperCase() === "ACTIVE" ? "status-active" : "status-suspended";
            const statusLabel = escapeHtml((t.status || "ACTIVE").toUpperCase());
            const usage = usageCache.find((u) => u.id === t.id);
            const lastAct = usage ? formatRelative(usage.last_activity_at) : "n/a";
            return `
              <tr>
                <td><strong>${escapeHtml(t.name || t.id)}</strong><br/><small class="muted">${escapeHtml(t.id)}</small></td>
                <td><span class="status-tag ${statusClass}">${statusLabel}</span></td>
                <td>${escapeHtml(t.vertical || "n/a")}</td>
                <td>${escapeHtml(t.owner_email || "â€”")}</td>
                <td>${escapeHtml(t.owner_phone || "â€”")}</td>
                <td>${escapeHtml(lastAct)}</td>
              </tr>
            `;
          })
          .join("");
        el.innerHTML = `
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Tenant</th>
                  <th>Status</th>
                  <th>Vertical</th>
                  <th>Owner Email</th>
                  <th>Owner Phone</th>
                  <th>Last Activity</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }

      function renderUsageTable() {
        const el = document.getElementById("usage-content");
        if (!el) return;
        if (!usageCache.length) {
          el.innerHTML = '<div class="empty-state"><p>No usage data available</p></div>';
          return;
        }
        const search = (document.getElementById("usage-search")?.value || "").toLowerCase().trim();
        const statusFilter = (document.getElementById("usage-status-filter")?.value || "all").toUpperCase();
        const verticalFilter = (document.getElementById("usage-vertical-filter")?.value || "all").toLowerCase();
        const healthFilter = (document.getElementById("usage-health-filter")?.value || "all").toLowerCase();
        const filtered = usageCache.filter((u) => {
          const haystack = `${u.id || ""} ${u.name || ""} ${u.vertical || ""}`.toLowerCase();
          const status = String(u.status || "ACTIVE").toUpperCase();
          const vertical = (u.vertical || "").toLowerCase();
          const health = usageHealth(u).state;
          const matchesSearch = !search || haystack.includes(search);
          const matchesStatus = statusFilter === "ALL" || status === statusFilter;
          const matchesVertical = verticalFilter === "all" || vertical === verticalFilter;
          const matchesHealth = healthFilter === "all" || health === healthFilter;
          return matchesSearch && matchesStatus && matchesVertical && matchesHealth;
        });
        if (!filtered.length) {
          el.innerHTML = '<div class="empty-state"><p>No usage matches those filters</p></div>';
          return;
        }
        const sorted = [...filtered].sort((a, b) => {
          const aVal = a[usageSort.key];
          const bVal = b[usageSort.key];
          const numA = Number(aVal);
          const numB = Number(bVal);
          const bothNum = !Number.isNaN(numA) && !Number.isNaN(numB);
          let cmp = 0;
          if (bothNum) {
            cmp = numA - numB;
          } else {
            cmp = String(aVal || "").localeCompare(String(bVal || ""), undefined, { sensitivity: "base" });
          }
          return usageSort.dir === "asc" ? cmp : -cmp;
        });
        const rows = sorted
          .map((u) => {
            const health = usageHealth(u);
            const statusClass = String(u.status || "ACTIVE").toUpperCase() === "ACTIVE" ? "status-active" : "status-suspended";
            const statusLabel = escapeHtml((u.status || "ACTIVE").toUpperCase());
            const alertFlag = (u.twilio_voice_errors || 0) > 0 || (u.twilio_sms_errors || 0) > 0;
            const muted = (u.appointments_last_30_days || 0) === 0 ? ' style="opacity:0.7;"' : "";
            const appts30 = u.appointments_last_30_days || 0;
            const smsTotal = u.sms_total_messages || (u.sms_owner_messages || 0) + (u.sms_customer_messages || 0);
            const errorBar = alertFlag
              ? `<div style="height:6px; border-radius:4px; background: linear-gradient(90deg, #ef4444 0%, #ef4444 100%); margin-top:4px; opacity:0.9;"></div>`
              : "";
            const growth = appts30 && u.appointments_last_7_days
              ? Math.round((u.appointments_last_7_days / appts30) * 100)
              : 0;
            const growthLabel = growth ? `${growth}% of 30d in past 7d` : "";
            return `
              <tr class="usage-row" data-tenant-id="${escapeHtml(u.id || "")}"${muted}>
                <td>
                  <strong>${escapeHtml(u.name || u.id)}</strong><br/>
                  <small class="muted">${escapeHtml(u.id)}</small>
                </td>
                <td>${escapeHtml(u.vertical || "n/a")}</td>
                <td><span class="status-tag ${statusClass}">${statusLabel}</span></td>
                <td><span class="status-tag ${health.state === "critical" ? "status-suspended" : health.state === "warn" ? "status-pending" : "status-active"}">${health.label}</span><br/><small class="muted">${formatNumber(u.twilio_voice_errors || 0)} voice / ${formatNumber(u.twilio_sms_errors || 0)} sms errors</small></td>
                <td>${formatNumber(appts30)} (30d)<br/><small class="muted">${formatNumber(u.appointments_last_7_days)} in 7d</small>${apptSpark(u)}</td>
                <td>${formatNumber(u.emergencies_last_30_days)}<br/><small class="muted">${formatNumber(u.emergencies_last_7_days)} in 7d</small></td>
                <td>${formatNumber(u.sms_owner_messages)} owner<br/><small class="muted">${formatNumber(u.sms_customer_messages)} customer</small>${smsSpark(u)}</td>
                <td>${formatNumber(u.total_customers)} customers<br/><small class="muted">${formatNumber(u.total_conversations)} convos</small></td>
                <td>${formatNumber(u.pending_reschedules)} reschedules<br/><small class="muted">${formatNumber(u.flagged_conversations)} flagged</small></td>
                <td>${formatRelative(u.last_activity_at)}</td>
              </tr>
            `;
          })
          .join("");

        const top = sorted
          .filter((u) => (u.appointments_last_30_days || 0) > 0)
          .slice(0, 5);

        const summary = top
          .map((u) => {
            const appts30 = u.appointments_last_30_days || 0;
            const emergencies = u.emergencies_last_30_days || 0;
            const pctEmerg = appts30 ? Math.round((emergencies / appts30) * 100) : 0;
            const width = Math.min(100, Math.max(5, appts30));
            return `
              <div style="margin-bottom: 0.6rem;">
                <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
                  <strong>${escapeHtml(u.name || u.id)}</strong>
                  <span>${formatNumber(appts30)} appts</span>
                </div>
                <div style="height:8px; border-radius:6px; background:#e2e8f0; overflow:hidden; margin-top:4px;">
                  <div style="width:${width}%; height:100%; background:linear-gradient(90deg,#4f46e5,#38bdf8);"></div>
                </div>
                <div style="font-size:0.75rem; color:#64748b;">${pctEmerg}% emergency, ${formatNumber(u.sms_total_messages || 0)} SMS</div>
              </div>
            `;
          })
          .join("");

        el.innerHTML = `
          <div style="margin-bottom:1rem;">
            <div style="font-weight:600; margin-bottom:0.35rem;">Top tenants (30d appointments)</div>
            ${summary || '<div class="empty-state" style="padding:0.75rem;">No activity yet</div>'}
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th data-sort="name" class="sortable">Tenant</th>
                  <th data-sort="vertical" class="sortable">Vertical</th>
                  <th data-sort="status" class="sortable">Status</th>
                  <th>Health</th>
                  <th data-sort="appointments_last_30_days" class="sortable">Appointments</th>
                  <th data-sort="emergencies_last_30_days" class="sortable">Emergencies</th>
                  <th data-sort="sms_total_messages" class="sortable">SMS</th>
                  <th data-sort="total_customers" class="sortable">Customers</th>
                  <th data-sort="pending_reschedules" class="sortable">Operational</th>
                  <th>Last Activity</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;

        el.querySelectorAll("th.sortable").forEach((th) => {
          const key = th.getAttribute("data-sort") || "appointments_last_30_days";
          const label = (th.textContent || "").trim();
          th.style.cursor = "pointer";
          th.tabIndex = 0;
          th.setAttribute(
            "aria-sort",
            usageSort.key === key
              ? usageSort.dir === "asc"
                ? "ascending"
                : "descending"
              : "none"
          );
          if (label) {
            th.setAttribute("aria-label", `Sort by ${label}`);
          }
          th.addEventListener("click", () => {
            if (usageSort.key === key) {
              usageSort.dir = usageSort.dir === "asc" ? "desc" : "asc";
            } else {
              usageSort = { key, dir: "desc" };
            }
            renderUsageTable();
          });
          th.addEventListener("keydown", (evt) => {
            if (evt.key === "Enter" || evt.key === " ") {
              evt.preventDefault();
              th.click();
            }
          });
        });
        el.querySelectorAll(".usage-row").forEach((row) => {
          row.style.cursor = "pointer";
          row.tabIndex = 0;
          row.addEventListener("click", () => {
            const id = row.getAttribute("data-tenant-id");
            if (id) renderUsageDetail(id);
          });
          row.addEventListener("keydown", (evt) => {
            if (evt.key === "Enter" || evt.key === " ") {
              evt.preventDefault();
              row.click();
            }
          });
        });
      }

      // Filters and buttons wiring
      document.getElementById("tenant-search")?.addEventListener("input", () => renderTenants(tenantCache));
      document.getElementById("tenant-status-filter")?.addEventListener("change", () => renderTenants(tenantCache));
      document.getElementById("tenant-vertical-filter")?.addEventListener("change", () => renderTenants(tenantCache));
      document.getElementById("usage-search")?.addEventListener("input", renderUsageTable);
      document.getElementById("usage-status-filter")?.addEventListener("change", renderUsageTable);
      document.getElementById("usage-health-filter")?.addEventListener("change", renderUsageTable);
      document.getElementById("usage-vertical-filter")?.addEventListener("change", renderUsageTable);
      document.getElementById("usage-detail-close")?.addEventListener("click", closeUsageDetail);
      document.getElementById("usage-detail-overlay")?.addEventListener("click", (e) => {
        if (e.target && e.target.id === "usage-detail-overlay") {
          closeUsageDetail();
        }
      });
      document.getElementById("usage-detail-overlay")?.addEventListener("keydown", (evt) => {
        const overlay = document.getElementById("usage-detail-overlay");
        if (!overlay || overlay.getAttribute("aria-hidden") !== "false") return;
        if (evt.key === "Escape") {
          evt.preventDefault();
          closeUsageDetail();
          return;
        }
        if (evt.key !== "Tab") return;
        const drawer = overlay.querySelector(".drawer") || overlay;
        const focusable = Array.from(
          drawer.querySelectorAll(
            'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
          )
        ).filter((el) => el.offsetParent !== null);
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (evt.shiftKey && document.activeElement === first) {
          evt.preventDefault();
          last.focus();
        } else if (!evt.shiftKey && document.activeElement === last) {
          evt.preventDefault();
          first.focus();
        }
      });

      document.getElementById("download-usage-csv")?.addEventListener("click", async () => {
        try {
          const res = await fetch(backendBase + "/v1/admin/businesses/usage.csv", {
            headers: adminHeaders(),
          });
          if (!res.ok) throw new Error("Download failed: " + res.status);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tenant_usage.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("Unable to download usage CSV: " + (err.message || err));
        }
      });
      document.getElementById("download-usage-json")?.addEventListener("click", async () => {
        try {
          const res = await fetch(backendBase + "/v1/admin/businesses/usage.json", {
            headers: adminHeaders(),
          });
          if (!res.ok) throw new Error("Download failed: " + res.status);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tenant_usage.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("Unable to download usage JSON: " + (err.message || err));
        }
      });
    </script>
  </body>
</html>
