API Reference
=============

This document summarizes the primary HTTP APIs exposed by the AI Telephony Service & CRM backend.
It is grouped by functional area and focuses on:

- Route paths and HTTP verbs.
- Typical auth headers.
- High-level purpose for each endpoint.

For full request/response models, use the autogenerated docs at `http://localhost:8000/docs`.


Auth & Headers
--------------

- Tenant identification:
  - `X-API-Key`: per-tenant API key (recommended).
  - `X-Business-ID`: optional explicit tenant identifier (trusted only in controlled environments).
  - `X-Widget-Token`: per-tenant widget token for web chat.
- Owner/CRM access:
  - `X-Owner-Token`: owner/dashboard token for `/v1/owner/*` and `/v1/crm/*` via the dashboards.
- Admin access:
  - `X-Admin-API-Key`: admin key for `/v1/admin/*`.

In production, set `REQUIRE_BUSINESS_API_KEY=true` so CRM/owner/widget/telephony routes always run
in a tenant context and anonymous/default-tenant traffic is rejected.


Health & Metrics
----------------

- `GET /healthz`
  - No auth.
  - Basic liveness probe: returns `{"status": "ok"}` when the backend is healthy.

- `GET /metrics`
  - No auth by default (protect with network/firewall or auth in production).
  - Returns JSON counters such as:
    - `total_requests`, `total_errors`, `appointments_scheduled`.
    - `sms_sent_total`, `sms_sent_owner`, `sms_sent_customer`, `lead_followups_sent`.
    - `sms_by_business[business_id].*` for per-tenant SMS and retention metrics.
    - `twilio_voice_requests`, `twilio_sms_requests` and error counts.
    - `twilio_by_business[business_id].*` for per-tenant webhook metrics.
    - `voice_session_requests`, `voice_session_errors`, and `voice_sessions_by_business`.
    - `route_metrics[path].*` with per-route request/error counts and latency.
    - `callbacks_by_business` and `retention_by_business` for callback and retention campaigns.

- `GET /metrics/prometheus`
  - No auth by default.
  - Minimal Prometheus text-format view of key global counters and per-route request/error counts.


Voice Session API (`/v1/voice/*`)
---------------------------------

Headers:

- `X-API-Key` (recommended) or `X-Business-ID` to scope the tenant.

Endpoints:

- `POST /v1/voice/session/start`
  - Body: `{ "caller_phone": "555-0000", "provider_call_id": "...", "lead_source": "..." }`
  - Response: `{ "session_id": "..." }`
  - Starts a logical voice session and creates a `Conversation` row.

- `POST /v1/voice/session/{session_id}/input`
  - Body: `{ "text": "John Smith" }` or `{ "audio": "<base64>" }`.
  - Response: `{ "reply_text": "...", "session_state": {...}, "audio": "<base64 or placeholder>" }`
  - Feeds caller input into the conversation manager; returns the next turn.

- `POST /v1/voice/session/{session_id}/end`
  - Response: `{ "status": "ended:<session_id>" }`
  - Marks the session as ended in the in-memory store.


Telephony API (`/telephony/*`)
------------------------------

Headers:

- `X-API-Key` or `X-Business-ID` to resolve the tenant.

Endpoints:

- `POST /telephony/inbound`
  - Body: `{ "caller_phone": "...", "provider_call_id": "...", "lead_source": "..." }`
  - Response: `{ "session_id", "reply_text", "session_state", "audio" }`
  - Provider-agnostic entrypoint for new calls; triggers the greeting turn.

- `POST /telephony/audio`
  - Body: `{ "session_id": "...", "text": "...", "audio": "<base64>" }`
  - Response: `{ "reply_text", "session_state", "audio" }`
  - Additional turns for an active call. Tracks request/error metrics but does not currently derive
    per-tenant metrics from headers.

- `POST /telephony/end`
  - Body: `{ "session_id": "..." }`
  - Response: `{ "status": "ended:<session_id>" }`
  - Ends a telephony call and clears the in-memory session.


Twilio Webhooks (`/twilio/*`)
-----------------------------

Configured from the Twilio Console. Per-tenant routing can be:

- By query parameter: `?business_id=<tenant_id>`.
- Or by API key: add `X-API-Key` via a proxy in front of Twilio.

Endpoints:

- `POST /twilio/voice`
  - Form-encoded Twilio params (`From`, `To`, `CallSid`, `SpeechResult`, etc.).
  - Response: TwiML `<Response>...</Response>` that:
    - Uses `<Say>` for speech.
    - Uses `<Gather input="speech" action="/twilio/voice">` for subsequent turns.
  - Tracks `twilio_voice_requests` / `twilio_voice_errors` and per-tenant `twilio_by_business`.

- `POST /twilio/owner-voice`
  - Similar to `/twilio/voice` but for owner-facing voice summaries (schedule, todayâ€™s jobs).

- `POST /twilio/sms`
  - Form-encoded Twilio SMS payloads (`From`, `To`, `Body`, etc.).
  - Handles:
    - Customer SMS conversations via the same conversation manager.
    - Opt-out/opt-in keywords for customer SMS.
    - Confirmation, cancellation, and reschedule flows via simple keywords.
  - Response: TwiML `<Message>...</Message>`.
  - Tracks `twilio_sms_requests` / `twilio_sms_errors` and per-tenant metrics.


CRM API (`/v1/crm/*`)
---------------------

Headers:

- `X-API-Key` and `X-Owner-Token` (via dashboard), plus `X-Business-ID` if used.

Key endpoints:

- `POST /v1/crm/customers`
- `GET /v1/crm/customers`
- `GET /v1/crm/customers/{customer_id}`
- `GET /v1/crm/customers/search?q=...`

  - Basic customer CRUD and search by name/phone, scoped by tenant.

- `POST /v1/crm/appointments`
- `GET /v1/crm/appointments`
- `GET /v1/crm/appointments/{appointment_id}`
- `PATCH /v1/crm/appointments/{appointment_id}`
- `GET /v1/crm/customers/{customer_id}/appointments`

  - Appointment CRUD including status, emergency flag, estimated value, tags, and technician fields.

- `GET /v1/crm/customers/{customer_id}/timeline`
  - Interleaved timeline of appointments and conversations.

- `GET /v1/crm/conversations`
- `GET /v1/crm/conversations/{conversation_id}`
- `PATCH /v1/crm/conversations/{conversation_id}/qa`

  - Conversation QA views and updates (flags, tags, outcome, notes).


Owner API (`/v1/owner/*`)
-------------------------

Headers:

- `X-API-Key` and `X-Owner-Token`, plus `X-Business-ID` if used.

Scheduling & summaries:

- `GET /v1/owner/schedule/tomorrow`
- `GET /v1/owner/schedule/tomorrow/audio`
- `GET /v1/owner/summary/today`
- `GET /v1/owner/summary/today/audio`
- `GET /v1/owner/workload/next?days=N`
- `GET /v1/owner/business`

Analytics & exports:

- `GET /v1/owner/service-mix?days=N`
- `GET /v1/owner/pipeline?days=N`
- `GET /v1/owner/customers/analytics?days=N`
- `GET /v1/owner/service-economics?days=N`
- `GET /v1/owner/neighborhoods?days=N`
- `GET /v1/owner/time-to-book?days=N`
 - `GET /v1/owner/conversion-funnel?days=N`
 - `GET /v1/owner/data-completeness?days=N`
- `GET /v1/owner/followups?days=N`
- `GET /v1/owner/retention`
- `GET /v1/owner/export/service-mix.csv?days=N`
- `GET /v1/owner/export/conversations.csv?days=N`

Conversations & QA:

- `GET /v1/owner/conversations/recent`
- `GET /v1/owner/conversations/review`
- `GET /v1/owner/reschedules`
- `GET /v1/owner/callbacks`

Metrics:

- `GET /v1/owner/sms-metrics`
- `GET /v1/owner/twilio-metrics`


Reminders & Retention (`/v1/reminders/*`, `/v1/retention/*`)
------------------------------------------------------------

Headers:

- `X-API-Key` (and optionally `X-Business-ID`) to select the tenant.

Endpoints:

- `POST /v1/reminders/send-upcoming?hours_ahead=24`
  - Scans for upcoming appointments within the configured window (overridable per-tenant via `default_reminder_hours`).
  - Sends SMS reminders to customers who have not opted out.

- `POST /v1/reminders/send-followups`
  - Sends follow-up SMS to recent leads with conversations but no booked appointments.
  - Updates global and per-tenant `lead_followups_sent` metrics.

- `POST /v1/retention/send-retention`
  - Sends simple retention campaigns to past customers whose last visit is at least `min_days_since_last_visit` days ago and who have no future appointment.
  - Updates `metrics.retention_by_business` by campaign type and per-tenant `retention_messages_sent`.


Widget API (`/v1/widget/*`)
---------------------------

Headers:

- `X-Widget-Token` (preferred) or `X-API-Key` for tenant resolution.

Endpoints (high level):

- `POST /v1/widget/session/start`
- `POST /v1/widget/session/{session_id}/input`
- `POST /v1/widget/session/{session_id}/end`

These mirror the voice session API but are tailored for web chat (`channel="web"`) and are used by
`widget/chat.html` and `widget/embed.js`.


Admin API (`/v1/admin/*`)
-------------------------

Headers:

- `X-Admin-API-Key` (required).

Key endpoints:

- `POST /v1/admin/businesses`
- `GET /v1/admin/businesses`
- `PATCH /v1/admin/businesses/{business_id}`
- `POST /v1/admin/businesses/{business_id}/rotate-key`
- `POST /v1/admin/businesses/{business_id}/rotate-widget-token`
- `POST /v1/admin/demo-tenants`

  - Tenant creation, configuration, key rotation, and demo seeding.

- `GET /v1/admin/businesses/usage`
- `GET /v1/admin/businesses/usage.csv`

  - Per-tenant usage, emergencies, SMS volume, and service mix.

- `GET /v1/admin/twilio/health`

  - High-level Twilio/webhook health view, based on `twilio_*` and `twilio_by_business` metrics.
